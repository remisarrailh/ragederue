(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();const N=window.matchMedia("(pointer:coarse)").matches&&!window.matchMedia("(hover:hover)").matches,c=960,f=540,O=330,R=470,pe=96,fe=63,V=220,Ht=100,_e=600,Nt=100,ue=12,ye=1500,me=10,Wt=15,ge=8,xe=12,be=.1,Se=.3,mt=.5,zt=100,ke=.5,we=1,jt=100,ve=.8,Te=1,Vt=500,Ie=80,Ce=90,Ee=60,Pe=280,De=70,Me=35,Oe=220,Re=900,Ae="level_03",Le="0.3.1";function Be(h){h.create({key:"player_idle",frames:h.generateFrameNumbers("player_idle",{start:0,end:3}),frameRate:8,repeat:-1}),h.create({key:"player_walk",frames:h.generateFrameNumbers("player_walk",{start:0,end:9}),frameRate:12,repeat:-1}),h.create({key:"player_punch",frames:h.generateFrameNumbers("player_punch",{start:0,end:2}),frameRate:16,repeat:0}),h.create({key:"player_kick",frames:h.generateFrameNumbers("player_kick",{start:0,end:4}),frameRate:14,repeat:0}),h.create({key:"player_jab",frames:h.generateFrameNumbers("player_jab",{start:0,end:2}),frameRate:18,repeat:0}),h.create({key:"player_jump",frames:h.generateFrameNumbers("player_jump",{start:0,end:3}),frameRate:10,repeat:0}),h.create({key:"player_jump_kick",frames:h.generateFrameNumbers("player_jump_kick",{start:0,end:2}),frameRate:14,repeat:0}),h.create({key:"player_dive_kick",frames:h.generateFrameNumbers("player_dive_kick",{start:0,end:4}),frameRate:16,repeat:0}),h.create({key:"player_hurt",frames:h.generateFrameNumbers("player_hurt",{start:0,end:1}),frameRate:10,repeat:0}),h.create({key:"enemy_idle",frames:h.generateFrameNumbers("enemy_idle",{start:0,end:3}),frameRate:8,repeat:-1}),h.create({key:"enemy_walk",frames:h.generateFrameNumbers("enemy_walk",{start:0,end:3}),frameRate:10,repeat:-1}),h.create({key:"enemy_punch",frames:h.generateFrameNumbers("enemy_punch",{start:0,end:2}),frameRate:14,repeat:0}),h.create({key:"enemy_hurt",frames:h.generateFrameNumbers("enemy_hurt",{start:0,end:3}),frameRate:12,repeat:0}),h.create({key:"enemy_dead",frames:h.generateFrameNumbers("enemy_dead",{start:0,end:0}),frameRate:1,repeat:-1})}const Fe="/ragederue/assets/bar_backgrounds-BUuY7FaX.png",He="/ragederue/assets/house-DaZvIU3g.png",Ne="/ragederue/assets/street2_background-D7uxktga.png",We="/ragederue/assets/street_background-_eV3Q83m.png",ze=Object.assign({"/assets/Stage Layers/backgrounds/bar_backgrounds.png":Fe,"/assets/Stage Layers/backgrounds/house.png":He,"/assets/Stage Layers/backgrounds/street2_background.png":Ne,"/assets/Stage Layers/backgrounds/street_background.png":We}),ie=Object.entries(ze).map(([h,t])=>({key:h.split("/").pop().replace(/\.[^.]+$/,""),url:t})),je=ie.map(h=>h.key),U="assets/Spritesheets/Brawler Girl/",ft="assets/Spritesheets/Enemy Punk/",Ct="assets/Stage Layers/",G="assets/Stage Layers/props/",gt="assets/Sprites/";class Ve extends Phaser.Scene{constructor(){super({key:"PreloadScene"})}preload(){const s=(this.scale.width-400)/2,i=this.scale.height/2,n=this.add.graphics();n.fillStyle(2236962),n.fillRect(s-2,i-2,404,24);const o=this.add.graphics();this.load.on("progress",l=>{o.clear(),o.fillStyle(16737792),o.fillRect(s,i,400*l,20)}),this.add.text(this.scale.width/2,i-30,"Loading...",{fontFamily:"monospace",fontSize:"18px",color:"#ff6600"}).setOrigin(.5),this.load.image("back",Ct+"back.png"),this.load.image("fore",Ct+"fore.png"),this.load.image("tileset",Ct+"tileset.png");for(const{key:l,url:d}of ie)this.load.image(l,d);this.load.image("barrel",G+"barrel.png"),this.load.image("car",G+"car.png"),this.load.image("hydrant",G+"hydrant.png"),this.load.image("banner-hor1",G+"banner-hor/banner-hor1.png"),this.load.image("banner-hor2",G+"banner-hor/banner-hor2.png"),this.load.image("eth-prop-1",G+"Ethereum/ethereum-1.png"),this.load.image("eth-prop-2",G+"Ethereum/ethereum-2.png"),this.load.image("sushi-prop-1",G+"Sushi/sushi-1.png"),this.load.image("sushi-prop-2",G+"Sushi/sushi-2.png");const a=pe,r=fe;this.load.spritesheet("player_idle",U+"idle.png",{frameWidth:a,frameHeight:r}),this.load.spritesheet("player_walk",U+"walk.png",{frameWidth:a,frameHeight:r}),this.load.spritesheet("player_punch",U+"punch.png",{frameWidth:a,frameHeight:r}),this.load.spritesheet("player_kick",U+"kick.png",{frameWidth:a,frameHeight:r}),this.load.spritesheet("player_jab",U+"jab.png",{frameWidth:a,frameHeight:r}),this.load.spritesheet("player_jump",U+"jump.png",{frameWidth:a,frameHeight:r}),this.load.spritesheet("player_jump_kick",U+"jump_kick.png",{frameWidth:a,frameHeight:r}),this.load.spritesheet("player_dive_kick",U+"dive_kick.png",{frameWidth:a,frameHeight:r}),this.load.spritesheet("player_hurt",U+"hurt.png",{frameWidth:a,frameHeight:r}),this.load.image("eth",gt+"eth.png"),this.load.image("sushi",gt+"sushi.png"),this.load.image("pizza",gt+"Cutted_Pizza.png"),this.load.image("ice_cream",gt+"Ice_Cream.png"),this.load.spritesheet("enemy_idle",ft+"idle.png",{frameWidth:a,frameHeight:r}),this.load.spritesheet("enemy_walk",ft+"walk.png",{frameWidth:a,frameHeight:r}),this.load.spritesheet("enemy_punch",ft+"punch.png",{frameWidth:a,frameHeight:r}),this.load.spritesheet("enemy_hurt",ft+"hurt.png",{frameWidth:a,frameHeight:r}),this.load.spritesheet("enemy_dead",ft+"dead.png",{frameWidth:a,frameHeight:r}),this.load.audio("music_street","assets/music/street.mp3"),this.load.audio("music_naval","assets/music/naval.mp3"),this.load.audio("sfx_hit","assets/sounds/hit.wav"),this.load.audio("sfx_death_player","assets/sounds/death_player.wav"),this.load.audio("sfx_death_enemy","assets/sounds/death_ennemy.wav"),this.load.audio("sfx_menu","assets/sounds/menu_sound.wav")}create(){Be(this.anims),this.scene.start("TitleScene")}}class Ue extends Phaser.Scene{constructor(){super({key:"TitleScene"})}create(){if(this.cameras.main.setBackgroundColor("#0a0a14"),this.registry.get("padIndex")===void 0){const s=parseInt(localStorage.getItem("RAGEDERUE_padIndex")??"0",10);this.registry.set("padIndex",s)}this.add.text(c/2,f*.22,"RAGEDERUE ONLINE",{fontFamily:"monospace",fontSize:"52px",color:"#ff6600",stroke:"#000000",strokeThickness:6}).setOrigin(.5),this.sound.stopByKey("music_naval"),this.sound.stopByKey("music_street");const t=parseFloat(localStorage.getItem("RAGEDERUE_music_vol")??"0.5");this.bgMusic=this.sound.add("music_naval",{loop:!0,volume:t}),this.bgMusic.play();const e=parseFloat(localStorage.getItem("RAGEDERUE_sfx_vol")??"0.5");this.registry.set("sfxVol",e),this._started=!1,this._buildUI()}_buildUI(){const t=[{label:"JOUER",color:16737792,cb:()=>this._go()},{label:"RÉGLAGES",color:3359846,cb:()=>this._openSettings()},{label:"ÉDITEUR DE NIVEAUX",color:2245666,cb:()=>this._openEditor()}],e=260,s=52,i=16,n=t.length*s+(t.length-1)*i,o=f*.5-n/2+s/2;if(this._mBtns=[],this._mSel=0,t.forEach((a,r)=>{const l=o+r*(s+i),d=this.add.rectangle(c/2,l,e,s,a.color,.85).setInteractive({useHandCursor:!0}).setStrokeStyle(3,16777215,.5),_=this.add.text(c/2,l,a.label,{fontFamily:"monospace",fontSize:"18px",color:"#ffffff",stroke:"#000",strokeThickness:4}).setOrigin(.5);d.on("pointerdown",()=>{this._mSel=r,this._updateSel(),a.cb()}),d.on("pointerover",()=>{this._mSel=r,this._updateSel()}),this._mBtns.push({bg:d,lbl:_,def:a,y:l})}),this._updateSel(),N){const a=this.add.rectangle(c/2,f*.82,220,40,3364215,.85).setStrokeStyle(2,8956620,.6).setInteractive({useHandCursor:!0});this.add.text(c/2,f*.82,"⛶  PLEIN ÉCRAN",{fontFamily:"monospace",fontSize:"14px",color:"#ffffff",stroke:"#000",strokeThickness:3}).setOrigin(.5),a.on("pointerdown",()=>{this.scale.startFullscreen()})}N||this.add.text(c/2,f*.84,["ENTER ── Jouer     ESC ── Réglages     L ── Éditeur"].join(`
`),{fontFamily:"monospace",fontSize:"11px",color:"#444466",align:"center"}).setOrigin(.5),this.input.keyboard.on("keydown-ENTER",()=>this._confirmSel()),this.input.keyboard.on("keydown-ESC",()=>this._openSettings()),this.input.keyboard.on("keydown-L",()=>this._openEditor()),this.input.keyboard.on("keydown-UP",()=>{this._mSel=Math.max(0,this._mSel-1),this._updateSel()}),this.input.keyboard.on("keydown-DOWN",()=>{this._mSel=Math.min(this._mBtns.length-1,this._mSel+1),this._updateSel()}),this._gpCooldown=0,this.input.gamepad.on("down",(a,r)=>{(r.index===0||r.index===9)&&this._confirmSel(),(r.index===1||r.index===8)&&this._openSettings()})}_updateSel(){this._mBtns.forEach((t,e)=>{const s=e===this._mSel;t.bg.setStrokeStyle(s?4:2,s?16777215:5592439,s?1:.4),t.bg.setAlpha(s?1:.75),t.lbl.setAlpha(s?1:.7)})}_confirmSel(){this._mBtns[this._mSel]?.def.cb()}update(t,e){if(!this._mBtns||(this._gpCooldown-=e,this._gpCooldown>0))return;const s=this.input.gamepad.total>0?this.input.gamepad.getPad(0):null;if(!s)return;const i=.4;s.leftStick.y<-i||s.up?(this._mSel=Math.max(0,this._mSel-1),this._updateSel(),this._gpCooldown=200):(s.leftStick.y>i||s.down)&&(this._mSel=Math.min(this._mBtns.length-1,this._mSel+1),this._updateSel(),this._gpCooldown=200),s.buttons[0]?.pressed&&(this._confirmSel(),this._gpCooldown=300)}_go(){this._started||(this._started=!0,this.bgMusic&&(this.bgMusic.stop(),this.bgMusic.destroy(),this.bgMusic=null),this.scene.start("CharacterScene"))}_openSettings(){if(!this._started){if(this.scene.isActive("PauseScene")){this.scene.stop("PauseScene");return}this.sound.play("sfx_menu",{volume:this.registry.get("sfxVol")??.5}),this.scene.launch("PauseScene",{fromScene:"TitleScene"})}}_openEditor(){this._started||(this._started=!0,this.bgMusic&&(this.bgMusic.stop(),this.bgMusic.destroy(),this.bgMusic=null),this.scene.start("LevelEditorScene"))}}const Ge=1,$e=2,Xe=7,Ye=8,Ke=16,Je=17,Ze=18,qe=19,Qe=20,ts=128,es=129,ss=130,is=131,ns=133,os=134,as=135,rs=136,hs=144,ls=145,cs=146,ds=147,ps=["ethereum","sushi","pizza","ice_cream"],ne=["idle","walk","punch","kick","jab","jump","jump_kick","hurt","dead"],oe={};ne.forEach((h,t)=>{oe[h]=t});const fs=["patrol","chase","attack","hitstun","knockdown","dead"];function Ut(h,t,e=""){const s=new TextEncoder().encode(h),i=new TextEncoder().encode(t),n=new TextEncoder().encode(e),o=new ArrayBuffer(2+s.length+1+i.length+1+n.length),a=new DataView(o),r=new Uint8Array(o);let l=0;return a.setUint8(l++,Ge),a.setUint8(l++,s.length),r.set(s,l),l+=s.length,a.setUint8(l++,i.length),r.set(i,l),l+=i.length,a.setUint8(l++,n.length),r.set(n,l),o}function _s(h,t,e,s,i,n,o){const a=new ArrayBuffer(15),r=new DataView(a);r.setUint8(0,$e),r.setFloat32(1,h,!0),r.setFloat32(5,t,!0),r.setInt16(9,Math.round(e),!0),r.setInt16(11,Math.round(s),!0),r.setUint8(13,oe[i]??0);const l=n>0?0:128;return r.setUint8(14,l|Math.min(o,127)&127),a}function us(h){return{playerId:new DataView(h instanceof ArrayBuffer?h:h.buffer).getUint16(1,!0)}}function ys(h){const t=new DataView(h instanceof ArrayBuffer?h:h.buffer,h.byteOffset??0),e=t.getUint8(1),s=[];let i=2;for(let n=0;n<e;n++){const o=t.getUint16(i,!0);i+=2;const a=t.getFloat32(i,!0);i+=4;const r=t.getFloat32(i,!0);i+=4;const l=t.getInt16(i,!0);i+=2;const d=t.getInt16(i,!0);i+=2;const _=t.getUint8(i);i+=1;const p=t.getUint8(i);i+=1;const y=p&128?-1:1,u=p&127;s.push({id:o,x:a,y:r,velX:l,velY:d,state:ne[_]||"idle",facing:y,hp:u})}return{players:s}}function ms(h){const t=new DataView(h instanceof ArrayBuffer?h:h.buffer,h.byteOffset??0),e=new Uint8Array(h instanceof ArrayBuffer?h:h.buffer),s=t.getUint16(1,!0),i=t.getUint8(3),n=new TextDecoder().decode(e.slice(4,4+i));return{id:s,name:n}}function gs(h){return{id:new DataView(h instanceof ArrayBuffer?h:h.buffer,h.byteOffset??0).getUint16(1,!0)}}function xs(h){return new Uint8Array(h instanceof ArrayBuffer?h:h.buffer,h.byteOffset??0)[0]}function bs(h,t,e){const s=new ArrayBuffer(5),i=new DataView(s);return i.setUint8(0,Ye),i.setUint8(1,h),i.setUint16(2,t,!0),i.setUint8(4,e),s}function Ss(h,t,e,s){const i=new ArrayBuffer(9),n=new DataView(i);return n.setUint8(0,Xe),n.setUint16(1,h,!0),n.setUint8(3,Math.min(t,255)),n.setUint8(4,Math.min(e,255)),n.setFloat32(5,s,!0),i}function ks(h){const t=new DataView(h instanceof ArrayBuffer?h:h.buffer,h.byteOffset??0),e=t.getUint8(1),s=t.getUint16(2,!0),i=t.getUint8(4),n=[];for(let o=0;o<i;o++){const a=t.getUint8(5+o);n.push(ps[a]||"ethereum")}return{targetKind:e,targetId:s,items:n}}function Gt(h){return{remainingTime:new DataView(h instanceof ArrayBuffer?h:h.buffer,h.byteOffset??0).getFloat32(1,!0)}}function ws(h){const t=new DataView(h instanceof ArrayBuffer?h:h.buffer,h.byteOffset??0),e=t.getUint8(1),s=[];let i=2;for(let n=0;n<e;n++){const o=t.getUint16(i,!0);i+=2;const a=t.getFloat32(i,!0);i+=4;const r=t.getFloat32(i,!0);i+=4;const l=t.getUint8(i);i+=1;const d=t.getUint8(i);i+=1;const _=t.getUint8(i)?1:-1;i+=1,s.push({netId:o,x:a,y:r,hp:l,state:fs[d]||"patrol",facing:_})}return{enemies:s}}function vs(){return new Uint8Array([Ke])}function Ts(h,t){const e=new TextEncoder().encode(t),s=new Uint8Array(3+e.length);return s[0]=Je,s[1]=h,s[2]=e.length,s.set(e,3),s}function Is(h){const t=new TextEncoder().encode(h),e=new Uint8Array(2+t.length);return e[0]=Ze,e[1]=t.length,e.set(t,2),e}function Cs(h){const t=new Uint8Array(h instanceof ArrayBuffer?h:h.buffer,h.byteOffset??0),e=t[1],s=[],i=new TextDecoder;let n=2;for(let o=0;o<e;o++){const a=t[n++],r=i.decode(t.slice(n,n+a));n+=a;const l=t[n++],d=i.decode(t.slice(n,n+l));n+=l;const _=t[n++]===1;s.push({id:r,name:d,inGame:_})}return s}function Es(h){const t=new Uint8Array(h instanceof ArrayBuffer?h:h.buffer,h.byteOffset??0),e=t[1];return new TextDecoder().decode(t.slice(2,2+e))}function Ps(h,t){const e=new TextEncoder,s=e.encode(h),i=t.map(r=>e.encode(r)),n=2+s.length+1+i.reduce((r,l)=>r+1+l.length,0),o=new Uint8Array(n);let a=0;o[a++]=qe,o[a++]=s.length,o.set(s,a),a+=s.length,o[a++]=t.length;for(const r of i)o[a++]=r.length,o.set(r,a),a+=r.length;return o}function Ds(h,t){const e=new TextEncoder().encode(h),s=new Uint8Array(2+e.length+2);return s[0]=Qe,s[1]=e.length,s.set(e,2),new DataView(s.buffer).setUint16(2+e.length,t,!1),s}function Ms(h){const t=new DataView(h instanceof ArrayBuffer?h:h.buffer,h.byteOffset??0),e=new Uint8Array(h instanceof ArrayBuffer?h:h.buffer,h.byteOffset??0),s=t.getUint8(1),i={};let n=2;for(let o=0;o<s;o++){const a=t.getUint8(n++),r=new TextDecoder().decode(e.slice(n,n+a));n+=a,i[r]=t.getUint32(n,!1),n+=4}return i}function Os(h){const t=new Uint8Array(h instanceof ArrayBuffer?h:h.buffer,h.byteOffset??0),e=t[1],s=new TextDecoder,i=[];let n=2;for(let o=0;o<e;o++){const a=t[n++];i.push(s.decode(t.slice(n,n+a))),n+=a}return i}class ae{constructor(){this.ws=null,this.connected=!1,this.playerId=-1,this.onWelcome=null,this.onSnapshot=null,this.onPlayerJoin=null,this.onPlayerLeave=null,this.onEnemySnapshot=null,this.onLootData=null,this.onWorldReset=null,this.onTimerSync=null,this.onDisconnect=null,this.onReconnect=null,this.onCharList=null,this.onJoinRefused=null,this.onChestData=null,this.onSkills=null,this._sendInterval=50,this._lastSendTime=0,this._reconnectUrl=null,this._reconnectName=null,this._reconnectRoom=null,this._reconnectCharId="",this._reconnectRaw=!1,this._reconnectTimer=null,this._reconnectAttempt=0,this._reconnectMax=10,this._reconnecting=!1}autoConnect(t="Player"){const e=new URLSearchParams(window.location.search),s=e.get("server")||"localhost",i=e.get("port")||"9000",n=e.get("name")||t,o=e.get("room")||"street_01",l=`${e.get("ssl")==="true"||window.location.protocol==="https:"?"wss":"ws"}://${s}:${i}`;return this.connect(l,n,o),!0}connectRaw(t){this._reconnectUrl=t,this._reconnectRaw=!0,this._reconnecting=!1,this._reconnectAttempt=0,this._openRaw(t)}_openRaw(t){console.log(`[Net] Connecting (raw) to ${t}...`),this.ws=new WebSocket(t),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{console.log("[Net] Connected (raw)"),this.connected=!0,this._reconnectAttempt=0,this._reconnecting=!1,!this._reconnecting&&(this.onConnect&&this.onConnect(),this.onReconnect&&this._reconnectAttempt>0&&this.onReconnect())},this.ws.onmessage=e=>{this._handleMessage(e.data)},this.ws.onclose=()=>{console.log("[Net] Disconnected (raw)"),this.connected=!1,this.onDisconnect&&this.onDisconnect()},this.ws.onerror=e=>{console.warn("[Net] WebSocket error",e)}}connect(t,e,s,i=""){this._reconnectUrl=t,this._reconnectName=e,this._reconnectRoom=s,this._reconnectCharId=i,this._reconnectRaw=!1,this._reconnecting=!1,this._reconnectAttempt=0,this._openConnect(t,e,s,i)}_openConnect(t,e,s,i=""){console.log(`[Net] Connecting to ${t}${this._reconnecting?" (retry)":""}...`),this.ws=new WebSocket(t),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{const n=this._reconnecting;console.log("[Net] Connected"),this.connected=!0,this._reconnectAttempt=0,this._reconnecting=!1,this.ws.send(Ut(e,s,i)),n&&this.onReconnect&&this.onReconnect()},this.ws.onmessage=n=>{this._handleMessage(n.data)},this.ws.onclose=()=>{console.log("[Net] Disconnected"),this.connected=!1,this.onDisconnect&&this.onDisconnect(),this._scheduleReconnect()},this.ws.onerror=n=>{console.warn("[Net] WebSocket error",n)}}_scheduleReconnect(){if(this._reconnectRaw||this._reconnecting)return;if(this._reconnectAttempt>=this._reconnectMax){console.warn("[Net] Max reconnect attempts reached — giving up");return}this._reconnecting=!0,this._reconnectAttempt++;const t=Math.min(1e3*this._reconnectAttempt,8e3);console.log(`[Net] Reconnecting in ${t}ms (attempt ${this._reconnectAttempt}/${this._reconnectMax})...`),this._reconnectTimer=setTimeout(()=>{this._reconnectUrl&&this._openConnect(this._reconnectUrl,this._reconnectName,this._reconnectRoom,this._reconnectCharId??"")},t)}sendState(t,e,s,i,n,o,a){if(!this.connected)return;const r=performance.now();r-this._lastSendTime<this._sendInterval||(this._lastSendTime=r,this.ws.send(_s(t,e,s,i,n,o,a)))}sendHitEnemy(t,e,s,i){this.connected&&this.ws.send(Ss(t,e,s,i))}sendTakeItem(t,e,s){this.connected&&this.ws.send(bs(t,e,s))}joinRoom(t,e,s=""){this._reconnectName=t,this._reconnectRoom=e,this._reconnectCharId=s,this._send(Ut(t,e,s))}sendCharListReq(){this._send(vs())}sendCharSelect(t,e){this._send(Ts(t,e))}sendCharDelete(t){this._send(Is(t))}sendChestSave(t,e){this._send(Ps(t,e))}sendSkillGain(t,e){this._send(Ds(t,e))}disconnect(){this._reconnectTimer&&(clearTimeout(this._reconnectTimer),this._reconnectTimer=null),this._reconnecting=!1,this._reconnectAttempt=0,this.ws&&(this.ws.onclose=null,this.ws.close(),this.ws=null),this.connected=!1}_send(t){this.connected&&this.ws&&this.ws.send(t)}_handleMessage(t){const e=xs(t);switch(e){case ts:{const{playerId:s}=us(t);this.playerId=s,console.log(`[Net] Welcome! id=${s}`),this.onWelcome&&this.onWelcome(s);break}case es:{const{players:s}=ys(t);this.onSnapshot&&this.onSnapshot(s);break}case ss:{const{id:s,name:i}=ms(t);console.log(`[Net] Player joined: ${i} (id=${s})`),this.onPlayerJoin&&this.onPlayerJoin(s,i);break}case is:{const{id:s}=gs(t);console.log(`[Net] Player left: id=${s}`),this.onPlayerLeave&&this.onPlayerLeave(s);break}case ns:{const{enemies:s}=ws(t);this.onEnemySnapshot&&this.onEnemySnapshot(s);break}case os:{const{targetKind:s,targetId:i,items:n}=ks(t);this.onLootData&&this.onLootData(s,i,n);break}case as:{const{remainingTime:s}=Gt(t);console.log(`[Net] World reset! Timer: ${s}s`),this.onWorldReset&&this.onWorldReset(s);break}case rs:{const{remainingTime:s}=Gt(t);this.onTimerSync&&this.onTimerSync(s);break}case hs:{const s=Cs(t);this.onCharList&&this.onCharList(s);break}case ls:{const s=Es(t);console.warn(`[Net] Join refused: ${s}`),this.onJoinRefused&&this.onJoinRefused(s);break}case cs:{const s=Os(t);this.onChestData&&this.onChestData(s);break}case ds:{const s=Ms(t);this.onSkills&&this.onSkills(s);break}default:console.warn(`[Net] Unknown message type: 0x${e.toString(16)}`)}}}const tt=420,Z=300,it=(c-tt)/2,q=(f-Z)/2-40,at=30,_t=q+72,rt=7;class Rs extends Phaser.Scene{constructor(){super({key:"CharacterScene"})}create(){this.cameras.main.setBackgroundColor("#0a0a14"),this._chars=[],this._selIdx=0,this._scroll=0,this._mode="connecting",this._inputBuf="",this._errorTimer=0,this._rowObjs=[],this._pendingChar=null,this.add.rectangle(c/2,q+Z/2,tt+8,Z+8,1118498,.97).setStrokeStyle(2,5592490,.8),this.add.text(c/2,q+18,"SÉLECTION PERSONNAGE",{fontFamily:"monospace",fontSize:"18px",color:"#ff6600",stroke:"#000",strokeThickness:4}).setOrigin(.5),this._statusText=this.add.text(c/2,q+44,"Connexion au serveur…",{fontFamily:"monospace",fontSize:"11px",color:"#777799"}).setOrigin(.5),this._createLabel=this.add.text(it+14,q+Z-22,"Nom : ",{fontFamily:"monospace",fontSize:"13px",color:"#ffcc00"}).setOrigin(0,.5).setVisible(!1),this._createInput=this.add.text(it+80,q+Z-22,"",{fontFamily:"monospace",fontSize:"13px",color:"#ffffff"}).setOrigin(0,.5).setVisible(!1),this._createCursor=this.add.text(it+80,q+Z-22,"|",{fontFamily:"monospace",fontSize:"13px",color:"#ffcc00"}).setOrigin(0,.5).setVisible(!1),this.tweens.add({targets:this._createCursor,alpha:0,duration:400,yoyo:!0,repeat:-1}),this._cursor=this.add.rectangle(c/2,0,tt-20,at-3).setStrokeStyle(2,16777215,.85).setFillStyle(16777215,.05).setVisible(!1),this.tweens.add({targets:this._cursor,alpha:.5,duration:400,yoyo:!0,repeat:-1});const t=q+Z+28,e=90,s=38,i=10,n=4*e+3*i,o=(c-n)/2+e/2;this._btnPlay=this._makeBtn(o,t,e,s,"JOUER",2254370,()=>this._action("confirm")),this._btnNew=this._makeBtn(o+e+i,t,e,s,"NOUVEAU",2245768,()=>this._enterCreate()),this._btnDel=this._makeBtn(o+2*(e+i),t,e,s,"SUPPR.",8921634,()=>this._action("delete")),this._btnBack=this._makeBtn(o+3*(e+i),t,e,s,"RETOUR",4473924,()=>this._back());const a=c/2;this._btnConfirm=this._makeBtn(a-75,t,130,s,"CONFIRMER",2254370,()=>this._confirmCreate()),this._btnCancel=this._makeBtn(a+75,t,110,s,"ANNULER",4473924,()=>this._exitCreate()),this._btnConfirm.setVisible(!1),this._btnCancel.setVisible(!1),this.input.keyboard.on("keydown",u=>this._onKey(u)),this._gpCooldown=0,this.input.gamepad.on("down",(u,m)=>{m.index===0&&this._action("confirm"),m.index===1&&this._action("back"),m.index===3&&this._action("delete")}),this._swipeStartY=null;const r=this.add.zone(c/2,q+Z/2,tt,Z).setInteractive();r.on("pointerdown",u=>{this._swipeStartY=u.y}),r.on("pointerup",u=>{if(this._swipeStartY===null)return;const m=u.y-this._swipeStartY;Math.abs(m)>20&&this._moveSel(m<0?-1:1),this._swipeStartY=null}),this._net=new ae,this._net.onCharList=u=>this._onCharList(u),this._net.onJoinRefused=u=>this._onRefused(u),this._net.onChestData=u=>{this.registry.set("chestItems",u),this._mode==="waiting"&&this._pendingChar&&this._enterGame(this._pendingChar)},this._net.onConnect=()=>{this._net.sendCharListReq()},this._net.onDisconnect=()=>this._showStatus("Serveur non disponible","#ff4444");const l=new URLSearchParams(window.location.search),d=l.get("server")||"localhost",_=l.get("port")||"9000",y=l.get("ssl")==="true"||window.location.protocol==="https:"?"wss":"ws";this._net.connectRaw(`${y}://${d}:${_}`)}update(t,e){if(this._gpCooldown-=e,this._errorTimer>0&&(this._errorTimer-=e,this._errorTimer<=0&&this._clearStatus()),this.input.gamepad.total>0&&this._gpCooldown<=0){const s=this.input.gamepad.getPad(0);s&&((s.up||s.leftStick.y<-.4)&&(this._moveSel(-1),this._gpCooldown=160),(s.down||s.leftStick.y>.4)&&(this._moveSel(1),this._gpCooldown=160))}this._mode==="list"?this._statusText.setText("ENTER: jouer   N: nouveau   DEL: supprimer   ESC: retour").setColor("#444466"):this._mode==="create"&&this._statusText.setText("ENTER: confirmer   ESC: annuler").setColor("#444466")}_makeBtn(t,e,s,i,n,o,a){const r=this.add.rectangle(t,e,s,i,o,.85).setInteractive({useHandCursor:!0}).setStrokeStyle(2,16777215,.3);return this.add.text(t,e,n,{fontFamily:"monospace",fontSize:"12px",color:"#ffffff",stroke:"#000",strokeThickness:3}).setOrigin(.5),r.on("pointerdown",()=>{r.setFillStyle(o,1),a()}),r.on("pointerup",()=>r.setFillStyle(o,.85)),r.on("pointerout",()=>r.setFillStyle(o,.85)),r}_onKey(t){if(this._mode==="list"){if(t.key==="ArrowUp"){this._moveSel(-1);return}if(t.key==="ArrowDown"){this._moveSel(1);return}if(t.key==="Enter"){this._action("confirm");return}if(t.key==="n"||t.key==="N"){this._enterCreate();return}if(t.key==="Delete"||t.key==="Backspace"){this._action("delete");return}if(t.key==="Escape"){this._back();return}}if(this._mode==="create"){if(t.key==="Escape"){this._exitCreate();return}if(t.key==="Enter"){this._confirmCreate();return}if(t.key==="Backspace"){this._inputBuf=this._inputBuf.slice(0,-1),this._refreshCreateInput();return}t.key.length===1&&this._inputBuf.length<20&&(this._inputBuf+=t.key,this._refreshCreateInput())}}_action(t){t==="confirm"&&this._mode==="list"&&this._selectChar(),t==="back"&&this._back(),t==="delete"&&this._mode==="list"&&this._deleteChar()}_moveSel(t){this._mode!=="list"||this._chars.length===0||(this._selIdx=Phaser.Math.Clamp(this._selIdx+t,0,this._chars.length-1),this._updateScroll(),this._redraw())}_updateScroll(){this._selIdx<this._scroll&&(this._scroll=this._selIdx),this._selIdx>=this._scroll+rt&&(this._scroll=this._selIdx-rt+1),this._scroll=Phaser.Math.Clamp(this._scroll,0,Math.max(0,this._chars.length-rt))}_selectChar(){if(this._chars.length===0)return;const t=this._chars[this._selIdx];if(t){if(t.inGame){this._showStatus("Personnage déjà en jeu","#ff6644");return}this._mode="waiting",this._pendingChar=t,this._showStatus("Connexion…","#aaaacc"),this._net.sendCharSelect(0,t.id)}}_deleteChar(){if(this._chars.length===0)return;const t=this._chars[this._selIdx];t&&this._net.sendCharDelete(t.id)}_enterCreate(){this._mode="create",this._inputBuf="",this._refreshCreateInput(),this._createLabel.setVisible(!0),this._createInput.setVisible(!0),this._createCursor.setVisible(!0),this._cursor.setVisible(!1),this._btnPlay.setVisible(!1),this._btnNew.setVisible(!1),this._btnDel.setVisible(!1),this._btnBack.setVisible(!1),this._btnConfirm.setVisible(!0),this._btnCancel.setVisible(!0),this._fakeInput=document.createElement("input"),this._fakeInput.style.cssText="position:fixed;opacity:0;top:0;left:0;width:1px;height:1px;",document.body.appendChild(this._fakeInput),this._fakeInput.focus(),this._fakeInput.addEventListener("input",()=>{this._inputBuf=this._fakeInput.value.slice(0,20),this._refreshCreateInput()}),this._redraw()}_exitCreate(){this._mode="list",this._createLabel.setVisible(!1),this._createInput.setVisible(!1),this._createCursor.setVisible(!1),this._btnPlay.setVisible(!0),this._btnNew.setVisible(!0),this._btnDel.setVisible(!0),this._btnBack.setVisible(!0),this._btnConfirm.setVisible(!1),this._btnCancel.setVisible(!1),this._fakeInput&&(this._fakeInput.remove(),this._fakeInput=null),this._redraw()}_confirmCreate(){const t=this._inputBuf.trim();if(t.length<2){this._showStatus("Nom trop court (min 2 caractères)","#ff6644");return}this._net.sendCharSelect(1,t),this._exitCreate()}_refreshCreateInput(){this._createInput.setText(this._inputBuf),this._createCursor.setX(this._createInput.x+this._createInput.width+2)}_back(){this._net.disconnect(),this.scene.start("TitleScene")}_onCharList(t){this._chars=t,this._mode!=="waiting"&&(this._selIdx=Phaser.Math.Clamp(this._selIdx,0,Math.max(0,t.length-1)),this._updateScroll(),this._mode="list",this._clearStatus(),this._redraw())}_onRefused(t){this._mode="list",this._showStatus(t,"#ff4444"),this._redraw()}_enterGame(t){this.registry.set("charId",t.id),this.registry.set("charName",t.name),this._net.disconnect(),this.scene.start("GameScene",{levelId:Ae})}_showStatus(t,e="#777799"){this._statusText.setText(t).setColor(e),this._errorTimer=3e3}_clearStatus(){this._statusText.setText("").setColor("#777799")}_redraw(){for(const e of this._rowObjs)e.destroy();if(this._rowObjs=[],this._chars.length===0&&this._mode!=="create"){const e=this.add.text(c/2,_t+at,"Aucun personnage — appuyez NOUVEAU pour créer",{fontFamily:"monospace",fontSize:"11px",color:"#444466"}).setOrigin(.5);this._rowObjs.push(e),this._cursor.setVisible(!1);return}if(this._chars.slice(this._scroll,this._scroll+rt).forEach((e,s)=>{const i=_t+s*at,n=s+this._scroll,o=n===this._selIdx&&this._mode==="list",a=e.inGame?2232593:o?2241365:1710634,r=e.inGame?.7:o?.9:.5,l=this.add.rectangle(c/2,i,tt-20,at-3,a,r).setStrokeStyle(1,e.inGame?6697779:3359846,.4).setInteractive({useHandCursor:!0}),d=e.inGame?"#886666":o?"#ffffff":"#aaaacc",_=this.add.text(it+20,i,e.name,{fontFamily:"monospace",fontSize:"13px",color:d}).setOrigin(0,.5);if(e.inGame){const p=this.add.text(it+tt-30,i,"EN JEU",{fontFamily:"monospace",fontSize:"10px",color:"#ff4444",stroke:"#000",strokeThickness:2}).setOrigin(1,.5);this._rowObjs.push(p)}l.on("pointerdown",()=>{this._selIdx===n&&this._mode==="list"?this._selectChar():(this._selIdx=n,this._updateScroll(),this._redraw())}),this._rowObjs.push(l,_)}),this._scroll>0){const e=this.add.text(it+tt-10,_t,"▲",{fontFamily:"monospace",fontSize:"10px",color:"#556688"}).setOrigin(1,.5);this._rowObjs.push(e)}if(this._scroll+rt<this._chars.length){const e=this.add.text(it+tt-10,_t+(rt-1)*at,"▼",{fontFamily:"monospace",fontSize:"10px",color:"#556688"}).setOrigin(1,.5);this._rowObjs.push(e)}if(this._mode==="list"&&this._chars.length>0){const e=this._selIdx-this._scroll;this._cursor.setY(_t+e*at).setVisible(!0)}else this._cursor.setVisible(!1)}}const As={id:"level_01",name:"Street Shops",worldW:10170,parallax:{bg:.065,mid:.5},background:"street_background",laneTop:100,props:[{type:"car",x:632,y:422,scale:1.1944444444444444},{type:"car",x:2200,y:345,scale:1.1944444444444444},{type:"barrel",x:800,y:420,scale:1},{type:"barrel",x:1800,y:410,scale:.9},{type:"hydrant",x:1100,y:335,scale:.65},{type:"hydrant",x:2600,y:340,scale:.65},{type:"car",x:305,y:340,scale:1.1944444444444444,blocksPlayer:!0,blocksEnemy:!0},{type:"car",x:493,y:358,scale:1.1944444444444444},{type:"banner-hor1",x:394,y:208,scale:1.7808219178082192},{type:"fore",x:229,y:230,scale:1.2}],containers:[{x:371,y:410,texture:"barrel"},{x:780,y:450,texture:"barrel"},{x:1200,y:390,texture:"barrel"},{x:1700,y:455,texture:"barrel"},{x:2350,y:395,texture:"barrel"},{x:3100,y:445,texture:"barrel"}],transitZones:[{id:"zone_1771807424563",type:"warp",x:3974,y:88,width:118,height:202,targetLevel:"level_03",label:"Planque"},{id:"zone_1771847060713",type:"warp",x:4343,y:124,width:162,height:167,targetLevel:null,label:"WARP"},{id:"zone_1771855378689",type:"warp",x:916,y:124,width:159,height:168,targetLevel:null,label:"WARP"},{id:"zone_1771855511217",type:"warp",x:6867,y:125,width:160,height:165,targetLevel:null,label:"WARP"},{id:"zone_1771855527362",type:"warp",x:8520,y:95,width:116,height:194,targetLevel:null,label:"WARP"},{id:"zone_1771855537129",type:"warp",x:8892,y:121,width:159,height:169,targetLevel:null,label:"WARP"},{id:"zone_1771855550857",type:"warp",x:9102,y:110,width:116,height:179,targetLevel:null,label:"WARP"}]},Ls={id:"level_02",name:"Bar",worldW:3005,parallax:{bg:.06,mid:.25},background:"bar_backgrounds",props:[{type:"car",x:282,y:362,scale:.65},{type:"fore",x:2295,y:462,scale:.9895833333333334}],containers:[],transitZones:[{id:"zone_extract",type:"extract",x:3640,y:300,width:120,height:200,targetLevel:null,label:"EXTRACT"}]},Bs={id:"level_03",name:"Planque",isPlanque:!0,worldW:2160,parallax:{bg:.06,mid:.25},background:"house",props:[],containers:[{x:400,y:410,texture:"barrel",isHideoutChest:!0}],transitZones:[{id:"zone_extract",type:"extract",x:2805,y:300,width:120,height:200,targetLevel:null,label:"EXTRACT"},{id:"zone_1771948237482",type:"warp",x:1858,y:279,width:120,height:200,targetLevel:"level_01",label:"WARP"}]},pt=[As,Ls,Bs];Object.fromEntries(pt.map(h=>[h.id,h]));const $=120,W=160,M=36,z=36,Fs=400,$t=[{id:"select",label:"↖ SELECT",color:"#ffffff"},{id:"sep_props",label:"─ PROPS ─",color:"#555555",sep:!0},{id:"prop:car",label:"  car",color:"#cccccc",scale:.65},{id:"prop:barrel",label:"  barrel",color:"#cccccc",scale:.9},{id:"prop:hydrant",label:"  hydrant",color:"#cccccc",scale:.65},{id:"prop:banner-hor1",label:"  banner1",color:"#cccccc",scale:.6},{id:"prop:banner-hor2",label:"  banner2",color:"#cccccc",scale:.6},{id:"prop:fore",label:"  fore",color:"#ffaa44",scale:1.2},{id:"sep_loot",label:"─ LOOT ─",color:"#555555",sep:!0},{id:"container",label:"  container",color:"#88ff88"},{id:"sep_zones",label:"─ ZONES ─",color:"#555555",sep:!0},{id:"transit",label:"  transit",color:"#00ccff"}],Hs=5,xt="http://localhost:9001";class Ns extends Phaser.Scene{constructor(){super({key:"LevelEditorScene"})}create(){const t=this.registry.get("editorLevels");let e=null;try{const s=localStorage.getItem("RAGEDERUE_editor_levels");s&&(e=JSON.parse(s))}catch{}this._levels=JSON.parse(JSON.stringify(t||e||pt)),this._currentIdx=0,this._camScrollX=0,this._activeTool="select",this._selected=null,this._worldObjects=[],this._bgGraphics=[],this._capturingInput=!1,this._inputBuffer="",this._inputTarget=null,this._exportOverlay=null,this._lootOverlay=null,this._lootContentObjs=[],this._lootData=null,this._lootTab="tables",this._selRect=null,this._availableBackgrounds=[null,...je],this._dragActive=!1,this._dragOrigin=null,this._resizeMode=null,this._zoom=1,this._worldLayer=this.add.layer(),this._uiLayer=this.add.layer(),this.cameras.main.setBackgroundColor("#0a0a14"),this.cameras.main.setScroll(0,0),this._buildUI(),this._loadLevel(),this._uiCam=this.cameras.add(0,0,c,f,!1,"ui"),this._uiCam.setZoom(1).setScroll(0,0),this.cameras.main.ignore(this._uiLayer),this._uiCam.ignore(this._worldLayer),this._fetchLevelsFromServer(),this._fetchLootData(),this._keys=this.input.keyboard.addKeys({left:Phaser.Input.Keyboard.KeyCodes.LEFT,right:Phaser.Input.Keyboard.KeyCodes.RIGHT,a:Phaser.Input.Keyboard.KeyCodes.A,d:Phaser.Input.Keyboard.KeyCodes.D,q:Phaser.Input.Keyboard.KeyCodes.Q}),this.input.keyboard.on("keydown",s=>this._onKeyDown(s)),this.input.on("pointerdown",s=>this._onPointerDown(s)),this.input.on("pointermove",s=>this._onPointerMove(s)),this.input.on("pointerup",()=>{this._dragActive=!1,this._dragOrigin=null,this._resizeMode=null}),this.input.on("wheel",(s,i,n,o)=>this._onWheel(s,o))}update(t,e){if(this._capturingInput)return;const s=e/1e3,i=this._levels[this._currentIdx]?.worldW??3840,n=Math.max(0,i-c/this._zoom),o=Fs/this._zoom;(this._keys.left.isDown||this._keys.a.isDown||this._keys.q.isDown)&&(this._camScrollX=Math.max(0,this._camScrollX-o*s),this.cameras.main.setScroll(this._camScrollX,this._camScrollY())),(this._keys.right.isDown||this._keys.d.isDown)&&(this._camScrollX=Math.min(n,this._camScrollX+o*s),this.cameras.main.setScroll(this._camScrollX,this._camScrollY()))}_buildUI(){const t=e=>(this._uiLayer.add(e),e);t(this.add.rectangle($/2,f/2,$,f,855322).setDepth(600)),t(this.add.rectangle(c/2,M/2,c,M,1118498).setDepth(600)),t(this.add.rectangle(c/2,f-z/2,c,z,1118498).setDepth(600)),t(this.add.rectangle(c-W/2,f/2,W,f,526356).setDepth(600)),t(this.add.rectangle($,f/2,1,f,3359829).setDepth(601)),t(this.add.rectangle(c-W,f/2,1,f,3359829).setDepth(601)),t(this.add.rectangle(c/2,M,c,1,3359829).setDepth(601)),t(this.add.rectangle(c/2,f-z,c,1,3359829).setDepth(601)),this._buildToolbar(),this._buildPalette(),this._buildPropsPanel(),this._buildListPanel(),t(this.add.text($+4,f-z-14,"A/D : scroll   molette / +- : zoom   0 : reset zoom   DEL : supprimer",{fontFamily:"monospace",fontSize:"9px",color:"#333355"}).setDepth(601))}_buildToolbar(){const t=M/2;this._uiBtn(10,t,"[ MENU ]","#888888",()=>this.scene.start("TitleScene"),0,.5),this._uiBtn(150,t,"◄","#ff6600",()=>this._prevLevel(),.5,.5),this._levelNameText=this.add.text(310,t,"",{fontFamily:"monospace",fontSize:"12px",color:"#ffffff"}).setOrigin(.5).setDepth(700).setInteractive({useHandCursor:!0}),this._uiLayer.add(this._levelNameText),this._levelNameText.on("pointerdown",()=>{this._capturingInput||this._startRename()}),this._levelNameText.on("pointerover",()=>{this._capturingInput||this._levelNameText.setColor("#ffcc00")}),this._levelNameText.on("pointerout",()=>{this._capturingInput||this._levelNameText.setColor("#ffffff")}),this._uiBtn(470,t,"►","#ff6600",()=>this._nextLevel(),.5,.5),this._uiBtn(510,t,"[ +NEW ]","#ffcc00",()=>this._newLevel(),0,.5),this._uiBtn(580,t,"[ SAVE ]","#ffcc00",()=>this._saveToServer(),0,.5),this._uiBtn(648,t,"[ TEST ]","#00ff88",()=>this._testLevel(),0,.5),this._uiBtn(716,t,"[ EXPORT ]","#4488ff",()=>this._showExport(),0,.5),this._zoomLabel=this.add.text(c-W-8,t,"100%",{fontFamily:"monospace",fontSize:"10px",color:"#556677"}).setOrigin(1,.5).setDepth(700),this._uiLayer.add(this._zoomLabel),this._updateToolbarName()}_buildPalette(){this._paletteButtons=[];let t=M+10;for(const i of $t){if(i.sep){const o=this.add.text(4,t,i.label,{fontFamily:"monospace",fontSize:"10px",color:i.color}).setDepth(700);this._uiLayer.add(o),t+=18;continue}const n=this.add.text(4,t,i.label,{fontFamily:"monospace",fontSize:"11px",color:i.color}).setDepth(700).setInteractive({useHandCursor:!0});this._uiLayer.add(n),n.on("pointerdown",()=>this._selectTool(i.id)),n.on("pointerover",()=>{this._activeTool!==i.id&&n.setColor("#ffffff")}),n.on("pointerout",()=>{this._activeTool!==i.id&&n.setColor(i.color)}),this._paletteButtons.push({tool:i,btn:n}),t+=22}this._updatePaletteHighlight(),t+=8;const e=this.add.text(4,t,"──────────",{fontFamily:"monospace",fontSize:"10px",color:"#333355"}).setDepth(700);this._uiLayer.add(e),t+=14;const s=this.add.text(4,t,"[LOOT ED.]",{fontFamily:"monospace",fontSize:"11px",color:"#ff88cc"}).setDepth(700).setInteractive({useHandCursor:!0});this._uiLayer.add(s),s.on("pointerdown",()=>this._showLootEditor()),s.on("pointerover",()=>s.setColor("#ffffff")),s.on("pointerout",()=>s.setColor("#ff88cc"))}_buildPropsPanel(){const t=f-z/2,e=$+8;this._propInfoText=this.add.text(e,t,"Aucun objet sélectionné",{fontFamily:"monospace",fontSize:"11px",color:"#555555"}).setOrigin(0,.5).setDepth(700),this._uiLayer.add(this._propInfoText),this._fieldX=this._makeEditField(e,t,"x"),this._fieldY=this._makeEditField(e+90,t,"y"),this._fieldScale=this._makeEditField(e+180,t,"scale"),this._btnDel=this._uiBtn(c-W-80,t,"[ DEL ]","#ff4444",()=>this._deleteSelected(),0,.5),this._btnDel.setVisible(!1),this._btnBlock=this._uiBtn(e+270,t,"[□ block]","#555555",()=>this._toggleBlocksPlayer(),0,.5),this._btnBlock.setVisible(!1),this._btnBlockEnemy=this._uiBtn(e+340,t,"[□ enemy]","#555555",()=>this._toggleBlocksEnemy(),0,.5),this._btnBlockEnemy.setVisible(!1),this._lblTarget=this.add.text(e+440,t,"",{fontFamily:"monospace",fontSize:"10px",color:"#aaaaaa"}).setOrigin(0,.5).setDepth(700).setVisible(!1),this._uiLayer.add(this._lblTarget),this._btnTgtL=this._uiBtn(e+540,t,"◄","#ff6600",()=>this._cycleTarget(-1),.5,.5),this._btnTgtR=this._uiBtn(e+560,t,"►","#ff6600",()=>this._cycleTarget(1),.5,.5),this._btnTgtL.setVisible(!1),this._btnTgtR.setVisible(!1),this._lblTargetWarp=this.add.text(e+580,t,"",{fontFamily:"monospace",fontSize:"10px",color:"#aaaaaa"}).setOrigin(0,.5).setDepth(700).setVisible(!1),this._uiLayer.add(this._lblTargetWarp),this._btnWarpL=this._uiBtn(e+690,t,"◄","#ff9900",()=>this._cycleTargetWarp(-1),.5,.5),this._btnWarpR=this._uiBtn(e+710,t,"►","#ff9900",()=>this._cycleTargetWarp(1),.5,.5),this._btnWarpL.setVisible(!1),this._btnWarpR.setVisible(!1),this._fieldBg=this._makeLevelField(e,t,"parallax.bg","px.bg"),this._fieldMid=this._makeLevelField(e+90,t,"parallax.mid","px.mid"),this._fieldWW=this._makeLevelField(e+180,t,"worldW","worldW"),this._fieldLaneTop=this._makeLevelField(e+480,t,"laneTop","lane↑"),this._fieldLaneBot=this._makeLevelField(e+570,t,"laneBottom","lane↓"),this._fieldSpawnX=this._makeLevelField(e+660,t,"spawnX","spawnX"),this._fieldWidth=this._makeEditField(e+180,t,"width"),this._fieldHeight=this._makeEditField(e+260,t,"height"),this._fieldLabel=this._makeEditField(e+340,t,"label"),this._btnBgL=this._uiBtn(e+265,t,"◄","#4488ff",()=>this._cycleBackground(-1),.5,.5),this._lblBgName=this.add.text(e+360,t,"(aucun)",{fontFamily:"monospace",fontSize:"10px",color:"#aaaacc"}).setOrigin(.5,.5).setDepth(700).setVisible(!1),this._uiLayer.add(this._lblBgName),this._btnBgR=this._uiBtn(e+455,t,"►","#4488ff",()=>this._cycleBackground(1),.5,.5),this._btnBgL.setVisible(!1),this._btnBgR.setVisible(!1),this._updatePropsPanel()}_buildListPanel(){const t=c-W,e=this.add.text(t+W/2,M+8,"OBJETS",{fontFamily:"monospace",fontSize:"10px",color:"#4488ff"}).setOrigin(.5,0).setDepth(700);this._uiLayer.add(e),this._listY0=M+24,this._listItems=[],this._listContainer=this.add.container(0,0).setDepth(700),this._uiLayer.add(this._listContainer)}_makeEditField(t,e,s){const i=this.add.text(t,e-7,s+":",{fontFamily:"monospace",fontSize:"9px",color:"#555555"}).setOrigin(0,.5).setDepth(700).setVisible(!1);this._uiLayer.add(i);const n=this.add.text(t,e+6,"---",{fontFamily:"monospace",fontSize:"11px",color:"#cccccc"}).setOrigin(0,.5).setDepth(700).setVisible(!1).setInteractive({useHandCursor:!0});return this._uiLayer.add(n),n.on("pointerdown",()=>{this._selected&&this._startNumInput(this._selected.obj,s,n)}),n.on("pointerover",()=>n.setColor("#ffffff")),n.on("pointerout",()=>{this._inputTarget?.textObj!==n&&n.setColor("#cccccc")}),{lbl:i,val:n}}_makeLevelField(t,e,s,i){const n=this.add.text(t,e-7,i+":",{fontFamily:"monospace",fontSize:"9px",color:"#445566"}).setOrigin(0,.5).setDepth(700).setVisible(!1);this._uiLayer.add(n);const o=this.add.text(t,e+6,"---",{fontFamily:"monospace",fontSize:"11px",color:"#aaaacc"}).setOrigin(0,.5).setDepth(700).setVisible(!1).setInteractive({useHandCursor:!0});return this._uiLayer.add(o),o.on("pointerdown",()=>this._startLevelPropInput(s,o)),o.on("pointerover",()=>o.setColor("#ffffff")),o.on("pointerout",()=>{this._inputTarget?.textObj!==o&&o.setColor("#aaaacc")}),{lbl:n,val:o}}_uiBtn(t,e,s,i,n,o=0,a=.5){const r=this.add.text(t,e,s,{fontFamily:"monospace",fontSize:"11px",color:i}).setOrigin(o,a).setDepth(700).setInteractive({useHandCursor:!0});return r.on("pointerdown",n),r.on("pointerover",()=>r.setColor("#ffffff")),r.on("pointerout",()=>r.setColor(i)),this._uiLayer.add(r),r}_loadLevel(){for(const e of this._worldObjects)this._destroyWO(e);this._worldObjects=[];for(const e of this._bgGraphics)e.destroy();this._bgGraphics=[],this._deselect(),this._camScrollX=0,this.cameras.main.setScroll(0,this._camScrollY());const t=this._levels[this._currentIdx];this._buildWorldBackground(t);for(const e of t.props)this._spawnPropSprite(e);for(const e of t.containers)this._spawnContainerSprite(e);for(const e of t.transitZones)this._spawnTransitSprite(e);this._updateToolbarName(),this._updatePropsPanel(),this._updatePaletteHighlight(),this._updateListPanel()}_rebuildBackground(){for(const s of this._bgGraphics)s.destroy();this._bgGraphics=[];const t=this._levels[this._currentIdx];this._buildWorldBackground(t);const e=Math.max(0,(t.worldW??3840)-c/this._zoom);this._camScrollX=Math.min(this._camScrollX,e),this.cameras.main.setScroll(this._camScrollX,this._camScrollY())}_buildWorldBackground(t){if(t.background&&this.textures.exists(t.background)){const y=this.textures.get(t.background).source[0],u=f/y.height,m=Math.round(y.width*u);t.worldW=m;const x=this.add.image(0,0,t.background).setOrigin(0,0).setScale(u).setDepth(0);this._bgGraphics.push(x)}else{const p=this.add.graphics().setDepth(1);p.fillStyle(1710638),p.fillRect(0,0,t.worldW??3840,f),p.fillStyle(2763322),p.fillRect(0,290,t.worldW??3840,f-290);const y=t.laneTop??O,u=t.laneBottom??R;p.fillStyle(3355461),p.fillRect(0,y,t.worldW??3840,u-y),p.fillStyle(8947865,.25),p.fillRect(0,y-2,t.worldW??3840,3),this._bgGraphics.push(p)}const e=t.worldW??3840,s=t.laneTop??O,i=t.laneBottom??R,n=this.add.graphics().setDepth(2);n.lineStyle(1,4478310,.4),n.lineBetween(0,s,e,s),n.lineBetween(0,i,e,i),this._bgGraphics.push(n);const o=this.add.graphics().setDepth(2);o.lineStyle(1,2241348,.4);for(let p=480;p<e;p+=480){o.lineBetween(p,0,p,f);const y=this.add.text(p+3,M+2,String(p),{fontFamily:"monospace",fontSize:"9px",color:"#334455"}).setDepth(3);this._bgGraphics.push(y)}this._bgGraphics.push(o);const a=this.add.graphics().setDepth(4);a.lineStyle(2,16729156,.7),a.lineBetween(e,0,e,f),this._bgGraphics.push(a);const r=this.add.text(e-4,M+4,`end  W:${e}`,{fontFamily:"monospace",fontSize:"10px",color:"#ff4444"}).setOrigin(1,0).setDepth(5);this._bgGraphics.push(r);const l=t.spawnX??150,d=this.add.graphics().setDepth(6);d.lineStyle(2,65416,.8),d.lineBetween(l,s-30,l,i+10);const _=this.add.text(l,i+12,"▲ spawn",{fontFamily:"monospace",fontSize:"9px",color:"#00ff88"}).setOrigin(.5,0).setDepth(6);this._bgGraphics.push(d,_);for(const p of this._bgGraphics)this._worldLayer.add(p)}_spawnPropSprite(t){if(!this.textures.exists(t.type))return console.warn(`[Editor] Texture manquante : ${t.type}`),null;const e=this.add.image(t.x,t.y,t.type).setOrigin(.5,1).setScale(t.scale??1).setDepth(t.y+10);this._worldLayer.add(e);const s={data:t,sprite:e,type:"prop"};return this._worldObjects.push(s),s}_spawnContainerSprite(t){const e=this.add.image(t.x,t.y,"barrel").setOrigin(.5,1).setScale(1).setDepth(t.y+10).setTint(8978312);this._worldLayer.add(e);const s={data:t,sprite:e,type:"container"};return this._worldObjects.push(s),s}_spawnTransitSprite(t){const e=this._levels[this._currentIdx],s=e.laneTop??O,i=e.laneBottom??R,n=t.width??120,o=t.y??s-30,a=t.height??i-s+60;t.y==null&&(t.y=o),t.height==null&&(t.height=a);const r=this.add.graphics().setDepth(s-5);this._worldLayer.add(r),this._redrawTransitGfx(r,t,o,n,a);const l=this.add.text(t.x+n/2,o-14,this._transitLabel(t),{fontFamily:"monospace",fontSize:"10px",color:this._transitColor(t,!0)}).setOrigin(.5,1).setDepth(s-4);this._worldLayer.add(l);const d={data:t,sprite:null,graphics:r,labelText:l,type:"transit",_zoneY:o,_zoneH:a};return this._worldObjects.push(d),d}_redrawTransitGfx(t,e,s,i,n){const o=this._transitColor(e);t.clear(),t.fillStyle(o,.18),t.fillRect(e.x,s,i,n),t.lineStyle(2,o,.9),t.strokeRect(e.x,s,i,n)}_transitColor(t,e=!1){return t.type==="warp"?e?"#00ccff":52479:e?"#00ff88":65416}_transitLabel(t){return t.type==="warp"?`► ${t.targetLevel??"WARP"}`:`▼ ${t.label??"EXTRACT"}`}_destroyWO(t){t.sprite?.destroy(),t.graphics?.destroy(),t.labelText?.destroy()}_hitTestWorld(t,e){for(let s=this._worldObjects.length-1;s>=0;s--){const i=this._worldObjects[s];if(this._woContains(i,t,e))return i}return null}_woContains(t,e,s){if(t.type==="prop"||t.type==="container"){const i=t.sprite;if(!i||!i.active)return!1;const n=i.displayWidth*.5,o=i.displayHeight;return e>=i.x-n&&e<=i.x+n&&s>=i.y-o&&s<=i.y}if(t.type==="transit"){const i=t.data.width??120;return e>=t.data.x&&e<=t.data.x+i&&s>=t._zoneY&&s<=t._zoneY+t._zoneH}return!1}_selectObject(t){this._selected={obj:t},this._drawSelectionRect(t),this._updatePropsPanel(),this._updateListPanel()}_deselect(){this._selected=null,this._selRect&&(this._selRect.destroy(),this._selRect=null),this._updatePropsPanel(),this._updateListPanel()}_drawSelectionRect(t){if(this._selRect&&(this._selRect.destroy(),this._selRect=null),!t)return;let e,s,i,n;if(t.type==="transit")e=t.data.x,s=t._zoneY,i=t.data.width??120,n=t._zoneH;else if(t.type==="fore"){const o=this._levels[this._currentIdx],a=o.laneTop??O,r=o.laneBottom??R;e=t.data.x-20,s=a-62,i=40,n=r-a+72}else{const o=t.sprite,a=o.displayWidth*.5,r=o.displayHeight;e=o.x-a,s=o.y-r,i=o.displayWidth,n=r}this._selRect=this.add.graphics().setDepth(9e3),this._worldLayer.add(this._selRect),this._selRect.lineStyle(2,16776960,.9),this._selRect.strokeRect(e-2,s-2,i+4,n+4),t.type==="transit"?(this._selRect.fillStyle(16737792,1),this._selRect.fillRect(e+i-2,s+n/2-5,10,10),this._selRect.fillRect(e+i/2-5,s+n-2,10,10)):t.type==="prop"&&(this._selRect.fillStyle(65416,1),this._selRect.fillRect(e+i-2,s+n-2,10,10))}_getResizeHandle(t,e,s){if(t.type==="transit"){const i=t.data.x,n=t._zoneY,o=t.data.width??120,a=t._zoneH;if(Math.abs(e-(i+o))<=10&&Math.abs(s-(n+a/2))<=10)return"width";if(Math.abs(e-(i+o/2))<=10&&Math.abs(s-(n+a))<=10)return"height"}else if(t.type==="prop"&&t.sprite){const i=t.sprite,n=i.displayWidth*.5;if(Math.abs(e-(i.x+n))<=10&&Math.abs(s-i.y)<=10)return"scale"}return null}_onPointerDown(t){if(this._capturingInput||t.x<$||t.x>c-W||t.y<M||t.y>f-z)return;const{x:s,y:i}=this._screenToWorld(t.x,t.y);if(this._selected?.obj){const o=this._getResizeHandle(this._selected.obj,s,i);if(o){this._resizeMode=o,this._dragOrigin={px:t.x,py:t.y},this._dragActive=!1;return}}const n=this._hitTestWorld(s,i);if(n){this._selectObject(n),this._dragOrigin={px:t.x,py:t.y},this._dragActive=!1;return}this._deselect(),this._activeTool!=="select"&&this._placeItem(s,i)}_onPointerMove(t){if(!t.isDown||this._capturingInput||!this._selected||t.x<$||t.x>c-W||t.y<M||t.y>f-z)return;if(!this._dragActive&&this._dragOrigin){const i=t.x-this._dragOrigin.px,n=t.y-this._dragOrigin.py;Math.sqrt(i*i+n*n)>Hs&&(this._dragActive=!0)}if(!this._dragActive)return;const{x:e,y:s}=this._screenToWorld(t.x,t.y);if(this._resizeMode){const i=this._selected.obj;if(this._resizeMode==="width")i.data.width=Math.max(20,Math.round(e-i.data.x)),this._refreshTransitWO(i),this._drawSelectionRect(i),this._updatePropsPanel();else if(this._resizeMode==="height")i.data.height=Math.max(20,Math.round(s-i._zoneY)),i._zoneH=i.data.height,this._refreshTransitWO(i),this._drawSelectionRect(i),this._updatePropsPanel();else if(this._resizeMode==="scale"){const n=i.sprite.width/2,o=Phaser.Math.Clamp((e-i.sprite.x)/n,.1,4),a=i.data.type,r=this._levels[this._currentIdx];for(const l of r.props)l.type===a&&(l.scale=o);for(const l of this._worldObjects)l.type==="prop"&&l.data.type===a&&l.sprite&&l.sprite.setScale(o);this._drawSelectionRect(i),this._updatePropsPanel()}return}this._moveObject(this._selected.obj,Math.round(e),Math.round(s))}_screenToWorld(t,e){const s=this.cameras.main.getWorldPoint(t,e);return{x:Math.round(s.x),y:Math.round(s.y)}}_moveObject(t,e,s){if(t.data.x=e,t.type==="prop"||t.type==="container")t.data.y=s,t.sprite.setPosition(e,s).setDepth(s+10);else if(t.type==="transit"){t.data.y=s,t._zoneY=s;const i=t.data.width??120;this._redrawTransitGfx(t.graphics,t.data,t._zoneY,i,t._zoneH),t.labelText.setPosition(e+i/2,t._zoneY-14)}this._drawSelectionRect(t),this._updatePropsPanel(),this._updateListPanel()}_camScrollY(){return Math.max(0,f/2*(1-1/this._zoom))}_onWheel(t,e){if(this._capturingInput)return;const i=t.x<$||t.x>c-W||t.y<M||t.y>f-z?c/2:t.x;this._applyZoom(e>0?1/1.12:1.12,i)}_applyZoom(t,e=c/2){const s=this._levels[this._currentIdx]?.worldW??3840,i=this._camScrollX+e/this._zoom;this._zoom=Phaser.Math.Clamp(this._zoom*t,.25,2),this.cameras.main.setZoom(this._zoom);const n=Math.max(0,s-c/this._zoom);this._camScrollX=Phaser.Math.Clamp(i-e/this._zoom,0,n),this.cameras.main.setScroll(this._camScrollX,this._camScrollY()),this._updateZoomLabel()}_updateZoomLabel(){this._zoomLabel&&this._zoomLabel.setText(`${Math.round(this._zoom*100)}%`)}_placeItem(t,e){const s=this._levels[this._currentIdx];if(this._activeTool.startsWith("prop:")){const i=this._activeTool.slice(5),n=$t.find(r=>r.id===this._activeTool),o={type:i,x:t,y:e,scale:n?.scale??1};s.props.push(o);const a=this._spawnPropSprite(o);a&&(this._selectObject(a),this._dragOrigin=null);return}if(this._activeTool==="container"){const i={x:t,y:e,texture:"barrel"};s.containers.push(i);const n=this._spawnContainerSprite(i);n&&(this._selectObject(n),this._dragOrigin=null);return}if(this._activeTool==="transit"){const i={id:`zone_${Date.now()}`,type:"warp",x:t,width:120,targetLevel:null,label:"WARP"};s.transitZones.push(i);const n=this._spawnTransitSprite(i);n&&(this._selectObject(n),this._dragOrigin=null);return}}_selectTool(t){this._activeTool=t,t!=="select"&&this._deselect(),this._updatePaletteHighlight()}_updatePaletteHighlight(){for(const{tool:t,btn:e}of this._paletteButtons)e.setColor(t.id===this._activeTool?"#ff6600":t.color??"#cccccc")}_updateListPanel(){for(const n of this._listItems)n.textObj.destroy();this._listItems=[];const t=c-W+4;let e=this._listY0;const s=this._selected?.obj,i=f-z-14;for(const n of this._worldObjects){if(e>i)break;const o=n===s,a=this._woShortLabel(n),r=o?"#ffff00":n.type==="container"?"#88ff88":n.type==="transit"?"#00ccff":"#aaaaaa",l=this.add.text(t,e,a,{fontFamily:"monospace",fontSize:"9px",color:r}).setDepth(700).setInteractive({useHandCursor:!0});this._uiLayer.add(l),l.on("pointerdown",()=>{this._selectObject(n);const d=n.data.x,_=this._levels[this._currentIdx]?.worldW??3840,p=c/this._zoom;this._camScrollX=Phaser.Math.Clamp(d-p/2,0,Math.max(0,_-p)),this.cameras.main.setScroll(this._camScrollX,this._camScrollY())}),l.on("pointerover",()=>l.setColor("#ffffff")),l.on("pointerout",()=>l.setColor(o?"#ffff00":r)),this._listItems.push({textObj:l,wo:n}),e+=13}if(this._worldObjects.length===0){const n=this.add.text(t,this._listY0,"(vide)",{fontFamily:"monospace",fontSize:"9px",color:"#444444"}).setDepth(700);this._uiLayer.add(n),this._listItems.push({textObj:n,wo:null})}}_woShortLabel(t){const e=t.data.x,s=t.data.y;if(t.type==="transit")return`[T] ${t.data.type} x${e}`;if(t.type==="container")return`[C] x${e} y${s}`;const i=(t.data.blocksPlayer?"■":"")+(t.data.blocksEnemy?"E":"");return`[P] ${t.data.type} x${e} ${i}`.trimEnd()}_updatePropsPanel(){const t=this._selected?.obj,e=f-z/2,s=$+8;this._propInfoText.setVisible(!1),this._btnDel.setVisible(!!t);for(const i of[this._fieldX,this._fieldY,this._fieldScale,this._fieldBg,this._fieldMid,this._fieldWW,this._fieldLaneTop,this._fieldLaneBot,this._fieldSpawnX,this._fieldWidth,this._fieldHeight,this._fieldLabel])i.lbl.setVisible(!1),i.val.setVisible(!1);if(this._lblTarget.setVisible(!1),this._btnTgtL.setVisible(!1),this._btnTgtR.setVisible(!1),this._lblTargetWarp.setVisible(!1),this._btnWarpL.setVisible(!1),this._btnWarpR.setVisible(!1),this._btnBgL.setVisible(!1),this._lblBgName.setVisible(!1),this._btnBgR.setVisible(!1),this._btnBlock.setVisible(!1),this._btnBlockEnemy.setVisible(!1),!t){const i=this._levels[this._currentIdx],n=i.background??null;this._lblBgName.setText(n??"(aucun)").setVisible(!0),this._btnBgL.setVisible(!0),this._btnBgR.setVisible(!0),i.background||(this._showField(this._fieldBg,s,e,"px.bg",i.parallax?.bg??.06),this._fieldBg.val.setColor("#aaaacc"),this._showField(this._fieldMid,s+90,e,"px.mid",i.parallax?.mid??.25),this._fieldMid.val.setColor("#aaaacc"),this._showField(this._fieldWW,s+180,e,"worldW",i.worldW??3840),this._fieldWW.val.setColor("#aaaacc")),this._showField(this._fieldLaneTop,s+480,e,"lane↑",i.laneTop??O),this._fieldLaneTop.val.setColor("#aaaacc"),this._showField(this._fieldLaneBot,s+570,e,"lane↓",i.laneBottom??R),this._fieldLaneBot.val.setColor("#aaaacc"),this._showField(this._fieldSpawnX,s+660,e,"spawnX",i.spawnX??150),this._fieldSpawnX.val.setColor("#aaaacc");return}if(this._showField(this._fieldX,s,e,"x",t.data.x),this._showField(this._fieldY,s+90,e,"y",t.data.y),t.type==="transit"){this._showField(this._fieldWidth,s+180,e,"width",t.data.width??120),this._showField(this._fieldHeight,s+260,e,"height",t.data.height??0),this._showField(this._fieldLabel,s+340,e,"label",t.data.label??""),this._lblTarget.setText(`→ ${t.data.targetLevel??"(none)"}`).setPosition(s+440,e).setVisible(!0),this._btnTgtL.setPosition(s+540,e).setVisible(!0),this._btnTgtR.setPosition(s+560,e).setVisible(!0);const i=t.data.targetWarpId??"(none)";this._lblTargetWarp.setText(`↪ ${i}`).setPosition(s+580,e).setVisible(!!t.data.targetLevel),this._btnWarpL.setPosition(s+690,e).setVisible(!!t.data.targetLevel),this._btnWarpR.setPosition(s+710,e).setVisible(!!t.data.targetLevel)}else if(this._showField(this._fieldScale,s+180,e,"scale",Number((t.data.scale??1).toFixed(2))),t.type==="prop"){const i=!!t.data.blocksPlayer;this._btnBlock.setText(i?"[■ BLOCK]":"[□ block]").setColor(i?"#ff6600":"#555555").setPosition(s+270,e).setVisible(!0);const n=!!t.data.blocksEnemy;this._btnBlockEnemy.setText(n?"[■ ENEMY]":"[□ enemy]").setColor(n?"#ff6600":"#555555").setPosition(s+340,e).setVisible(!0)}}_showField(t,e,s,i,n){t.lbl.setPosition(e,s-7).setText(i+":").setVisible(!0),t.val.setPosition(e,s+6).setText(String(n)).setVisible(!0).setColor("#cccccc")}_startNumInput(t,e,s){this._capturingInput||(this._capturingInput=!0,this._inputBuffer=String(t.data[e]??""),this._inputTarget={obj:t,field:e,textObj:s},s.setColor("#ffff00").setText(this._inputBuffer+"_"))}_startLevelPropInput(t,e){if(this._capturingInput)return;const s=this._levels[this._currentIdx];let i;t==="parallax.bg"&&(i=s.parallax?.bg??.06),t==="parallax.mid"&&(i=s.parallax?.mid??.25),t==="worldW"&&(i=s.worldW??3840),t==="laneTop"&&(i=s.laneTop??O),t==="laneBottom"&&(i=s.laneBottom??R),t==="spawnX"&&(i=s.spawnX??150),this._capturingInput=!0,this._inputBuffer=String(i),this._inputTarget={obj:null,field:"__levelProp",levelPath:t,textObj:e},e.setColor("#ffff00").setText(this._inputBuffer+"_")}_startRename(){const t=this._levels[this._currentIdx];this._capturingInput=!0,this._inputBuffer=t.name??"",this._inputTarget={obj:null,field:"name",textObj:this._levelNameText},this._levelNameText.setColor("#ffff00").setText(this._inputBuffer+"_")}_commitInput(){if(!this._capturingInput)return;if(this._inputTarget?.source==="loot"){this._commitLootInput();return}const{obj:t,field:e,textObj:s}=this._inputTarget,i=this._levels[this._currentIdx];if(e==="name")this._inputBuffer.trim()&&(i.name=this._inputBuffer.trim()),this._updateToolbarName(),s.setColor("#ffffff");else if(e==="__levelProp"){const n=parseFloat(this._inputBuffer),o=this._inputTarget.levelPath;isNaN(n)||(o==="parallax.bg"?(i.parallax||(i.parallax={}),i.parallax.bg=n):o==="parallax.mid"?(i.parallax||(i.parallax={}),i.parallax.mid=n):o==="worldW"?(i.worldW=Math.round(Math.max(200,n)),this._rebuildBackground()):o==="laneTop"?(i.laneTop=Math.round(n),this._loadLevel()):o==="laneBottom"?(i.laneBottom=Math.round(n),this._loadLevel()):o==="spawnX"&&(i.spawnX=Math.round(Math.max(0,n)),this._rebuildBackground())),s.setColor("#aaaacc")}else if(t){if(e==="label"){const n=this._inputBuffer.trim();n&&(t.data.label=n),t.type==="transit"&&this._refreshTransitWO(t)}else{const n=parseFloat(this._inputBuffer);isNaN(n)||(e==="scale"?(t.data.scale=n,t.sprite&&t.sprite.setScale(n)):e==="width"?(t.data.width=Math.max(20,Math.round(n)),t.type==="transit"&&(this._refreshTransitWO(t),this._drawSelectionRect(t))):e==="height"?(t.data.height=Math.max(20,Math.round(n)),t._zoneH=t.data.height,t.type==="transit"&&(this._refreshTransitWO(t),this._drawSelectionRect(t))):(t.data[e]=Math.round(n),(e==="x"||e==="y")&&this._moveObject(t,t.data.x,t.data.y)))}s.setColor("#cccccc")}this._capturingInput=!1,this._inputTarget=null,this._updatePropsPanel(),this._updateListPanel()}_cancelInput(){if(!this._capturingInput)return;if(this._inputTarget?.source==="loot"){this._inputTarget.textObj.setColor(this._inputTarget.cancelColor??"#ffcc44"),this._capturingInput=!1,this._inputTarget=null,this._lootRedrawContent();return}const{field:t,textObj:e}=this._inputTarget;t==="__levelProp"?e.setColor("#aaaacc"):t==="name"?(e.setColor("#ffffff"),this._updateToolbarName()):e.setColor("#cccccc"),this._capturingInput=!1,this._inputTarget=null,this._updatePropsPanel()}_onKeyDown(t){if(this._capturingInput){if(t.key==="Enter"){this._commitInput();return}if(t.key==="Escape"){this._cancelInput();return}if(t.key==="Backspace"){this._inputBuffer=this._inputBuffer.slice(0,-1),this._inputTarget.textObj.setText(this._inputBuffer+"_");return}(this._inputTarget.field==="label"||this._inputTarget.field==="name"?/^[\w \-]$/.test(t.key)&&this._inputBuffer.length<30:/^[\d.\-]$/.test(t.key)&&this._inputBuffer.length<10)&&(this._inputBuffer+=t.key,this._inputTarget.textObj.setText(this._inputBuffer+"_"));return}if(t.key==="Escape"){this._selected?this._deselect():this.scene.start("TitleScene");return}if(t.key==="Delete"&&this._selected){this._deleteSelected();return}if(t.key==="+"||t.key==="="){this._applyZoom(1.15);return}if(t.key==="-"){this._applyZoom(1/1.15);return}if(t.key==="0"){this._applyZoom(1/this._zoom);return}}_deleteSelected(){if(!this._selected)return;const t=this._selected.obj,e=this._levels[this._currentIdx];t.type==="prop"&&(e.props=e.props.filter(s=>s!==t.data)),t.type==="container"&&(e.containers=e.containers.filter(s=>s!==t.data)),t.type==="transit"&&(e.transitZones=e.transitZones.filter(s=>s!==t.data)),this._destroyWO(t),this._worldObjects=this._worldObjects.filter(s=>s!==t),this._deselect(),this._updateListPanel()}_cycleBackground(t){const e=this._levels[this._currentIdx],s=this._availableBackgrounds,i=s.indexOf(e.background??null),n=Phaser.Math.Wrap(i+t,0,s.length);e.background=s[n],this._rebuildBackground(),this._updatePropsPanel(),this._updateToolbarName()}_cycleTarget(t){const e=this._selected?.obj;if(!e||e.type!=="transit")return;const s=[null,...this._levels.map(o=>o.id)],i=s.indexOf(e.data.targetLevel),n=Phaser.Math.Wrap(i+t,0,s.length);e.data.targetLevel=s[n],this._refreshTransitWO(e),this._updatePropsPanel(),this._updateListPanel()}_cycleTargetWarp(t){const e=this._selected?.obj;if(!e||e.type!=="transit"||!e.data.targetLevel)return;const s=this._levels.find(r=>r.id===e.data.targetLevel);if(!s)return;const i=(s.transitZones??[]).filter(r=>r.type==="warp");if(!i.length)return;const n=[null,...i.map(r=>r.id)],o=n.indexOf(e.data.targetWarpId??null),a=Phaser.Math.Wrap(o+t,0,n.length);e.data.targetWarpId=n[a],this._updatePropsPanel()}_toggleBlocksPlayer(){const t=this._selected?.obj;!t||t.type!=="prop"||(t.data.blocksPlayer=!t.data.blocksPlayer,this._updatePropsPanel(),this._updateListPanel())}_toggleBlocksEnemy(){const t=this._selected?.obj;!t||t.type!=="prop"||(t.data.blocksEnemy=!t.data.blocksEnemy,this._updatePropsPanel(),this._updateListPanel())}_refreshTransitWO(t){const e=t.data.width??120;this._redrawTransitGfx(t.graphics,t.data,t._zoneY,e,t._zoneH),t.labelText.setText(this._transitLabel(t.data)).setColor(this._transitColor(t.data,!0)).setPosition(t.data.x+e/2,t._zoneY-14)}_updateToolbarName(){const t=this._levels[this._currentIdx];this._levelNameText.setText(`${this._currentIdx+1}/${this._levels.length}  ${t.name}`)}_prevLevel(){this._currentIdx>0&&(this._currentIdx--,this._loadLevel())}_nextLevel(){this._currentIdx<this._levels.length-1&&(this._currentIdx++,this._loadLevel())}_newLevel(){const t=this._levels.length+1,e=JSON.parse(JSON.stringify(this._levels[this._currentIdx]));e.id=`level_${String(t).padStart(2,"0")}`,e.name=`Level ${t}`,e.props=[],e.containers=[],e.transitZones=[{id:"zone_warp_01",type:"warp",x:Math.max(200,(e.worldW??3840)-200),width:120,targetLevel:null,label:"WARP"}],this._levels.push(e),this._currentIdx=this._levels.length-1,this._loadLevel()}async _testLevel(){await this._saveToServer(!0);const t=this._levels[this._currentIdx];this.registry.set("editorLevels",this._levels),this.scene.start("GameScene",{levelId:t.id,fromEditor:!0})}_showExport(){if(this._exportOverlay)return;const t=this._generateExportCode(),e=this.add.rectangle(c/2,f/2,c,f,0,.94).setDepth(9990).setInteractive(),s=this.add.text(c/2,12,"── EXPORT : js/config/levels.js ──",{fontFamily:"monospace",fontSize:"13px",color:"#4488ff"}).setOrigin(.5,0).setDepth(9991),i=this.add.text(c/2,30,"Copier ce code → coller dans js/config/levels.js  puis recharger",{fontFamily:"monospace",fontSize:"9px",color:"#888888"}).setOrigin(.5,0).setDepth(9991),n=this.add.text(6,48,t,{fontFamily:"monospace",fontSize:"8px",color:"#aaffaa"}).setDepth(9991),o=this.add.text(c-8,8,"[ FERMER ]",{fontFamily:"monospace",fontSize:"12px",color:"#ff6600"}).setOrigin(1,0).setDepth(9992).setInteractive({useHandCursor:!0});this._uiLayer.add([e,s,i,n,o]);const a=()=>{[e,s,i,n,o].forEach(r=>r.destroy()),this._exportOverlay=null};o.on("pointerdown",a),o.on("pointerover",()=>o.setColor("#ffffff")),o.on("pointerout",()=>o.setColor("#ff6600")),this._exportOverlay={bg:e,codeText:n,btnClose:o}}_generateExportCode(){const t=[];t.push("export const LEVELS = [");for(const e of this._levels){t.push("  {"),t.push(`    id: '${e.id}',`),t.push(`    name: '${e.name}',`),t.push(`    worldW: ${e.worldW??3840},`),t.push(`    parallax: { bg: ${e.parallax?.bg??.06}, mid: ${e.parallax?.mid??.25} },`),e.background&&t.push(`    background: '${e.background}',`),e.laneTop!=null&&t.push(`    laneTop: ${e.laneTop},`),e.laneBottom!=null&&t.push(`    laneBottom: ${e.laneBottom},`),e.spawnX!=null&&t.push(`    spawnX: ${e.spawnX},`),t.push("    props: [");for(const s of e.props??[]){const i=(s.blocksPlayer?", blocksPlayer: true":"")+(s.blocksEnemy?", blocksEnemy: true":"");t.push(`      { type: '${s.type}', x: ${s.x}, y: ${s.y}, scale: ${s.scale??1}${i} },`)}t.push("    ],"),t.push("    containers: [");for(const s of e.containers??[])t.push(`      { x: ${s.x}, y: ${s.y}, texture: '${s.texture??"barrel"}' },`);t.push("    ],"),t.push("    transitZones: [");for(const s of e.transitZones??[]){const i=s.targetLevel?`'${s.targetLevel}'`:"null",n=s.targetWarpId?`'${s.targetWarpId}'`:"null",o=s.y!=null?`, y: ${s.y}`:"",a=s.height!=null?`, height: ${s.height}`:"";t.push(`      { id: '${s.id}', type: '${s.type}', x: ${s.x}${o}, width: ${s.width??120}${a}, targetLevel: ${i}, targetWarpId: ${n}, label: '${s.label??""}' },`)}t.push("    ],"),t.push("  },")}return t.push("];"),t.push(""),t.push("export const LEVEL_MAP = Object.fromEntries(LEVELS.map(l => [l.id, l]));"),t.join(`
`)}async _fetchLevelsFromServer(){if(!this.registry.get("editorLevels"))try{const t=await fetch(`${xt}/levels`);if(!t.ok)throw new Error(`HTTP ${t.status}`);const e=await t.json(),s=Array.isArray(e)?e.filter(i=>i!=null&&i.id):[];if(s.length===0)return;try{localStorage.getItem("RAGEDERUE_editor_levels")||(this._levels=s,this._currentIdx=0,this._loadLevel())}catch{this._levels=s,this._currentIdx=0,this._loadLevel()}console.log(`[Editor] ${s.length} niveau(x) chargé(s) depuis le serveur.`)}catch(t){console.info("[Editor] Serveur éditeur non disponible — niveaux locaux utilisés.",t.message)}}async _saveToServer(t=!1){const e=this._levels.filter(s=>s!=null&&s.id);try{const s=JSON.stringify(e);localStorage.setItem("RAGEDERUE_editor_levels",s),this.registry.set("editorLevels",e)}catch{}try{const s=await fetch(`${xt}/levels`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok)throw new Error(`HTTP ${s.status}`);t||this._showSaveFeedback(!0)}catch(s){console.error("[Editor] Erreur sauvegarde :",s.message),t||this._showSaveFeedback(!1)}}_showSaveFeedback(t){const e=t?"✓  Sauvegardé":"✗  Serveur non disponible — utiliser [ EXPORT ]",s=t?"#00ff88":"#ff6600",i=this.add.text(c/2,M+28,e,{fontFamily:"monospace",fontSize:"12px",color:s,backgroundColor:"#000000cc",padding:{x:8,y:4}}).setOrigin(.5,0).setDepth(9999);this._uiLayer.add(i),this.tweens.add({targets:i,alpha:0,duration:900,delay:1e3,onComplete:()=>i.destroy()})}async _fetchLootData(){try{const t=await fetch(`${xt}/loot`);if(!t.ok)throw new Error(`HTTP ${t.status}`);this._lootData=await t.json()}catch(t){console.info("[Editor] Loot data non disponible :",t.message)}}_showLootEditor(){if(this._lootOverlay)return;if(!this._lootData){this._showSaveFeedback(!1);return}this._lootTab="tables";const t=8e3,e=[],s=n=>(this._uiLayer.add(n),e.push(n),n);s(this.add.rectangle(c/2,f/2,c,f,394772,.97).setDepth(t).setInteractive()),s(this.add.rectangle(c/2,16,c,32,1118515).setDepth(t+1)),s(this.add.text(8,4,"◆ LOOT EDITOR",{fontFamily:"monospace",fontSize:"12px",color:"#ff88cc"}).setDepth(t+2));const i=(n,o,a,r)=>{const l=s(this.add.text(n,16,o,{fontFamily:"monospace",fontSize:"11px",color:a}).setOrigin(.5,.5).setDepth(t+2).setInteractive({useHandCursor:!0}));return l._col=a,l.on("pointerdown",r),l.on("pointerover",()=>l.setColor("#ffffff")),l.on("pointerout",()=>l.setColor(l._col)),l};this._lootBtnTables=i(200,"[TABLES]","#aaaacc",()=>this._lootSetTab("tables")),this._lootBtnItems=i(280,"[ITEMS]","#aaaacc",()=>this._lootSetTab("items")),i(c-130,"[SAVE]","#ffcc00",()=>this._saveLootToServer()),i(c-50,"[CLOSE]","#ff4444",()=>this._hideLootEditor()),this._lootOverlay=e,this._lootContentObjs=[],this._lootRedrawContent()}_hideLootEditor(){if(this._lootOverlay){for(const t of this._lootOverlay)t.destroy();for(const t of this._lootContentObjs)t.destroy();this._lootOverlay=null,this._lootContentObjs=[],this._inputTarget?.source==="loot"&&(this._capturingInput=!1,this._inputTarget=null)}}_lootSetTab(t){this._lootTab=t,this._lootRedrawContent()}_lootRedrawContent(){for(const t of this._lootContentObjs)t.destroy();this._lootContentObjs=[],this._lootTab==="tables"?this._lootBuildTables():this._lootBuildItems(),this._lootBtnTables?.setColor(this._lootTab==="tables"?"#ff88cc":"#aaaacc"),this._lootBtnItems?.setColor(this._lootTab==="items"?"#ff88cc":"#aaaacc")}_lootBuildTables(){const n=a=>(this._uiLayer.add(a),this._lootContentObjs.push(a),a),o=(a,r,l,d)=>{const _=r.reduce((g,S)=>g+S.weight,0)||1;n(this.add.text(d,40,a,{fontFamily:"monospace",fontSize:"10px",color:"#aaaacc"}).setDepth(8003)),n(this.add.rectangle(d+175,52,350,1,3359829).setOrigin(0,.5).setDepth(8003)),r.forEach((g,S)=>{const w=58+S*18,P=g.weight/_,T=Math.max(1,Math.round(P*170)),st=Math.round(P*100);n(this.add.text(d,w,g.type.slice(0,13),{fontFamily:"monospace",fontSize:"10px",color:"#cccccc"}).setDepth(8003));const D=n(this.add.text(d+108,w,String(g.weight).padStart(3),{fontFamily:"monospace",fontSize:"10px",color:"#ffcc44"}).setDepth(8003).setInteractive({useHandCursor:!0}));D.on("pointerover",()=>D.setColor("#ffffff")),D.on("pointerout",()=>{this._inputTarget?.source==="loot"&&this._inputTarget.idx===S&&this._inputTarget.table===l||D.setColor("#ffcc44")}),D.on("pointerdown",()=>{this._capturingInput||(this._capturingInput=!0,this._inputBuffer=String(g.weight),this._inputTarget={source:"loot",type:"weight",table:l,idx:S,textObj:D,cancelColor:"#ffcc44"},D.setColor("#ffff00").setText(this._inputBuffer+"_"))}),n(this.add.text(d+132,w,`${st}%`.padStart(4),{fontFamily:"monospace",fontSize:"9px",color:"#556677"}).setDepth(8003)),n(this.add.rectangle(d+165,w+4,170,8,1710643).setOrigin(0,.5).setDepth(8003)),n(this.add.rectangle(d+165,w+4,T,8,4482764).setOrigin(0,.5).setDepth(8004))});const p=58+r.length*18;n(this.add.rectangle(d+175,p,350,1,3359829).setOrigin(0,.5).setDepth(8003)),n(this.add.text(d,p+4,`Total : ${_}`,{fontFamily:"monospace",fontSize:"9px",color:"#445566"}).setDepth(8003));const y=l==="container",u=y?this._lootData.containerItemCount:this._lootData.corpseItemCount,m=p+20;n(this.add.text(d,m,`Drops : ${u?.min??0}–${u?.max??1} items`,{fontFamily:"monospace",fontSize:"9px",color:"#445566"}).setDepth(8003));const x=(g,S)=>{const w=y?this._lootData.containerItemCount:this._lootData.corpseItemCount;w[g]=Math.max(0,(w[g]??0)+S),w.min>w.max&&(w[g==="min"?"max":"min"]=w[g]),this._lootRedrawContent()},b=(g,S,w,P)=>{const T=n(this.add.text(g,S,w,{fontFamily:"monospace",fontSize:"10px",color:"#556677"}).setDepth(8003).setInteractive({useHandCursor:!0}));return T.on("pointerdown",P),T.on("pointerover",()=>T.setColor("#ffffff")),T.on("pointerout",()=>T.setColor("#556677")),T};b(d+165,m,"[-min]",()=>x("min",-1)),b(d+210,m,"[+min]",()=>x("min",1)),b(d+255,m,"[-max]",()=>x("max",-1)),b(d+300,m,"[+max]",()=>x("max",1))};n(this.add.rectangle(c/2,f/2,1,f,2236996).setDepth(8003)),o("CONTAINER TABLE",this._lootData.containerTable,"container",8),o("CORPSE TABLE",this._lootData.corpseTable,"corpse",c/2+8)}_lootBuildItems(){const i=x=>(this._uiLayer.add(x),this._lootContentObjs.push(x),x),n=[8,125,220,255,300,340,380,415,460],o=["KEY","TEXTURE","INV","TIME","HEAL","HUNG","THIR","VAL"],a=[470,580,670,700,745,785,825,860,900],r=x=>{o.forEach((b,g)=>i(this.add.text(x[g],40,b,{fontFamily:"monospace",fontSize:"9px",color:"#556677"}).setDepth(8003)))};r(n),r(a),i(this.add.rectangle(c/2,53,c-8,1,3359829).setOrigin(.5,.5).setDepth(8003));const l=Object.entries(this._lootData.items??{}),d=new Set([...(this._lootData.containerTable??[]).map(x=>x.type),...(this._lootData.corpseTable??[]).map(x=>x.type)]),_=l.slice(0,Math.ceil(l.length/2)),p=l.slice(Math.ceil(l.length/2)),y=(x,b,g,S)=>{const w=58+g*16,P=d.has(x),T=de=>({fontFamily:"monospace",fontSize:"9px",color:de});i(this.add.text(S[0],w,x.slice(0,12),T("#cccccc")).setDepth(8003)),i(this.add.text(S[1],w,(b.texture??"?").slice(0,10),T("#aaaacc")).setDepth(8003)),i(this.add.text(S[2],w,`${b.invW??1}×${b.invH??1}`,T("#aaaaaa")).setDepth(8003)),i(this.add.text(S[3],w,String(b.useTime??0),T("#888888")).setDepth(8003)),i(this.add.text(S[4],w,String(b.healAmount??0),T("#ff8888")).setDepth(8003)),i(this.add.text(S[5],w,String(b.hungerRestore??0),T("#ffaa44")).setDepth(8003)),i(this.add.text(S[6],w,String(b.thirstRestore??0),T("#44aaff")).setDepth(8003)),i(this.add.text(S[7],w,String(b.value??0),T("#00ffcc")).setDepth(8003));const st=P?"#443333":"#ff4444",D=i(this.add.text(S[8],w,"[✕]",T(st)).setDepth(8003).setInteractive({useHandCursor:!0}));D.on("pointerover",()=>D.setColor(P?"#665555":"#ffffff")),D.on("pointerout",()=>D.setColor(st)),D.on("pointerdown",()=>{if(P){this._showSaveFeedback(!1);return}delete this._lootData.items[x],this._lootRedrawContent()})};_.forEach(([x,b],g)=>y(x,b,g,n)),p.forEach(([x,b],g)=>y(x,b,g,a)),i(this.add.rectangle(c/2,f/2,1,f,2236996).setDepth(8003));const u=58+Math.ceil(l.length/2)*16+8,m=i(this.add.text(8,u,"[+ NOUVEL ITEM]",{fontFamily:"monospace",fontSize:"10px",color:"#44ff88"}).setDepth(8003).setInteractive({useHandCursor:!0}));m.on("pointerover",()=>m.setColor("#ffffff")),m.on("pointerout",()=>m.setColor("#44ff88")),m.on("pointerdown",()=>{const x=`item_${Date.now()}`;this._lootData.items[x]={texture:"barrel",invW:1,invH:1,useTime:0,healAmount:0,value:0,displayW:32,displayH:32,glowColor:16777215,description:"New item"},this._lootRedrawContent()})}_commitLootInput(){const{type:t,table:e,idx:s,textObj:i}=this._inputTarget;if(t==="weight"){const n=parseInt(this._inputBuffer,10);if(!isNaN(n)&&n>=0){const o=e==="container"?this._lootData.containerTable:this._lootData.corpseTable;o[s].weight=n}}this._capturingInput=!1,this._inputTarget=null,this._lootRedrawContent()}async _saveLootToServer(){if(this._lootData)try{const t=await fetch(`${xt}/loot`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this._lootData)});if(!t.ok)throw new Error(`HTTP ${t.status}`);this._showSaveFeedback(!0)}catch(t){console.error("[Editor] Loot save error:",t.message),this._showSaveFeedback(!1)}}}const Et=3;function yt(h){if(h.setScale(Et),h.setDepth(h.y),h.shadow){const t=h.shadow;t.setPosition(h.x,h.y+h.displayHeight*.45),t.setScale(Et,Et*.3),t.setAlpha(.35),t.setDepth(h.y-.5)}}function Ft(h,t){const e=h.add.ellipse(t.x,t.y,56,14,0,.35);return t.shadow=e,e}const Ws={player_punch:{offsetX:48,offsetY:-22,w:52,h:30,dmg:15,kb:130},player_kick:{offsetX:55,offsetY:-16,w:62,h:28,dmg:20,kb:160},player_jab:{offsetX:42,offsetY:-22,w:46,h:28,dmg:10,kb:95},player_jump_kick:{offsetX:50,offsetY:-10,w:60,h:34,dmg:25,kb:200}},zs={player_punch:[2],player_kick:[2,3],player_jab:[2],player_jump_kick:[2]};class js extends Phaser.Physics.Arcade.Sprite{constructor(t,e,s,i=null){super(t,e,s,"player_idle"),t.add.existing(this),t.physics.add.existing(this),this.body.setSize(28,40),this.body.setOffset(34,20),this.body.setCollideWorldBounds(!0),this.hp=Ht,this.maxHp=Ht,this.combat=i,this.stamina=Nt,this.maxStamina=Nt,this._staminaRegenTimer=0,this.hunger=zt,this.maxHunger=zt,this._hungerDmgAccum=0,this.thirst=jt,this.maxThirst=jt,this._thirstDmgAccum=0,this.skills={punchSkill:0,kickSkill:0,jabSkill:0,moveSkill:0,lootSkill:0,healSkill:0,eatSkill:0},this._moveXPAccum=0,this.state="idle",this.isInvincible=!1,this.facing=1,this._isAirborne=!1,this._groundY=s,this.searching=!1,this.inInventory=!1,this.inMenu=!1,this.attackKeys={punch:t.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.X),kick:t.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.C),jab:t.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.V),jump:t.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE)},this.mobileJoy={x:0,y:0},this._gpAttack={punch:!1,kick:!1,jab:!1,jump:!1},t.input.gamepad.on("down",(n,o)=>{if(!document.hasFocus())return;const a=this.scene.registry.get("padIndex")??0;a<0||n.index===a&&(this.searching||this.inInventory||this.inMenu||(o.index===2&&(this._gpAttack.punch=!0),o.index===1&&(this._gpAttack.kick=!0),o.index===3&&(this._gpAttack.jab=!0),o.index===0&&(this._gpAttack.jump=!0)))}),Ft(t,this),this.play("player_idle"),this.on("animationupdate",(n,o)=>{if(!this.combat)return;const a=Ws[n.key],r=zs[n.key];if(a&&r&&r.includes(o.index)){const l=Phaser.Math.Clamp(this.stamina/this.maxStamina,Se,1),d={player_punch:"punchSkill",player_kick:"kickSkill",player_jab:"jabSkill",player_jump_kick:"kickSkill"},_=this._skillBonus(d[n.key]??"punchSkill"),p=Math.max(1,Math.round(a.dmg*l*_));this.combat.activateHitbox(this,a.offsetX,a.offsetY,a.w,a.h,p,a.kb),this.scene.net?.sendSkillGain&&this.scene.net.sendSkillGain(d[n.key]??"punchSkill",10)}}),this.on("animationcomplete",n=>{this.combat&&this.combat.deactivateHitboxes(this),this.anims.timeScale=1,["player_punch","player_kick","player_jab"].includes(n.key)&&(this.state="idle",this.play("player_idle",!0)),n.key==="player_jump_kick"&&this.state,n.key==="player_hurt"&&this.state==="hurt"&&this.play("player_hurt",!0)})}update(t,e){if(this.searching||this.inInventory||this.inMenu){this.setVelocity(0,0),this.state!=="idle"&&this.state!=="hurt"&&(this.state="idle",this.play("player_idle",!0)),this._wasFrozen=!0;return}this._wasFrozen&&(this._wasFrozen=!1,this._gpAttack.punch=this._gpAttack.kick=this._gpAttack.jab=this._gpAttack.jump=!1),this.state==="hurt"?(this.body.setVelocityX(this.body.velocity.x*.78),this.body.setVelocityY(0)):["punch","kick","jab"].includes(this.state)?this.setVelocity(0,0):this.state==="jump"||this.state==="jump_kick"?this.body.setVelocityY(0):this._handleMovement(t,e),this._handleAttackInput(),this._updateSurvival(),yt(this)}takeHit(t,e,s){if(this.isInvincible||this.state==="dead")return;if(this.hp=Math.max(0,this.hp-t),this.isInvincible=!0,this.combat&&this.combat.deactivateHitboxes(this),this.hp<=0){this.state="dead",this.setVelocity(0,0),this.play("player_hurt",!0),this.scene.sound.play("sfx_death_player",{volume:this.scene.registry.get("sfxVol")??.5});return}this.state="hurt";const i=this.x>=s?1:-1;this.setVelocity(i*e,0),this.play("player_hurt",!0),this.scene.sound.play("sfx_hit",{volume:this.scene.registry.get("sfxVol")??.5}),this.setAlpha(1);const n=this.scene.tweens.add({targets:this,alpha:{from:0,to:1},duration:60,repeat:-1,yoyo:!0});this.scene.time.delayedCall(_e,()=>{n.stop(),this.setAlpha(1),this.isInvincible=!1,this.state="idle",this.play("player_idle",!0)})}_handleAttackInput(){if(this.state==="hurt"){this._gpAttack.punch=this._gpAttack.kick=this._gpAttack.jab=this._gpAttack.jump=!1;return}if(this.state==="kick"){this._gpAttack.punch=this._gpAttack.kick=this._gpAttack.jab=this._gpAttack.jump=!1;return}const t=Phaser.Input.Keyboard.JustDown(this.attackKeys.punch)||this._gpAttack.punch,e=Phaser.Input.Keyboard.JustDown(this.attackKeys.kick)||this._gpAttack.kick,s=Phaser.Input.Keyboard.JustDown(this.attackKeys.jab)||this._gpAttack.jab,i=Phaser.Input.Keyboard.JustDown(this.attackKeys.jump)||this._gpAttack.jump;if(this._gpAttack.punch=!1,this._gpAttack.kick=!1,this._gpAttack.jab=!1,this._gpAttack.jump=!1,this._isAirborne){(e||t)&&this.state==="jump"&&(this._drainStamina(Wt),this._jumpKick());return}i&&this.state!=="punch"&&this.state!=="kick"&&this.state!=="jab"?this.stamina>=this.maxStamina*be&&(this._drainStamina(xe),this._startJump()):t?(this._drainStamina(me),this.anims.timeScale=Math.max(mt,this.stamina/this.maxStamina),this.state="punch",this.play("player_punch",!0)):e?(this._drainStamina(Wt),this.anims.timeScale=Math.max(mt,this.stamina/this.maxStamina),this.state="kick",this.play("player_kick",!0)):s&&(this._drainStamina(ge),this.anims.timeScale=Math.max(mt,this.stamina/this.maxStamina),this.state="jab",this.play("player_jab",!0))}_startJump(){this.state="jump",this._isAirborne=!0,this._groundY=this.y,this.play("player_jump",!0),this.body.setVelocityY(0),this.scene.tweens.add({targets:this,y:this._groundY-Ie,duration:Vt*.45,ease:"Sine.easeOut",onComplete:()=>{this.scene.tweens.add({targets:this,y:this._groundY,duration:Vt*.55,ease:"Sine.easeIn",onComplete:()=>this._land()})}})}_jumpKick(){this.state="jump_kick",this.anims.timeScale=Math.max(mt,this.stamina/this.maxStamina),this.play("player_jump_kick",!0)}_land(){this._isAirborne=!1,this.y=this._groundY,(this.state==="jump"||this.state==="jump_kick")&&(this.state="idle",this.play("player_idle",!0))}_updateSurvival(){if(this.state==="dead")return;const t=this.scene.game.loop.delta,e=t/1e3;if(this._staminaRegenTimer>0?this._staminaRegenTimer=Math.max(0,this._staminaRegenTimer-t):this.stamina=Math.min(this.maxStamina,this.stamina+ue*e),this.scene._levelConfig?.isPlanque){this.hp=Math.min(this.maxHp,this.hp+5*e),this.hunger=Math.min(this.maxHunger,this.hunger+10*e),this.thirst=Math.min(this.maxThirst,this.thirst+15*e),this._hungerDmgAccum=0,this._thirstDmgAccum=0;return}this.hunger=Math.max(0,this.hunger-ke*e),this.hunger<=0?(this._hungerDmgAccum+=t,this._hungerDmgAccum>=1e3&&(this._hungerDmgAccum-=1e3,this.hp=Math.max(0,this.hp-we))):this._hungerDmgAccum=0,this.thirst=Math.max(0,this.thirst-ve*e),this.thirst<=0?(this._thirstDmgAccum+=t,this._thirstDmgAccum>=1e3&&(this._thirstDmgAccum-=1e3,this.hp=Math.max(0,this.hp-Te))):this._thirstDmgAccum=0}_drainStamina(t){this.stamina=Math.max(0,this.stamina-t),this._staminaRegenTimer=ye}_skillLevel(t){let e=this.skills[t]??0,s=0;for(;e>=Math.round(100*Math.pow(s+1,1.5))&&(e-=Math.round(100*Math.pow(s+1,1.5)),s++,!(s>=50)););return s}_skillBonus(t){return 1+this._skillLevel(t)*.02}_handleMovement(t,e){const s=t.left.isDown||e.left.isDown,i=t.right.isDown||e.right.isDown,n=t.up.isDown||e.up.isDown,o=t.down.isDown||e.down.isDown;let a=0,r=0;const l=this.scene.registry.get("padIndex")??0,d=this.scene.input.gamepad;if(l>=0&&d&&d.total>0&&document.hasFocus()){const g=d.getPad(l);g&&(Math.abs(g.leftStick.x)>.15&&(a=g.leftStick.x),Math.abs(g.leftStick.y)>.15&&(r=g.leftStick.y),g.left.isDown&&(a=-1),g.right.isDown&&(a=1),g.up.isDown&&(r=-1),g.down.isDown&&(r=1))}(this.mobileJoy.x!==0||this.mobileJoy.y!==0)&&(a=this.mobileJoy.x,r=this.mobileJoy.y);let _=a*V,p=r*V*.6;if(s&&(_-=V),i&&(_+=V),n&&(p-=V*.6),o&&(p+=V*.6),(s||i)&&(n||o)&&a===0&&r===0&&(_*=.707,p*=.707),a!==0&&r!==0){const g=Math.sqrt(_*_+p*p);g>V&&(_=_/g*V,p=p/g*V*.6)}this.stamina<=0&&(_*=.6,p*=.6);const u=this._skillBonus("moveSkill");_*=u,p*=u,this.setVelocity(_,p);const m=this.scene.game.loop.delta,x=Math.sqrt(_*_+p*p)*(m/1e3);this._moveXPAccum+=x,this._moveXPAccum>=200&&(this._moveXPAccum-=200,this.scene.net?.sendSkillGain&&this.scene.net.sendSkillGain("moveSkill",1)),this.y=Phaser.Math.Clamp(this.y,this.scene.laneTop??O,this.scene.laneBottom??R),_<0?(this.setFlipX(!0),this.facing=-1):_>0&&(this.setFlipX(!1),this.facing=1);const b=Math.abs(_)>1||Math.abs(p)>1;b&&this.state!=="walk"?(this.state="walk",this.play("player_walk",!0)):!b&&this.state!=="idle"&&(this.state="idle",this.play("player_idle",!0))}}class Vs extends Phaser.Physics.Arcade.Sprite{constructor(t,e,s,i,n={}){super(t,e,s,"enemy_idle"),t.add.existing(this),t.physics.add.existing(this),this.body.setSize(28,40),this.body.setOffset(34,20),this.combat=i,this.hp=n.hp??Ee,this.maxHp=this.hp,this.speed=n.speed??Ce,this.attackDamage=n.attackDamage??10,this.attackKnockback=n.attackKnockback??110,this.state="patrol",this.isInvincible=!1,this.attackCooldown=0,this.accumulatedDmg=0,this.facing=1,this.netId=0,this.patrolLeft=e-160,this.patrolRight=e+160,this.patrolDir=1,Ft(t,this),this.play("enemy_idle"),this.on("animationupdate",(o,a)=>{o.key==="enemy_punch"&&a.index===2&&this.combat.activateHitbox(this,50,-22,58,32,this.attackDamage,this.attackKnockback)}),this.on("animationcomplete",o=>this._onAnimComplete(o))}_onAnimComplete(t){this.active&&(this.combat.deactivateHitboxes(this),t.key==="enemy_punch"&&this.state==="attack"&&(this.state="chase"),t.key==="enemy_hurt"&&this.state==="knockdown"&&(this.setVelocity(0,0),this.anims.pause(),this.scene.time.delayedCall(Re,()=>{this.state==="knockdown"&&(this.isInvincible=!1,this.state="chase",this.play("enemy_idle",!0))})))}update(t){if(this.state==="dead")return;this.attackCooldown-=this.scene.game.loop.delta;const e=t.x-this.x,s=t.y-this.y,i=Math.sqrt(e*e+s*s);switch(this.state){case"patrol":{this._doPatrol(),i<Pe&&(this.state="chase");break}case"chase":{i<De&&this.attackCooldown<=0?this._startAttack():this._chasePlayer(e,s,i,t);break}case"attack":{this.setVelocity(0,0);break}case"hitstun":{this.setVelocityX(this.body.velocity.x*.75),this.setVelocityY(0);break}case"knockdown":{this.setVelocityX(this.body.velocity.x*.85),this.setVelocityY(0);break}}yt(this)}takeHit(t,e,s){if(this.isInvincible||this.state==="dead")return;if(this.hp-=t,this.hp<=0){this._die();return}this.combat.deactivateHitboxes(this);const i=this.x>=s?1:-1;this.accumulatedDmg+=t,this.accumulatedDmg>=Me?this._knockdown(i,e):this._hitstun(i)}_hitstun(t){this.state="hitstun",this.isInvincible=!0,this.setVelocity(t*50,0),this.scene.sound.play("sfx_hit",{volume:this.scene.registry.get("sfxVol")??.5}),this.setTint(16729156),this.scene.time.delayedCall(Oe,()=>{this.active&&this.state==="hitstun"&&(this.clearTint(),this.isInvincible=!1,this.state="chase",this.play("enemy_idle",!0))})}_knockdown(t,e){this.state="knockdown",this.isInvincible=!0,this.accumulatedDmg=0,this.clearTint(),this.play("enemy_hurt",!0),this.scene.sound.play("sfx_hit",{volume:this.scene.registry.get("sfxVol")??.5}),this.setVelocity(t*e*2.2,0);const s=this.y,i=40,n=400;this.scene.tweens.add({targets:this,y:s-i,duration:n*.4,ease:"Sine.easeOut",onComplete:()=>{this.active&&this.scene.tweens.add({targets:this,y:s,duration:n*.6,ease:"Sine.easeIn",onComplete:()=>{this.active&&this.setVelocity(0,0)}})}}),this.scene.tweens.add({targets:this,angle:t*360,duration:n,ease:"Linear",onComplete:()=>{this.active&&this.setAngle(0)}})}_doPatrol(){const t=this.patrolDir>0?this.patrolRight:this.patrolLeft;if(Math.abs(this.x-t)<6){this.patrolDir*=-1,this.setVelocity(0,0),this.play("enemy_idle",!0);return}this.facing=this.patrolDir>0?1:-1,this.setVelocity(this.patrolDir*this.speed*.5,0),this.setFlipX(this.facing>0),this.play("enemy_walk",!0)}_chasePlayer(t,e,s,i){if(s<2){this.setVelocity(0,0);return}const n=t/s,o=e/s;this.facing=t>0?1:-1,this.setVelocity(n*this.speed,o*this.speed*.6),this.y=Phaser.Math.Clamp(this.y,this.scene.laneTop??O,this.scene.laneBottom??R),this.setFlipX(this.facing>0),this.play("enemy_walk",!0)}_startAttack(){this.state="attack",this.attackCooldown=2200,this.setVelocity(0,0),this.play("enemy_punch",!0)}_die(t=!1){this.state="dead",this.isInvincible=!0,this.combat.deactivateHitboxes(this),this.setVelocity(0,0),this.scene.tweens.killTweensOf(this),this.setAngle(0),t||this.scene.sound.play("sfx_death_enemy",{volume:this.scene.registry.get("sfxVol")??.5}),(!this.lootItems||this.lootItems.length===0)&&(this.lootItems=[]),this.searched=!1,this.searchable=!0,this.opened=!1,t?(this.play("enemy_hurt",!0),this.anims.setProgress(1),this.anims.pause(),this.setAlpha(.65)):(this.play("enemy_hurt",!0),this.once("animationcomplete-enemy_hurt",()=>{this.active&&(this.anims.pause(),this.setAlpha(.65))})),yt(this)}markSearched(){this.searched=!0,this.setAlpha(.35)}destroy(){this.shadow&&(this.shadow.destroy(),this.shadow=null),this.scene&&this.scene.tweens.killTweensOf(this),this.combat?.deactivateHitboxes(this),super.destroy()}}class Us extends Vs{constructor(t,e,s,i,n={}){super(t,e,s,i,n),this.isRemote=!0,this._targetX=e,this._targetY=s}update(t){if(this.state==="dead")return;const e=Math.min(1,10*(this.scene.game.loop.delta/1e3));this.x+=(this._targetX-this.x)*e,this.y+=(this._targetY-this.y)*e,this.y=Phaser.Math.Clamp(this.y,this.scene.laneTop??O,this.scene.laneBottom??R),yt(this)}takeHit(t,e,s){this.state!=="dead"&&(this.scene.sound.play("sfx_hit",{volume:this.scene.registry.get("sfxVol")??.5}),this.setTint(16729156),this.scene.time.delayedCall(150,()=>{this.active&&this.clearTint()}))}_onAnimComplete(t){this.active&&this.combat.deactivateHitboxes(this)}applyNetState(t){if(this._targetX=t.x,this._targetY=t.y,this.state==="dead"){this.hp=t.hp;return}if(t.facing!==this.facing&&(this.facing=t.facing,this.setFlipX(this.facing>0)),t.state!==this.state){if(t.state==="dead"){this._die(!!this._justCreated);return}switch(this.state=t.state,t.state){case"patrol":this.play("enemy_idle",!0);break;case"chase":this.play("enemy_walk",!0);break;case"attack":this.play("enemy_punch",!0);break;case"knockdown":this.play("enemy_hurt",!0);break;case"hitstun":this.setTint(16729156),this.scene.time.delayedCall(200,()=>{this.active&&this.clearTint()});break;default:this.play("enemy_idle",!0)}}this.hp=t.hp}}class Gs{constructor(t){this.scene=t,this.activeHitboxes=[],this.onHit=null}activateHitbox(t,e,s,i,n,o,a){const r=t.facing??1,l=new Phaser.Geom.Rectangle(t.x+e*r-i/2,t.y+s-n/2,i,n);this.activeHitboxes.push({rect:l,owner:t,damage:o,knockback:a,used:!1})}deactivateHitboxes(t){this.activeHitboxes=this.activeHitboxes.filter(e=>e.owner!==t)}update(t){for(const e of this.activeHitboxes)if(!e.used)for(const s of t){if(s===e.owner||!s.active||s.isInvincible||s.state==="dead")continue;const i=s.displayWidth*.5,n=s.displayHeight*.8,o=new Phaser.Geom.Rectangle(s.x-i/2,s.y-n,i,n);if(Phaser.Geom.Intersects.RectangleToRectangle(e.rect,o)){s.takeHit(e.damage,e.knockback,e.owner.x),this.onHit&&this.onHit(e.owner,s,e.damage,e.knockback),e.used=!0;break}}this.activeHitboxes=this.activeHitboxes.filter(e=>!e.used)}}const et={ethereum:{texture:"eth",category:"argent",invW:1,invH:1,useTime:0,healAmount:0,value:100,displayW:32,displayH:32,glowColor:65484,description:"Ethereum token — extract it!"},sushi:{texture:"sushi",category:"soin",invW:2,invH:1,useTime:1500,healAmount:20,hungerRestore:35,value:0,displayW:40,displayH:29,glowColor:16746666,description:"Sushi — +20 HP, +35 faim"},pizza:{texture:"pizza",category:"soin",invW:2,invH:2,useTime:2e3,healAmount:35,hungerRestore:50,value:0,displayW:40,displayH:21,glowColor:16737826,description:"Pizza — +35 HP, +50 faim"},ice_cream:{texture:"ice_cream",category:"soin",invW:1,invH:2,useTime:1200,healAmount:15,hungerRestore:20,thirstRestore:15,value:0,displayW:28,displayH:42,glowColor:11197951,description:"Ice Cream — +15 HP, +20 faim, +15 soif"},water_bottle:{texture:"ice_cream",category:"soin",invW:1,invH:1,useTime:800,healAmount:0,thirstRestore:50,value:0,displayW:28,displayH:42,glowColor:4500223,description:"Bouteille d'eau — +50 soif"},item_1771877262675:{texture:"barrel",category:"divers",invW:1,invH:1,useTime:0,healAmount:0,value:0,displayW:32,displayH:32,glowColor:16777215,description:"New item"}},$s=[{type:"ethereum",weight:20},{type:"sushi",weight:25},{type:"pizza",weight:15},{type:"ice_cream",weight:25},{type:"water_bottle",weight:20}],Xt={min:1,max:3},Xs=800,Ys=600,Ks=6400;function Js(h,t){const e=h.reduce((i,n)=>i+n.weight,0),s=[];for(let i=0;i<t;i++){let n=Math.random()*e;for(const o of h)if(n-=o.weight,n<=0){s.push(o.type);break}}return s}class Zs{constructor(t,e,s,i,n={}){if(this.scene=t,this.x=e,this.y=s,this.netId=n.netId??-1,this.image=t.add.image(e,s,i).setOrigin(.5,1),this.image.setDepth(s),this.searchable=!0,this.searched=!1,this.opened=!1,n.skipLoot)this.lootItems=[];else{const o=Phaser.Math.Between(Xt.min,Xt.max);this.lootItems=Js($s,o)}}markSearched(){this.searched=!0,this.image.setAlpha(.4)}destroy(){this.image.destroy()}}const qs=64;class Qs{constructor(t){this.scene=t,this.containers=[],this.nearestTarget=null}spawnContainers(t){t.forEach((e,s)=>{const i=new Zs(this.scene,e.x,e.y,e.texture,{netId:s,skipLoot:!0});e.isHideoutChest&&(i.isHideoutChest=!0,i.searched=!1),this.containers.push(i)})}update(t,e){let s=null,i=qs;for(const n of this.containers){if(n.searched&&!n.isHideoutChest)continue;const o=Phaser.Math.Distance.Between(t.x,t.y,n.x,n.y);o<i&&(i=o,s=n)}for(const n of e){if(n.state!=="dead"||!n.searchable||n.searched)continue;const o=Phaser.Math.Distance.Between(t.x,t.y,n.x,n.y);o<i&&(i=o,s=n)}return this.nearestTarget=s,s?{target:s,dist:i}:null}destroyAll(){this.containers.forEach(t=>t.destroy()),this.containers=[]}resetContainers(){this.containers.forEach(t=>{t.isHideoutChest||(t.searched=!1,t.lootItems=[])}),this.nearestTarget=null}}const Yt=6,Kt=4;class ti{constructor(t,e=0,s=0,i=!0){this.type=t,this.def=et[t],this.gridX=e,this.gridY=s,this.identified=i}}class ei{constructor(){this.cols=Yt,this.rows=Kt,this.grid=Array.from({length:Kt},()=>Array(Yt).fill(null)),this.items=[]}addItem(t,e=!0){const s=et[t];if(!s)return null;const i=this._findSlot(s.invW,s.invH);if(!i)return null;const n=new ti(t,i.x,i.y,e);return this._placeItem(n),this.items.push(n),n}removeItem(t){const e=this.items.indexOf(t);e!==-1&&(this.items.splice(e,1),this._clearCells(t))}useItem(t,e){if(!t.def.useTime&&!t.def.healAmount&&!t.def.value&&!t.def.hungerRestore&&!t.def.thirstRestore)return!1;if(t.def.healAmount>0){const s=e._skillBonus?.("healSkill")??1,i=Math.round(t.def.healAmount*s);e.hp=Math.min(e.maxHp,e.hp+i),e.scene?.net?.sendSkillGain&&e.scene.net.sendSkillGain("healSkill",i)}if(t.def.hungerRestore>0){const s=e._skillBonus?.("eatSkill")??1;e.hunger=Math.min(e.maxHunger,e.hunger+Math.round(t.def.hungerRestore*s)),e.scene?.net?.sendSkillGain&&e.scene.net.sendSkillGain("eatSkill",5)}if(t.def.thirstRestore>0){const s=e._skillBonus?.("eatSkill")??1;e.thirst=Math.min(e.maxThirst,e.thirst+Math.round(t.def.thirstRestore*s)),e.scene?.net?.sendSkillGain&&e.scene.net.sendSkillGain("eatSkill",5)}return t.def.value>0&&(e.wallet=(e.wallet??0)+t.def.value),this.removeItem(t),!0}hasRoom(t){const e=et[t];return e?this._findSlot(e.invW,e.invH)!==null:!1}get totalValue(){return this.items.reduce((t,e)=>t+(e.def.value??0),0)}_findSlot(t,e){for(let s=0;s<=this.rows-e;s++)for(let i=0;i<=this.cols-t;i++)if(this._canPlace(i,s,t,e))return{x:i,y:s};return null}_canPlace(t,e,s,i){for(let n=e;n<e+i;n++)for(let o=t;o<t+s;o++)if(this.grid[n][o]!==null)return!1;return!0}_placeItem(t){const{invW:e,invH:s}=t.def;for(let i=t.gridY;i<t.gridY+s;i++)for(let n=t.gridX;n<t.gridX+e;n++)this.grid[i][n]=t}_clearCells(t){for(let e=0;e<this.rows;e++)for(let s=0;s<this.cols;s++)this.grid[e][s]===t&&(this.grid[e][s]=null)}}const Jt=290,Zt=290;class si{constructor(t){this.scene=t,this.bgLayer=null,this.midLayer=null,this.bgSpeed=.06,this.midSpeed=.25,this.blockingGroup=null}build(t){const e=this.scene,{parallax:s,props:i,transitZones:n,background:o}=t;let{worldW:a}=t;const r=t.laneTop??O,l=t.laneBottom??R;if(this.bgSpeed=s?.bg??.06,this.midSpeed=s?.mid??.25,o&&e.textures.exists(o)){const _=e.textures.get(o).source[0],p=f/_.height;a=Math.round(_.width*p),e.add.image(0,0,o).setOrigin(0,0).setScale(p).setDepth(0),this.bgLayer=null,this.midLayer=null}else{this.bgLayer=e.add.tileSprite(0,0,c,Jt,"back").setOrigin(0,0).setScrollFactor(0).setDepth(0),this.midLayer=e.add.tileSprite(0,Jt-60,c,200,"tileset").setOrigin(0,0).setScrollFactor(0).setDepth(5);const d=e.add.graphics();d.fillStyle(2763322),d.fillRect(0,Zt,c,f-Zt),d.fillStyle(3355461),d.fillRect(0,r,c,l-r),d.fillStyle(8947865,.4),d.fillRect(0,r-2,c,3),d.setScrollFactor(0).setDepth(8)}if(e.physics.world.setBounds(0,0,a,f),e.cameras.main.setBounds(0,0,a,f),this.blockingGroup=e.physics.add.staticGroup(),i.forEach(d=>this._placeProp(d)),t.forePositions?.length)for(const d of t.forePositions)this._placeProp({type:"fore",x:d,y:r-20,scale:1.2});n.forEach(d=>this._buildTransitZone(d,r,l))}updateParallax(t){this.bgLayer&&(this.bgLayer.tilePositionX=t*this.bgSpeed),this.midLayer&&(this.midLayer.tilePositionX=t*this.midSpeed)}_placeProp(t){if(t.blocksPlayer){const s=this.blockingGroup.create(t.x,t.y,t.type);return s.setOrigin(.5,1).setScale(t.scale??1).setDepth(t.y),s.refreshBody(),s}const e=this.scene.add.image(t.x,t.y,t.type).setOrigin(.5,1);return t.scale!=null&&e.setScale(t.scale),e.setDepth(t.y),e}_buildTransitZone(t,e=O,s=R){const i=this.scene,n=t.y??e-30,o=t.height??s-e+60,a=t.width??120,r=t.type==="warp"?52479:65416,l=t.type==="warp"?"#003344":"#003322",d=t.type==="warp"?"#00ccff":"#00ff88",_=i.add.graphics();_.fillStyle(r,.12),_.fillRect(t.x,n,a,o),_.lineStyle(2,r,.9),_.strokeRect(t.x,n,a,o),_.setDepth(e-5);const p=t.type==="warp"?`► ${t.label??t.targetLevel??"WARP"} ►`:`▼  ${t.label??"EXTRACT"}  ▼`,y=i.add.text(t.x+a/2,n-40,p,{fontFamily:"monospace",fontSize:"16px",color:d,stroke:l,strokeThickness:3}).setOrigin(.5).setDepth(e-4);i.tweens.add({targets:[_,y],alpha:.25,duration:850,yoyo:!0,repeat:-1})}}class ii{constructor(t){this.scene=t,this.cursors=null,this.wasd=null}setup(t){const e=this.scene,{onInteract:s,onInventory:i,onSettings:n}=t;this.cursors=e.input.keyboard.createCursorKeys();const o=e.input.keyboard,a=o.addKey(Phaser.Input.Keyboard.KeyCodes.W),r=o.addKey(Phaser.Input.Keyboard.KeyCodes.A),l=o.addKey(Phaser.Input.Keyboard.KeyCodes.S),d=o.addKey(Phaser.Input.Keyboard.KeyCodes.D),_=o.addKey(Phaser.Input.Keyboard.KeyCodes.Z),p=o.addKey(Phaser.Input.Keyboard.KeyCodes.Q),y=(u,m)=>({get isDown(){return u.isDown||m.isDown}});if(this.wasd={up:y(a,_),down:y(l,l),left:y(r,p),right:y(d,d)},e.input.keyboard.on("keydown-E",()=>{e.player?.searching||e.player?.inMenu||(e.registry.set("inputMode","kb"),s())}),e.input.keyboard.on("keydown-TAB",u=>{u.preventDefault(),!e.player?.inMenu&&(e.registry.set("inputMode","kb"),i())}),e.input.keyboard.on("keydown-ESC",()=>{e.registry.set("inputMode","kb"),n()}),e.input.keyboard.on("keydown",()=>{e.registry.set("inputMode","kb")}),e.input.gamepad.on("down",(u,m)=>{if(!document.hasFocus())return;const x=e.registry.get("padIndex")??0;if(x<0||u.index!==x||(e.registry.set("inputMode","gp"),e.player.searching||e.player.inMenu||e.player.inInventory))return;const b=e.registry.get("inventoryClosedAt")??0;m.index===8&&Date.now()-b<200||(m.index===9&&n(),m.index===3&&s(),m.index===8&&i())}),e.registry.get("padIndex")===void 0){const u=parseInt(localStorage.getItem("RAGEDERUE_padIndex")??"0",10);e.registry.set("padIndex",u)}}}class ni extends Phaser.Physics.Arcade.Sprite{constructor(t,e,s,i,n){super(t,i,n,"player_idle"),t.add.existing(this),t.physics.add.existing(this),this.body.setSize(28,40),this.body.setOffset(34,20),this.netId=e,this.netName=s,this.state="idle",this.facing=1,this.hp=100,this.setScale(2),this._targetX=i,this._targetY=n,this._lerpSpeed=10,this._nameTag=t.add.text(i,n-50,s,{fontFamily:"monospace",fontSize:"10px",color:"#88ccff",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(9999),Ft(t,this),this.play("player_idle")}setName(t){this.netName=t,this._nameTag.setText(t)}applySnapshot(t){this._targetX=t.x,this._targetY=t.y,this.hp=t.hp;const e=t.facing;if(e!==this.facing&&(this.facing=e,this.setFlipX(this.facing<0)),t.state!==this.state){this.state=t.state;const s=`player_${this.state}`;this.scene.anims.exists(s)&&this.play(s,!0)}}update(t,e){const s=e/1e3,i=Math.min(1,this._lerpSpeed*s);this.x+=(this._targetX-this.x)*i,this.y+=(this._targetY-this.y)*i,this.y=Phaser.Math.Clamp(this.y,this.scene.laneTop??O,this.scene.laneBottom??R),this._nameTag.setPosition(this.x,this.y-50),yt(this)}destroy(){this._nameTag&&this._nameTag.destroy(),super.destroy()}}class oi{constructor(t){this.scene=t,this._overlay=null}setup(){const t=this.scene,e=t.net;this._playerNames=new Map,e.onWelcome=s=>{console.log(`[Game] Connected as player #${s}`)},e.onPlayerJoin=(s,i)=>{this._playerNames.set(s,i);const n=t.remotePlayers.get(s);n&&n.setName(i)},e.onSnapshot=s=>{const i=new Set;for(const n of s){if(n.id===e.playerId)continue;i.add(n.id);let o=t.remotePlayers.get(n.id);if(!o){const a=this._playerNames.get(n.id)??`Player ${n.id}`;o=new ni(t,n.id,a,n.x,n.y),t.remotePlayers.set(n.id,o)}o.applySnapshot(n)}for(const[n,o]of t.remotePlayers)i.has(n)||(o.destroy(),t.remotePlayers.delete(n))},e.onEnemySnapshot=s=>{t._syncEnemiesFromServer(s)},e.onLootData=(s,i,n)=>{if(s===0){const o=t.lootSystem.containers.find(a=>a.netId===i);o&&(o.lootItems=n)}else{const o=t.enemies.find(a=>a.netId===i);o?(o.lootItems=n,o.searchable=!0,o.searched=!1):t._pendingCorpseLoot.set(i,n)}},e.onTimerSync=s=>{t.runTimer=s},e.onSkills=s=>{t.player&&(t.player.skills=s)},e.onChestData=s=>{t.registry.set("chestItems",s);const i=t.scene.get("HideoutChestScene");i&&t.scene.isActive("HideoutChestScene")&&(i._chestItems=s.slice(),i._chestSel=Math.min(i._chestSel,Math.max(0,s.length-1)),i._redraw(),i._updateFocus())},e.onWorldReset=s=>{console.log("[Game] World reset received — new timer:",s),t._handleWorldReset(s)},e.onPlayerLeave=s=>{this._playerNames.delete(s);const i=t.remotePlayers.get(s);i&&(i.destroy(),t.remotePlayers.delete(s))},e.onDisconnect=()=>{t._gameEnded||(console.warn("[Game] Disconnected — showing reconnect overlay"),this._showReconnectOverlay(),t.player&&t.player.setVelocity(0,0))},e.onReconnect=()=>{console.log("[Game] Reconnected — resuming"),this._hideReconnectOverlay()}}_showReconnectOverlay(){if(this._overlay)return;const t=this.scene,e=5e4,s=t.add.rectangle(c/2,f/2,c,f,0,.65).setScrollFactor(0).setDepth(e),i=t.add.text(c/2,f/2-22,"CONNEXION PERDUE",{fontFamily:"monospace",fontSize:"20px",color:"#ff4444",stroke:"#000",strokeThickness:5}).setOrigin(.5).setScrollFactor(0).setDepth(e+1),n=t.add.text(c/2,f/2+14,"Reconnexion en cours…",{fontFamily:"monospace",fontSize:"13px",color:"#aaaacc",stroke:"#000",strokeThickness:3}).setOrigin(.5).setScrollFactor(0).setDepth(e+1);t.tweens.add({targets:n,alpha:.3,duration:700,yoyo:!0,repeat:-1});const o=t.add.rectangle(c/2,f/2+52,140,36,5583667,.9).setInteractive({useHandCursor:!0}).setScrollFactor(0).setDepth(e+1).setStrokeStyle(2,16777215,.4),a=t.add.text(c/2,f/2+52,"QUITTER",{fontFamily:"monospace",fontSize:"13px",color:"#ffffff",stroke:"#000",strokeThickness:3}).setOrigin(.5).setScrollFactor(0).setDepth(e+2);o.on("pointerdown",()=>{t.net.disconnect(),t.registry.remove("sharedNet"),t._endGame("over","DISCONNECTED")}),this._overlay={bg:s,title:i,sub:n,btnBg:o,btnLbl:a}}_hideReconnectOverlay(){if(!this._overlay)return;const{bg:t,title:e,sub:s,btnBg:i,btnLbl:n}=this._overlay;[t,e,s,i,n].forEach(o=>o.destroy()),this._overlay=null}}const Pt=5e3,vt=280,Dt=12,Mt=(c-vt)/2,bt=f-56;class ai extends Phaser.Scene{constructor(){super({key:"GameScene"})}create(t){this._gameEnded=!1,this.runTimer=Ks,this._pendingCorpseLoot=new Map,this.registry.set("inputMode","kb");const e=t&&t.levelId||pt[0].id;this._fromEditor=!!(t&&t.fromEditor);const s=this._fromEditor&&this.registry.get("editorLevels")||pt;this._levelConfig=s.find(b=>b.id===e)||pt[0],this.laneTop=this._levelConfig.laneTop??O,this.laneBottom=this._levelConfig.laneBottom??R;const i=new URLSearchParams(window.location.search),n=i.get("server")||"localhost",o=i.get("port")||"9000",r=i.get("ssl")==="true"||window.location.protocol==="https:"?"wss":"ws",l=this.registry.get("charName")||i.get("name")||"Player",d=i.get("room")||"street_01",_=this.registry.get("charId")||"",p=i.get("room")||this._levelConfig.id||d,y=this.registry.get("sharedNet");if(y&&y.connected)this.net=y,this._netOwner=!1;else{this.net=new ae,this._netOwner=!0,this.registry.set("sharedNet",this.net);const b=`${r}://${n}:${o}`;this.net.connect(b,l,p,_)}this.remotePlayers=new Map,this.world=new si(this),this.world.build(this._levelConfig),this.netHandlers=new oi(this),this.netHandlers.setup(),this._netOwner||this.net.joinRoom(l,p,_),this.combat=new Gs(this),this.combat.onHit=(b,g,S,w)=>{b===this.player&&g.netId!=null&&this.net.sendHitEnemy(g.netId,S,w,b.x)};let u=this._levelConfig.spawnX??150;const m=(t&&t.spawnAtWarpId)??null;if(m){const b=(this._levelConfig.transitZones??[]).find(g=>g.id===m);b&&(u=b.x+(b.width??120)+32)}this.player=new js(this,u,this.laneBottom-10,this.combat),this.player.wallet=this.registry.get("playerWallet")??0,this.cameras.main.startFollow(this.player,!0,.1,.1),this.physics.add.collider(this.player,this.world.blockingGroup),this.enemies=[],this.enemiesGroup=this.physics.add.group(),this.inventory=this.registry.get("playerInventory")??new ei,this.registry.set("playerInventory",this.inventory),this.lootSystem=new Qs(this),this.lootSystem.spawnContainers(this._levelConfig.containers),this.inputCtrl=new ii(this),this.inputCtrl.setup({onInteract:()=>this._interact(),onInventory:()=>this._openInventory(),onSettings:()=>this._toggleSettings()}),this.scene.launch("HUDScene",{player:this.player,inventory:this.inventory}),this._searchPrompt=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"11px",color:"#ffcc00",stroke:"#000000",strokeThickness:3}).setOrigin(.5).setDepth(9999).setVisible(!1),this.tweens.add({targets:this._searchPrompt,alpha:.4,duration:600,yoyo:!0,repeat:-1}),this._transitZone=null,this._transitTimer=0,this._transitActive=!1,this._transitPrompt=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"12px",color:"#00ff88",stroke:"#000000",strokeThickness:4}).setOrigin(.5).setDepth(9998).setVisible(!1),this.tweens.add({targets:this._transitPrompt,alpha:.3,duration:700,yoyo:!0,repeat:-1}),this._transitBarBg=this.add.graphics().setScrollFactor(0).setDepth(9998).setVisible(!1),this._transitBarFill=this.add.graphics().setScrollFactor(0).setDepth(9999).setVisible(!1),this._transitBarLabel=this.add.text(c/2,bt-18,"",{fontFamily:"monospace",fontSize:"13px",color:"#00ff88",stroke:"#000000",strokeThickness:4}).setOrigin(.5).setScrollFactor(0).setDepth(9999).setVisible(!1),this.sound.stopByKey("music_street"),this.sound.stopByKey("music_naval");const x=parseFloat(localStorage.getItem("RAGEDERUE_music_vol")??"0.5");this.bgMusic=this.sound.add("music_street",{loop:!0,volume:x}),this.bgMusic.play(),this.registry.set("sfxVol",parseFloat(localStorage.getItem("RAGEDERUE_sfx_vol")??"0.5")),this._mobileActive=N,this._mobileActive&&this.scene.launch("MobileControlsScene",{player:this.player,onInteract:()=>this._interact(),onInventory:()=>this._openInventory(),onPause:()=>this._toggleSettings()}),this._searchCooldown=0,this.scene.get("SearchScene").events.on("shutdown",()=>{this._searchCooldown=500}),this.scene.get("HideoutChestScene").events.on("shutdown",()=>{this._searchCooldown=500})}update(t,e){if(this._gameEnded)return;if(this._searchCooldown>0&&(this._searchCooldown-=e),this._levelConfig.isPlanque||(this.runTimer=Math.max(0,this.runTimer-e/1e3)),this.enemies=this.enemies.filter(n=>n.active),this.player.update(this.inputCtrl.cursors,this.inputCtrl.wasd),this.enemies.forEach(n=>n.update(this.player)),this.combat.update([this.player,...this.enemies]),this.player.hp<=0)return this._endGame("over","DEAD");this.registry.set("runTimer",this.runTimer);const s=this.lootSystem.update(this.player,this.enemies);if(s){const n=this.registry.get("inputMode")==="gp";this._searchPrompt.setText(n?"[Y] Search":"[E] Search").setVisible(!0),this._searchPrompt.setPosition(s.target.x,(s.target.y??s.target.image?.y??this.player.y)-60)}else this._searchPrompt.setVisible(!1);let i=null;for(const n of this._levelConfig.transitZones){const o=n.x+(n.width??120),a=n.y??this.laneTop-30,r=a+(n.height??this.laneBottom-this.laneTop+60);if(this.player.x>=n.x&&this.player.x<=o&&this.player.y>=a&&this.player.y<=r){i=n;break}}if(this._transitZone=i,this._transitActive&&!i&&this._cancelTransit(),this._transitActive&&i){this._transitTimer+=e;const n=Math.min(1,this._transitTimer/Pt);if(this._updateTransitBar(n,i),this._transitTimer>=Pt){if(i.type==="extract")return this.player.wallet=this.inventory.totalValue,this._endGame("win","");if(i.type==="warp"&&i.targetLevel)return this._warpToLevel(i.targetLevel,i.targetWarpId??null)}}if(i&&!this._transitActive){const o=this.registry.get("inputMode")==="gp"?"[Y]":"[E]",a=i.type==="extract"?"Extraire":i.label??"Entrer",r=i.width??120,l=i.y??this.laneTop-30;this._transitPrompt.setText(`${o} ${a}`).setPosition(i.x+r/2,l-18).setVisible(!0)}else this._transitPrompt.setVisible(!1);this.net.sendState(this.player.x,this.player.y,this.player.body.velocity.x,this.player.body.velocity.y,this.player.state,this.player.facing,this.player.hp);for(const[,n]of this.remotePlayers)n.update(t,e);this.world.updateParallax(this.cameras.main.scrollX)}_startTransit(){this._transitActive=!0,this._transitTimer=0,this._transitPrompt.setVisible(!1),this._updateTransitBar(0,this._transitZone)}_cancelTransit(){this._transitActive=!1,this._transitTimer=0,this._transitBarBg.setVisible(!1),this._transitBarFill.setVisible(!1),this._transitBarLabel.setVisible(!1)}_updateTransitBar(t,e){const s=((Pt-this._transitTimer)/1e3).toFixed(1),i=e.type==="extract"?"EXTRACTION":e.label?.toUpperCase()??"WARP";this._transitBarBg.clear().setVisible(!0),this._transitBarBg.fillStyle(0,.75),this._transitBarBg.fillRect(Mt-2,bt-2,vt+4,Dt+4),this._transitBarBg.lineStyle(1,65416,.6),this._transitBarBg.strokeRect(Mt-2,bt-2,vt+4,Dt+4),this._transitBarFill.clear().setVisible(!0),this._transitBarFill.fillStyle(65416,.9),this._transitBarFill.fillRect(Mt,bt,Math.round(vt*t),Dt),this._transitBarLabel.setText(`${i}  ${s}s`).setVisible(!0)}_syncEnemiesFromServer(t){const e=new Set;for(const s of t){e.add(s.netId);let i=this.enemies.find(n=>n.netId===s.netId);i||(i=new Us(this,s.x,s.y,this.combat,{}),i.netId=s.netId,i._justCreated=!0,this.enemies.push(i),this.enemiesGroup.add(i),this._pendingCorpseLoot.has(s.netId)&&(i.lootItems=this._pendingCorpseLoot.get(s.netId),i.searchable=!0,i.searched=!1,this._pendingCorpseLoot.delete(s.netId))),i.applyNetState(s),i._justCreated=!1}this.enemies=this.enemies.filter(s=>e.has(s.netId)?!0:(s.destroy(),!1))}_handleWorldReset(t){this.scene.isActive("SearchScene")&&(this.player.searching=!1,this.scene.stop("SearchScene"));for(const e of this.enemies)e.destroy();this.enemies=[],this.enemiesGroup.clear(!0,!0),this._pendingCorpseLoot.clear(),this.lootSystem.resetContainers(),this.runTimer=t,this.player.hp=this.player.maxHp,console.log("[Game] World reset complete")}_warpToLevel(t,e=null){if(!this._gameEnded){this._gameEnded=!0,this.registry.set("playerWallet",this.player.wallet??0),this._fromEditor&&(this._netOwner&&this.net.disconnect(),this.registry.remove("sharedNet")),this.net.onDisconnect=null,this.net.onSnapshot=null,this.net.onEnemySnapshot=null,this.net.onTimerSync=null,this.net.onWorldReset=null,this.net.onPlayerLeave=null;for(const[,s]of this.remotePlayers)s.destroy();this.remotePlayers.clear(),["HUDScene","SearchScene","HideoutChestScene","InventoryScene","PauseScene","MobileControlsScene"].forEach(s=>this.scene.stop(s)),this.player.searching=!1,this.player.inMenu=!1,this.bgMusic&&(this.bgMusic.stop(),this.bgMusic.destroy(),this.bgMusic=null),this._fromEditor?this.scene.start("LevelEditorScene"):this.scene.start("GameScene",{levelId:t,spawnAtWarpId:e})}}_endGame(t,e){if(!this._gameEnded){this._gameEnded=!0,this.registry.remove("playerInventory"),this.registry.remove("playerWallet"),this.net.disconnect(),this.registry.remove("sharedNet");for(const[,s]of this.remotePlayers)s.destroy();this.remotePlayers.clear(),["HUDScene","SearchScene","HideoutChestScene","InventoryScene","PauseScene","MobileControlsScene"].forEach(s=>this.scene.stop(s)),this.player.searching=!1,this.player.inMenu=!1,this.bgMusic&&(this.bgMusic.stop(),this.bgMusic.destroy(),this.bgMusic=null),this._fromEditor?this.scene.start("LevelEditorScene"):t==="win"?this.scene.start("WinScene",{wallet:this.player.wallet??0,timeLeft:this.runTimer}):this.scene.start("GameOverScene",{wallet:this.player.wallet??0,reason:e})}}_toggleSettings(){if(!this._gameEnded){if(this.scene.isActive("InventoryScene")&&(this.player.inInventory=!1,this.scene.stop("InventoryScene")),this.scene.isActive("SearchScene")&&(this.player.searching=!1,this.scene.stop("SearchScene")),this.scene.isActive("PauseScene")){this.player.inMenu=!1,this.input.keyboard.enabled=!0,this.scene.stop("PauseScene");return}this.sound.play("sfx_menu",{volume:this.registry.get("sfxVol")??.5}),this.player.inMenu=!0,this.player.setVelocity(0,0),this.input.keyboard.enabled=!1,this.scene.launch("PauseScene",{fromScene:"GameScene",fromEditor:this._fromEditor})}}_interact(){if(this._gameEnded||this.player.searching||this._searchCooldown>0)return;if(this._transitZone&&!this._transitActive){this._startTransit();return}const t=this.lootSystem.nearestTarget;t&&(this.sound.play("sfx_menu",{volume:this.registry.get("sfxVol")??.5}),this.player.searching=!0,this.player.setVelocity(0,0),t.isHideoutChest?this.scene.launch("HideoutChestScene",{inventory:this.inventory,player:this.player,net:this.net}):this.scene.launch("SearchScene",{target:t,inventory:this.inventory,player:this.player,net:this.net}))}_openInventory(){this._gameEnded||this.player.searching||this.player.inInventory||(this.sound.play("sfx_menu",{volume:this.registry.get("sfxVol")??.5}),this.player.inInventory=!0,this.player.setVelocity(0,0),this.scene.launch("InventoryScene",{inventory:this.inventory,player:this.player}))}}const k=14,I=160,A=14;class ri extends Phaser.Scene{constructor(){super({key:"HUDScene"})}init(t){this.player=t.player,this.inventory=t.inventory}create(){this.add.text(k,k,"P1",{fontFamily:"monospace",fontSize:"13px",color:"#ff8800"}).setScrollFactor(0).setDepth(500),this.add.rectangle(k+22,k+4,I,A,3342336).setOrigin(0,.5).setScrollFactor(0).setDepth(500),this._hpFill=this.add.rectangle(k+22,k+4,I,A,16729088).setOrigin(0,.5).setScrollFactor(0).setDepth(501),this._hpText=this.add.text(k+22+I+8,k+4,"",{fontFamily:"monospace",fontSize:"11px",color:"#ffaa55"}).setOrigin(0,.5).setScrollFactor(0).setDepth(501),this._timerText=this.add.text(c/2,k+4,"2:00",{fontFamily:"monospace",fontSize:"22px",color:"#ffffff",stroke:"#000000",strokeThickness:3}).setOrigin(.5,.5).setScrollFactor(0).setDepth(501),this._ethIcon=this.add.text(c-k,k+4,"",{fontFamily:"monospace",fontSize:"14px",color:"#00ffcc",stroke:"#003322",strokeThickness:2}).setOrigin(1,.5).setScrollFactor(0).setDepth(501),this._invText=this.add.text(c-k,k+22,"",{fontFamily:"monospace",fontSize:"10px",color:"#8888aa"}).setOrigin(1,.5).setScrollFactor(0).setDepth(501),this.add.rectangle(k+22,k+22,I,A,3351040).setOrigin(0,.5).setScrollFactor(0).setDepth(500),this._stFill=this.add.rectangle(k+22,k+22,I,A,16772608).setOrigin(0,.5).setScrollFactor(0).setDepth(501),this._stText=this.add.text(k+22+I+8,k+22,"",{fontFamily:"monospace",fontSize:"11px",color:"#ffee88"}).setOrigin(0,.5).setScrollFactor(0).setDepth(501),this.add.rectangle(k+22,k+40,I,A,3346688).setOrigin(0,.5).setScrollFactor(0).setDepth(500),this._hgFill=this.add.rectangle(k+22,k+40,I,A,16746547).setOrigin(0,.5).setScrollFactor(0).setDepth(501),this._hgText=this.add.text(k+22+I+8,k+40,"",{fontFamily:"monospace",fontSize:"11px",color:"#ffbb88"}).setOrigin(0,.5).setScrollFactor(0).setDepth(501),this.add.rectangle(k+22,k+58,I,A,4403).setOrigin(0,.5).setScrollFactor(0).setDepth(500),this._thFill=this.add.rectangle(k+22,k+58,I,A,52479).setOrigin(0,.5).setScrollFactor(0).setDepth(501),this._thText=this.add.text(k+22+I+8,k+58,"",{fontFamily:"monospace",fontSize:"11px",color:"#88eeff"}).setOrigin(0,.5).setScrollFactor(0).setDepth(501);const t=this.registry.get("charName")??"";this._versionLabel=this.add.text(c-k,f-k,`${t}  v${Le}`,{fontFamily:"monospace",fontSize:"10px",color:"#555566",stroke:"#000000",strokeThickness:2}).setOrigin(1,1).setScrollFactor(0).setDepth(501),this._updateHP()}update(){if(!this.player)return;this._updateHP(),this._updateStamina(),this._updateHunger(),this._updateThirst();const t=this.scene.get("GameScene");if(!t||t._gameEnded)return;const e=Math.max(0,t.runTimer),s=Math.floor(e/60),i=Math.floor(e%60).toString().padStart(2,"0");this._timerText.setText(`${s}:${i}`),this._timerText.setColor(e<30?Math.floor(e*4)%2===0?"#ff2222":"#ffaa00":"#ffffff");const n=this.inventory?this.inventory.totalValue:this.player.wallet??0;if(this._ethIcon.setText(`◆ ${n} ETH`),this.inventory){const o=this.inventory.items.length,a=this.registry.get("inputMode")==="gp";this._invText.setText(`Bag: ${o} items  [${a?"Select":"TAB"}]`)}}_updateHP(){const t=Phaser.Math.Clamp(this.player.hp/this.player.maxHp,0,1),e=Math.max(0,Math.round(I*t));this._hpFill.setSize(e,A);const s=Math.round(Phaser.Math.Linear(0,255,1-t)),i=Math.round(Phaser.Math.Linear(255,0,1-t));this._hpFill.setFillStyle(Phaser.Display.Color.GetColor(s,i,34)),this._hpText.setText(`${this.player.hp}/${this.player.maxHp}`)}_updateStamina(){const t=Phaser.Math.Clamp(this.player.stamina/this.player.maxStamina,0,1);this._stFill.setSize(Math.max(0,Math.round(I*t)),A);const e=Math.round(Phaser.Math.Linear(255,255,1-t)),s=Math.round(Phaser.Math.Linear(238,68,1-t));this._stFill.setFillStyle(Phaser.Display.Color.GetColor(e,s,0)),this._stText.setText(`${Math.round(this.player.stamina)}/${this.player.maxStamina}`)}_updateHunger(){const t=Phaser.Math.Clamp(this.player.hunger/this.player.maxHunger,0,1);this._hgFill.setSize(Math.max(0,Math.round(I*t)),A);const e=Math.round(Phaser.Math.Linear(255,255,1-t)),s=Math.round(Phaser.Math.Linear(136,17,1-t));this._hgFill.setFillStyle(Phaser.Display.Color.GetColor(e,s,0)),this._hgText.setText(`${Math.round(this.player.hunger)}/${this.player.maxHunger}`)}_updateThirst(){const t=Phaser.Math.Clamp(this.player.thirst/this.player.maxThirst,0,1);this._thFill.setSize(Math.max(0,Math.round(I*t)),A);const e=0,s=Math.round(Phaser.Math.Linear(68,204,t)),i=Math.round(Phaser.Math.Linear(136,255,t));this._thFill.setFillStyle(Phaser.Display.Color.GetColor(e,s,i)),this._thText.setText(`${Math.round(this.player.thirst)}/${this.player.maxThirst}`)}}const L=200,qt=6;class hi extends Phaser.Scene{constructor(){super({key:"PauseScene"})}create(t){if(this._fromScene=t&&t.fromScene||"GameScene",this._fromEditor=!!(t&&t.fromEditor),this.add.rectangle(c/2,f/2,c,f,0,.7).setOrigin(.5),this.add.text(c/2,f*.08,"SETTINGS",{fontFamily:"monospace",fontSize:"40px",color:"#ff6600",stroke:"#000000",strokeThickness:4}).setOrigin(.5),this._sliders=[],this._activeSlider=0,this._buildSlider({y:f*.4,label:"MUSIC VOLUME",lsKey:"RAGEDERUE_music_vol",color:16737792,apply:s=>{for(const i of["GameScene","TitleScene"]){const n=this.scene.get(i);n&&n.bgMusic&&n.bgMusic.setVolume(s)}}}),this._buildSlider({y:f*.56,label:"SFX VOLUME",lsKey:"RAGEDERUE_sfx_vol",color:52479,apply:s=>{this.registry.set("sfxVol",s)}}),this._highlightSlider(),this.add.text(c/2,f*.68,"▲▼ select slider   ◄► adjust",{fontFamily:"monospace",fontSize:"11px",color:"#666666"}).setOrigin(.5),this._fromEditor){const s=this.add.text(c/2,f*.82,"[ RETOUR ÉDITEUR ]",{fontFamily:"monospace",fontSize:"18px",color:"#4488ff",stroke:"#000000",strokeThickness:3}).setOrigin(.5).setInteractive({useHandCursor:!0});s.on("pointerdown",()=>this._exitToEditor()),s.on("pointerover",()=>s.setColor("#88bbff")),s.on("pointerout",()=>s.setColor("#4488ff")),this.add.text(c/2,f*.88,"Touche  R  — quitter le test",{fontFamily:"monospace",fontSize:"11px",color:"#446688"}).setOrigin(.5)}if(N){const s=this._fromEditor?f*.74:f*.8,i=this.add.rectangle(c/2,s,200,36,3364215,.85).setStrokeStyle(2,8956620,.6).setInteractive({useHandCursor:!0});this.add.text(c/2,s,"⛶  PLEIN ÉCRAN",{fontFamily:"monospace",fontSize:"13px",color:"#ffffff",stroke:"#000",strokeThickness:3}).setOrigin(.5),i.on("pointerdown",()=>{this.scale.isFullscreen?this.scale.stopFullscreen():this.scale.startFullscreen()})}if(N){const s=this.add.rectangle(c/2,f*.9,160,36,8921634,.85).setStrokeStyle(2,16729156,.6).setInteractive({useHandCursor:!0});this.add.text(c/2,f*.9,"FERMER",{fontFamily:"monospace",fontSize:"14px",color:"#ffffff",stroke:"#000",strokeThickness:3}).setOrigin(.5),s.on("pointerdown",()=>this._resume())}const e=this.add.text(c/2,f*.94,N?"":"ESC / Start: fermer",{fontFamily:"monospace",fontSize:"11px",color:"#888888"}).setOrigin(.5);N||this.tweens.add({targets:e,alpha:.3,duration:600,yoyo:!0,repeat:-1}),this.input.keyboard.on("keydown-ESC",()=>this._resume()),this._kbUp=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP),this._kbDown=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN),this._kbLeft=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT),this._kbRight=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT),this._kbCd={horiz:0,vert:0},this._fromEditor&&this.input.keyboard.on("keydown-R",()=>this._exitToEditor()),this.input.gamepad.on("down",(s,i)=>{i.index===9&&this._resume()})}_buildSlider({y:t,label:e,lsKey:s,color:i,apply:n}){const o=c/2,a=parseFloat(localStorage.getItem(s)??"0.5"),r=o-L/2,l=this.add.text(o,t-22,e,{fontFamily:"monospace",fontSize:"14px",color:"#ff8800"}).setOrigin(.5),d=this.add.rectangle(o,t,L,qt,3355443).setOrigin(.5),_=this.add.rectangle(r,t,L*a,qt,i).setOrigin(0,.5),p=this.add.circle(r+L*a,t,10,16777215).setInteractive({draggable:!0,useHandCursor:!0}),y=this.add.text(o+L/2+30,t,`${Math.round(a*100)}%`,{fontFamily:"monospace",fontSize:"14px",color:"#cccccc"}).setOrigin(.5),u=S=>{_.width=L*S,p.x=r+L*S,y.setText(`${Math.round(S*100)}%`),localStorage.setItem(s,S.toFixed(2)),n(S)},m=this.add.rectangle(o,t,L+20,30,0,0).setOrigin(.5).setInteractive({useHandCursor:!0});let x=!1;const b=S=>{const P=(Phaser.Math.Clamp(S.x,r,r+L)-r)/L;g.vol=P,u(P),this._activeSlider=this._sliders.indexOf(g),this._highlightSlider()};m.on("pointerdown",S=>{x=!0,b(S)}),m.on("pointermove",S=>{x&&b(S)}),m.on("pointerup",()=>{x=!1}),m.on("pointerout",()=>{x=!1}),p.on("pointerdown",S=>{x=!0,b(S)}),this.input.on("drag",(S,w,P)=>{if(w!==p)return;const T=Phaser.Math.Clamp(P,r,r+L);p.x=T;const st=(T-r)/L;g.vol=st,u(st)});const g={vol:a,applyVol:u,trackX:r,lbl:l,knob:p,fill:_,track:d,pct:y,hitZone:m};this._sliders.push(g),n(a)}_highlightSlider(){this._sliders&&this._sliders.forEach((t,e)=>{const s=e===this._activeSlider;t.lbl.setColor(s?"#ffcc00":"#ff8800"),t.knob.setFillStyle(s?16763904:16777215)})}update(t,e){if(!this._sliders||this._sliders.length===0)return;this._kbCd.horiz-=e,this._kbCd.vert-=e;const s=this.input.gamepad,i=s&&s.total>0?s.getPad(0):null,n=.2,o=this._kbUp?.isDown,a=this._kbDown?.isDown,r=this._kbLeft?.isDown,l=this._kbRight?.isDown,d=i&&(i.up||i.leftStick.y<-n),_=i&&(i.down||i.leftStick.y>n),p=i&&(i.left||i.leftStick.x<-n),y=i&&(i.right||i.leftStick.x>n);let u=0;(o||d)&&this._kbCd.vert<=0&&(u=-1,this._kbCd.vert=220),(a||_)&&this._kbCd.vert<=0&&(u=1,this._kbCd.vert=220),u!==0&&(this._activeSlider=Phaser.Math.Clamp(this._activeSlider+u,0,this._sliders.length-1),this._highlightSlider()),!o&&!a&&!d&&!_&&(this._kbCd.vert=0);let m=0;if((r||p)&&(m=-1),(l||y)&&(m=1),i&&Math.abs(i.leftStick.x)>n&&(m=i.leftStick.x),m!==0){const x=this._sliders[this._activeSlider],b=Phaser.Math.Clamp(x.vol+m*.8*(e/1e3),0,1);x.vol=b,x.applyVol(b)}}_resume(){if(this._fromScene==="GameScene"){const t=this.scene.get("GameScene");t&&(t.player&&(t.player.inMenu=!1),t.input.keyboard.enabled=!0)}this.scene.stop()}_exitToEditor(){const t=this.scene.get("GameScene");t&&(t.input.keyboard.enabled=!0,t.player&&(t.player.inMenu=!1,t._endGame("over",""))),this.scene.stop()}}const H=48,E=2,re=6,he=4,le=re*(H+E)+E,ut=he*(H+E)+E,Ot=Math.round((c-le)/2),ht=Math.round((f-ut)/2)-20,C=0,St=1,kt=[{key:"punchSkill",label:"Poings",icon:"👊",bonusLabel:"dmg poings"},{key:"kickSkill",label:"Pieds",icon:"🦵",bonusLabel:"dmg pieds"},{key:"jabSkill",label:"Jab",icon:"⚡",bonusLabel:"dmg jab"},{key:"moveSkill",label:"Vitesse",icon:"🏃",bonusLabel:"vitesse"},{key:"lootSkill",label:"Loot",icon:"📦",bonusLabel:"-20ms/lv ident."},{key:"healSkill",label:"Soins",icon:"💊",bonusLabel:"efficacité soins"},{key:"eatSkill",label:"Manger",icon:"🍕",bonusLabel:"efficacité nourriture"}];class li extends Phaser.Scene{constructor(){super({key:"InventoryScene"})}init(t){this.inventory=t.inventory,this.player=t.player}create(){this._hpSnapshot=this.player.hp,this._activeTab=C,this.add.rectangle(c/2,f/2,c,f,0,.65);const t=["INVENTAIRE","STATS"],e=130,s=c/2-e/2;this._tabLabels=[];for(let i=0;i<t.length;i++){const n=this.add.text(s+i*e,22,t[i],{fontFamily:"monospace",fontSize:"13px",color:"#888888",stroke:"#000",strokeThickness:3}).setOrigin(.5).setInteractive({useHandCursor:!0});n.on("pointerdown",()=>this._switchTab(i)),this._tabLabels.push(n)}this._tabGroups=[[],[]],this._buildInventoryTab(),this._buildStatsTab(),this._switchTab(C),N&&this.add.text(c-20,18,"✕",{fontFamily:"monospace",fontSize:"22px",color:"#ff4444",stroke:"#000",strokeThickness:3}).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this._close()),this._hintText=this.add.text(c/2,f-16,"",{fontFamily:"monospace",fontSize:"10px",color:"#666666"}).setOrigin(.5),this._refreshHint(),this.input.keyboard.on("keydown-TAB",()=>{this.registry.set("inputMode","kb"),this._activeTab===C?this._switchTab(St):this._close()}),this.input.keyboard.on("keydown-ESC",()=>{this.registry.set("inputMode","kb"),this._close()}),this.input.keyboard.on("keydown-LEFT",()=>{this.registry.set("inputMode","kb"),this._activeTab===C&&this._move(-1,0)}),this.input.keyboard.on("keydown-RIGHT",()=>{this.registry.set("inputMode","kb"),this._activeTab===C&&this._move(1,0)}),this.input.keyboard.on("keydown-UP",()=>{this.registry.set("inputMode","kb"),this._activeTab===C&&this._move(0,-1)}),this.input.keyboard.on("keydown-DOWN",()=>{this.registry.set("inputMode","kb"),this._activeTab===C&&this._move(0,1)}),this.input.keyboard.on("keydown-X",()=>{this.registry.set("inputMode","kb"),this._activeTab===C&&this._useSelected()}),this._gpCooldown=0,this.input.gamepad.on("down",(i,n)=>{this.registry.set("inputMode","gp"),n.index===8&&this._close(),(n.index===4||n.index===5)&&this._switchTab(this._activeTab===C?St:C),n.index===0&&this._activeTab===C&&this._useSelected()})}update(t,e){if(this.player.hp<this._hpSnapshot||this.player.state==="hurt"||this.player.state==="dead"){this._forceClose();return}this._refreshHint(),this._gpCooldown-=e;const s=this.input.gamepad;if(s&&s.total>0&&this._gpCooldown<=0&&this._activeTab===C){const i=s.getPad(0);if(i){let o=0,a=0;(i.left||i.leftStick.x<-.4)&&(o=-1),(i.right||i.leftStick.x>.4)&&(o=1),(i.up||i.leftStick.y<-.4)&&(a=-1),(i.down||i.leftStick.y>.4)&&(a=1),(o||a)&&(this.registry.set("inputMode","gp"),this._move(o,a),this._gpCooldown=180)}}}_switchTab(t){this._activeTab=t;for(let e=0;e<this._tabGroups.length;e++){const s=e===t;for(const i of this._tabGroups[e])i.setVisible(s);this._tabLabels[e].setColor(s?"#ff8800":"#888888")}t===St&&this._refreshStats()}_buildInventoryTab(){const t=this._tabGroups[C],e=this.add.graphics();e.fillStyle(1710638,.9),e.fillRect(Ot-4,ht-4,le+8,ut+8);for(let s=0;s<he;s++)for(let i=0;i<re;i++){const n=Ot+E+i*(H+E),o=ht+E+s*(H+E);e.fillStyle(3355477,.7),e.fillRect(n,o,H,H)}t.push(e),this._itemSprites=[],this._selectedIdx=0,this._drawItems(t),this._cursor=this.add.rectangle(0,0,H,H).setStrokeStyle(2,16777215,1).setFillStyle(16777215,.1),this.tweens.add({targets:this._cursor,alpha:.5,duration:400,yoyo:!0,repeat:-1}),t.push(this._cursor),this._updateCursor(),this._infoText=this.add.text(c/2,ht+ut+14,"",{fontFamily:"monospace",fontSize:"12px",color:"#cccccc",align:"center"}).setOrigin(.5,0),t.push(this._infoText),this._updateInfo(),this._useBarBg=this.add.rectangle(c/2,ht+ut+52,160,10,3355443).setOrigin(.5).setVisible(!1),this._useBarFill=this.add.rectangle(c/2-80,ht+ut+52,0,10,65416).setOrigin(0,.5).setVisible(!1),this._isUsing=!1,t.push(this._useBarBg),t.push(this._useBarFill)}_drawItems(t){for(const e of this.inventory.items){const s=Ot+E+e.gridX*(H+E),i=ht+E+e.gridY*(H+E),n=e.def.invW*H+(e.def.invW-1)*E,o=e.def.invH*H+(e.def.invH-1)*E,a=this.add.rectangle(s+n/2,i+o/2,n,o,e.def.glowColor,.2).setStrokeStyle(1,e.def.glowColor,.5),r=e.identified?e.def.texture:null;let l;r?l=this.add.image(s+n/2,i+o/2,r).setDisplaySize(Math.min(n-8,e.def.displayW),Math.min(o-8,e.def.displayH)):l=this.add.text(s+n/2,i+o/2,"?",{fontFamily:"monospace",fontSize:"28px",color:"#888888"}).setOrigin(.5),a.setInteractive();const d=this._itemSprites.length;a.on("pointerdown",()=>{this._selectedIdx===d?this._useSelected():(this._selectedIdx=d,this._updateCursor(),this._updateInfo())}),this._itemSprites.push({item:e,bg:a,icon:l,cx:s,cy:i,w:n,h:o}),t&&(t.push(a),t.push(l))}}_buildStatsTab(){const t=this._tabGroups[St],e=c/2,s=180,i=44,n=46,o=this.add.text(e,n,"COMPÉTENCES",{fontFamily:"monospace",fontSize:"13px",color:"#ff8800",stroke:"#000",strokeThickness:2}).setOrigin(.5);t.push(o),this._skillRows=[];for(let a=0;a<kt.length;a++){const r=kt[a],l=n+18+a*i,d=this.add.rectangle(e,l+i/2,380,i-4,1118498,.7).setStrokeStyle(1,3355477,.5);t.push(d);const _=this.add.text(e-165,l+i/2-6,`${r.icon} ${r.label}`,{fontFamily:"monospace",fontSize:"12px",color:"#cccccc"}).setOrigin(0,.5);t.push(_);const p=this.add.text(e-42,l+i/2-6,"lv 0",{fontFamily:"monospace",fontSize:"11px",color:"#ffcc00"}).setOrigin(.5,.5);t.push(p);const y=this.add.rectangle(e+18,l+i/2-6,s,7,2236996).setOrigin(0,.5);t.push(y);const u=this.add.rectangle(e+18,l+i/2-6,0,7,4482815).setOrigin(0,.5);t.push(u);const m=this.add.text(e+18,l+i/2+6,"aucun bonus",{fontFamily:"monospace",fontSize:"9px",color:"#6688aa"}).setOrigin(0,.5);t.push(m),this._skillRows.push({lvlTxt:p,barFill:u,bonusTxt:m,barW:s})}}_refreshStats(){const t=this.player;if(!(!t||!this._skillRows))for(let e=0;e<kt.length;e++){const s=kt[e],i=this._skillRows[e];let o=t.skills?.[s.key]??0,a=0;for(;o>=Math.round(100*Math.pow(a+1,1.5))&&(o-=Math.round(100*Math.pow(a+1,1.5)),a++,!(a>=50)););const r=Math.round(100*Math.pow(a+1,1.5)),l=a>=50?1:o/r;i.lvlTxt.setText(`lv ${a}`),i.barFill.setSize(Math.round(i.barW*l),7);const d=Math.min(a/20,1),_=Math.round(Phaser.Math.Linear(68,255,d)),p=Math.round(Phaser.Math.Linear(102,204,d)),y=Math.round(Phaser.Math.Linear(255,0,d));i.barFill.setFillStyle(Phaser.Display.Color.GetColor(_,p,y));const u=a*2;s.key==="lootSkill"?i.bonusTxt.setText(a>0?`-${a*20}ms identification`:"aucun bonus"):i.bonusTxt.setText(u>0?`+${u}% ${s.bonusLabel}`:"aucun bonus")}}_refreshHint(){const t=this.registry.get("inputMode")==="gp";this._activeTab===C?this._hintText.setText(t?"D-Pad: naviguer   A: utiliser   LB/RB: stats   Select: fermer":"Flèches: naviguer   X: utiliser   TAB: stats   ESC: fermer"):this._hintText.setText(t?"LB/RB: inventaire   Select: fermer":"TAB: inventaire   ESC: fermer")}_move(t,e){if(this._isUsing||this._itemSprites.length===0)return;const s=this._itemSprites[this._selectedIdx]?.item;if(!s){this._selectedIdx=0,this._updateCursor(),this._updateInfo();return}let i=this._selectedIdx,n=1/0;const o=s.gridX+s.def.invW/2,a=s.gridY+s.def.invH/2;for(let r=0;r<this._itemSprites.length;r++){if(r===this._selectedIdx)continue;const l=this._itemSprites[r].item,d=l.gridX+l.def.invW/2,_=l.gridY+l.def.invH/2,p=d-o,y=_-a;if(t!==0&&Math.sign(p)!==Math.sign(t)||e!==0&&Math.sign(y)!==Math.sign(e)||t!==0&&e===0&&Math.abs(y)>1.5||e!==0&&t===0&&Math.abs(p)>1.5)continue;const u=Math.abs(p)+Math.abs(y);u<n&&(n=u,i=r)}this._selectedIdx=i,this._updateCursor(),this._updateInfo()}_updateCursor(){if(this._itemSprites.length===0){this._cursor.setVisible(!1);return}this._cursor.setVisible(this._activeTab===C);const t=this._itemSprites[this._selectedIdx];this._cursor.setPosition(t.cx+t.w/2,t.cy+t.h/2),this._cursor.setSize(t.w+4,t.h+4)}_updateInfo(){if(this._itemSprites.length===0){this._infoText.setText("Inventaire vide");return}const t=this._itemSprites[this._selectedIdx]?.item;if(t)if(!t.identified)this._infoText.setText("??? — Objet non identifié");else{const e=t.def.useTime>0?`  [${(t.def.useTime/1e3).toFixed(1)}s]`:"";this._infoText.setText(`${t.def.description}${e}`)}}_useSelected(){if(this._isUsing||this._itemSprites.length===0)return;const t=this._itemSprites[this._selectedIdx];if(!t)return;const e=t.item;e.identified&&(e.def.useTime<=0&&!e.def.healAmount&&!e.def.hungerRestore&&!e.def.thirstRestore||(this._isUsing=!0,this._useBarBg.setVisible(!0),this._useBarFill.setVisible(!0).setSize(0,10),this.tweens.add({targets:this._useBarFill,width:160,duration:e.def.useTime,ease:"Linear",onComplete:()=>{this.inventory.useItem(e,this.player),this._isUsing=!1,this._useBarBg.setVisible(!1),this._useBarFill.setVisible(!1),this._rebuild()}})))}_rebuild(){const t=this._tabGroups[C];for(const e of this._itemSprites){e.bg.destroy(),e.icon.destroy();const s=t.indexOf(e.bg);s!==-1&&t.splice(s,1);const i=t.indexOf(e.icon);i!==-1&&t.splice(i,1)}this._itemSprites=[],this._selectedIdx=0,this._drawItems(t),this._updateCursor(),this._updateInfo()}_close(){this._isUsing||(this.registry.set("inventoryClosedAt",Date.now()),this.player.inInventory=!1,this.scene.stop())}_forceClose(){this.tweens.killAll(),this._isUsing=!1,this.registry.set("inventoryClosedAt",Date.now()),this.player.inInventory=!1,this.scene.stop()}}const F=340,Bt=260,Qt=Math.round((c-F)/2),nt=Math.round((f-Bt)/2)-20,wt=36,Rt=nt+70;class ci extends Phaser.Scene{constructor(){super({key:"SearchScene"})}init(t){this.target=t.target,this.inventory=t.inventory,this.player=t.player,this.net=t.net,this._targetKind=this.target.image?0:1,this._targetId=this.target.netId??0}create(){if(this.registry.get("inputMode"),this.add.rectangle(c/2,f/2,c,f,0,.6),this.add.rectangle(c/2,f/2-20,F+8,Bt+8,1118498,.95).setStrokeStyle(2,5592490,.8),this._title=this.add.text(c/2,nt+16,"Searching…",{fontFamily:"monospace",fontSize:"16px",color:"#ffaa00",stroke:"#000",strokeThickness:3}).setOrigin(.5),this._barBg=this.add.rectangle(c/2,nt+45,F-40,12,3355443).setOrigin(.5),this._barFill=this.add.rectangle(c/2-(F-40)/2,nt+45,0,12,3386111).setOrigin(0,.5),N){const t=this.add.circle(Qt+F-6,nt+6,18,11149858,.9).setStrokeStyle(2,16729156,.8).setInteractive({useHandCursor:!0});this.add.text(Qt+F-6,nt+6,"✕",{fontFamily:"monospace",fontSize:"18px",color:"#ffffff",stroke:"#000",strokeThickness:3}).setOrigin(.5),t.on("pointerdown",()=>this._tryClose())}this._hint=this.add.text(c/2,nt+Bt-10,"",{fontFamily:"monospace",fontSize:"9px",color:"#555577"}).setOrigin(.5),this._refreshHint(),this._phase="opening",this._itemRows=[],this._selectedIdx=0,this._identifyIdx=0,this._revealedItems=[],this._cursor=null,this._hpSnapshot=this.player.hp,this.target.opened?(this._barBg.setVisible(!1),this._barFill.setVisible(!1),this._skipToReady()):this.tweens.add({targets:this._barFill,width:F-40,duration:Xs,ease:"Linear",onComplete:()=>this._beginIdentify()}),this.input.keyboard.on("keydown-E",()=>{this.registry.set("inputMode","kb"),this._tryClose()}),this.input.keyboard.on("keydown-TAB",()=>{this.registry.set("inputMode","kb"),this._tryClose()}),this.input.keyboard.on("keydown-ESC",()=>{this.registry.set("inputMode","kb"),this._tryClose()}),this.input.keyboard.on("keydown-UP",()=>{this.registry.set("inputMode","kb"),this._moveSel(-1)}),this.input.keyboard.on("keydown-DOWN",()=>{this.registry.set("inputMode","kb"),this._moveSel(1)}),this.input.keyboard.on("keydown-X",()=>{this.registry.set("inputMode","kb"),this._takeSelected()}),this.input.keyboard.on("keydown-C",()=>{this.registry.set("inputMode","kb")}),this._gpCooldown=0,this.input.gamepad.on("down",(t,e)=>{this.registry.set("inputMode","gp"),e.index===0&&this._takeSelected(),e.index===1&&this._tryClose(),e.index===3&&this._tryClose(),e.index===8&&this._tryClose()})}update(t,e){if(this._refreshHint(),this.player.hp<this._hpSnapshot||this.player.state==="hurt"){this._forceClose();return}this._hpSnapshot=this.player.hp,this._gpCooldown-=e;const s=this.input.gamepad;if(s&&s.total>0&&this._gpCooldown<=0){const i=s.getPad(0);if(i){let o=0;(i.up||i.leftStick.y<-.4)&&(o=-1),(i.down||i.leftStick.y>.4)&&(o=1),o&&(this.registry.set("inputMode","gp"),this._moveSel(o),this._gpCooldown=180)}}}_refreshHint(){if(N){this._hint.setText("Tap item to take   ✕ to close");return}const t=this.registry.get("inputMode")==="gp";this._hint.setText(t?"A: take   B: close":"X: take   E / TAB: close")}_skipToReady(){if(this._title.setText("Items found"),this._phase="ready",this._revealedItems=this.target.lootItems.map(t=>({type:t,identified:!0,taken:!1})),this._revealedItems.length===0){this._title.setText("Empty");return}this._drawRows(),this._revealedItems.forEach((t,e)=>this._refreshRow(e))}_beginIdentify(){if(this._barBg.setVisible(!1),this._barFill.setVisible(!1),this._title.setText("Items found"),this._phase="identifying",this.target.opened=!0,this._revealedItems=this.target.lootItems.map(t=>({type:t,identified:!1,taken:!1})),this._revealedItems.length===0){this._title.setText("Empty"),this._phase="ready";return}this._drawRows(),this._identifyIdx=0,this._identifyNext()}_identifyNext(){if(this._identifyIdx>=this._revealedItems.length){this._phase="ready";return}const t=this._identifyIdx,e=this.player?._skillLevel?.("lootSkill")??0,s=Math.max(100,Ys-e*20);this.time.delayedCall(s,()=>{this.scene.isActive()&&(this._revealedItems[t].identified=!0,this._refreshRow(t),this._identifyIdx++,this._identifyNext())})}_drawRows(){for(let t=0;t<this._revealedItems.length;t++){const e=Rt+t*wt,s=this.add.rectangle(c/2,e,F-20,wt-4,2236996,.6).setStrokeStyle(1,4473958,.4);N&&(s.setInteractive({useHandCursor:!0}),s.on("pointerdown",()=>{this._selectedIdx===t?this._takeSelected():(this._selectedIdx=t,this._updateCursorPos())}));const i=this.add.text(c/2-F/2+30,e,"?",{fontFamily:"monospace",fontSize:"18px",color:"#666"}).setOrigin(.5),n=this.add.text(c/2-F/2+60,e,"???",{fontFamily:"monospace",fontSize:"12px",color:"#888"}).setOrigin(0,.5),o=this.add.text(c/2+F/2-25,e,"",{fontFamily:"monospace",fontSize:"10px",color:"#555"}).setOrigin(1,.5);this._itemRows.push({bg:s,icon:i,label:n,status:o,ry:e})}this._cursor=this.add.rectangle(c/2,Rt,F-16,wt-2).setStrokeStyle(2,16777215,.9).setFillStyle(16777215,.05),this.tweens.add({targets:this._cursor,alpha:.5,duration:400,yoyo:!0,repeat:-1}),this._selectedIdx=0,this._updateCursorPos()}_refreshRow(t){const e=this._itemRows[t],s=this._revealedItems[t];if(e){if(s.taken)e.icon.setText("✓").setColor("#00cc44"),e.label.setText("Taken").setColor("#44aa44"),e.status.setText(""),e.bg.setFillStyle(1127185,.4);else if(s.identified){const i=et[s.type];i.texture&&this.textures.exists(i.texture)?(e.icon.setVisible(!1),this.add.image(e.icon.x,e.ry,i.texture).setDisplaySize(24,24)):e.icon.setText(s.type.charAt(0).toUpperCase()).setColor("#"+i.glowColor.toString(16).padStart(6,"0")),e.label.setText(i.description).setColor("#cccccc")}}}_updateCursorPos(){!this._cursor||this._itemRows.length===0||this._cursor.setY(Rt+this._selectedIdx*wt)}_moveSel(t){this._phase!=="opening"&&this._revealedItems.length!==0&&(this._selectedIdx=Phaser.Math.Clamp(this._selectedIdx+t,0,this._revealedItems.length-1),this._updateCursorPos())}_takeSelected(){if(this._phase==="opening")return;const t=this._revealedItems[this._selectedIdx];if(!(!t||t.taken)){if(!t.identified){const e=this._itemRows[this._selectedIdx];e.status.setText("???").setColor("#ffaa00"),this.time.delayedCall(600,()=>{e.status.active&&e.status.setText("")});return}if(!this.inventory.hasRoom(t.type)){const e=this._itemRows[this._selectedIdx];e.status.setText("FULL").setColor("#ff3333"),this.time.delayedCall(800,()=>{e.status.active&&e.status.setText("")});return}if(this.inventory.addItem(t.type,t.identified),t.taken=!0,this._refreshRow(this._selectedIdx),this.net?.sendSkillGain&&this.net.sendSkillGain("lootSkill",5),this.net){let e=0;for(let s=0;s<this._selectedIdx;s++)this._revealedItems[s].taken||e++;this.net.sendTakeItem(this._targetKind,this._targetId,e)}}}_tryClose(){if(this._phase==="opening")return;(this._revealedItems.length===0||this._revealedItems.every(e=>e.taken))&&this.target.markSearched(),this._doClose()}_forceClose(){this._doClose()}_doClose(){this.player.searching=!1,this.scene.stop()}}const v=280,Tt=320,dt=16,di=v*2+dt,j=Math.round((c-di)/2),ot=Math.round((f-Tt)/2)-20,X=26,Q=ot+60,B=9,te=18,pi=12,fi=28,ee={argent:0,soin:1,divers:2};function se(h){return[...h].sort((t,e)=>{const s=ee[et[t]?.category]??99,i=ee[et[e]?.category]??99;return s!==i?s-i:t.localeCompare(e)})}class _i extends Phaser.Scene{constructor(){super({key:"HideoutChestScene"})}init(t){this.inventory=t.inventory,this.player=t.player,this._net=t.net??null}create(){if(this._chestItems=(this.registry.get("chestItems")??[]).slice(),this._activePanel="player",this._playerSel=0,this._chestSel=0,this._playerScroll=0,this._chestScroll=0,this.add.rectangle(c/2,f/2,c,f,0,.65),this._boxPlayer=this.add.rectangle(j+v/2,f/2-20,v+8,Tt+8,1118498,.95).setStrokeStyle(2,5592490,.8),this._boxChest=this.add.rectangle(j+v+dt+v/2,f/2-20,v+8,Tt+8,1118498,.95).setStrokeStyle(2,5592490,.8),this._titlePlayer=this.add.text(j+v/2,ot+18,"INVENTAIRE",{fontFamily:"monospace",fontSize:"14px",color:"#ffaa00",stroke:"#000",strokeThickness:3}).setOrigin(.5),this._titleChest=this.add.text(j+v+dt+v/2,ot+18,"COFFRE",{fontFamily:"monospace",fontSize:"14px",color:"#ffaa00",stroke:"#000",strokeThickness:3}).setOrigin(.5),this._countPlayer=this.add.text(j+v/2,ot+38,"",{fontFamily:"monospace",fontSize:"10px",color:"#777799"}).setOrigin(.5),this._countChest=this.add.text(j+v+dt+v/2,ot+38,"",{fontFamily:"monospace",fontSize:"10px",color:"#777799"}).setOrigin(.5),N){this.add.text(c-20,ot+10,"✕",{fontFamily:"monospace",fontSize:"22px",color:"#ff4444",stroke:"#000",strokeThickness:3}).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this._doClose());const e=f/2,s=this.add.rectangle(c/2,e,44,36,2263125,.85).setStrokeStyle(2,65484,.6).setInteractive({useHandCursor:!0});this.add.text(c/2,e,"⇄",{fontFamily:"monospace",fontSize:"18px",color:"#ffffff"}).setOrigin(.5),s.on("pointerdown",()=>this._transfer())}this._hint=this.add.text(c/2,ot+Tt-4,"",{fontFamily:"monospace",fontSize:"9px",color:"#555577"}).setOrigin(.5),this._cursorPlayer=this.add.rectangle(0,0,v-16,X-2).setStrokeStyle(2,16777215,.9).setFillStyle(16777215,.05).setVisible(!1),this.tweens.add({targets:this._cursorPlayer,alpha:.5,duration:400,yoyo:!0,repeat:-1}),this._cursorChest=this.add.rectangle(0,0,v-16,X-2).setStrokeStyle(2,65484,.9).setFillStyle(65484,.04).setVisible(!1),this.tweens.add({targets:this._cursorChest,alpha:.5,duration:400,yoyo:!0,repeat:-1}),this._rowObjs={player:[],chest:[]},this._redraw(),this._updateFocus(),this.input.keyboard.on("keydown-UP",()=>{this.registry.set("inputMode","kb"),this._moveSel(-1)}),this.input.keyboard.on("keydown-DOWN",()=>{this.registry.set("inputMode","kb"),this._moveSel(1)}),this.input.keyboard.on("keydown-LEFT",()=>{this.registry.set("inputMode","kb"),this._switchPanel("player")}),this.input.keyboard.on("keydown-RIGHT",()=>{this.registry.set("inputMode","kb"),this._switchPanel("chest")}),this.input.keyboard.on("keydown-TAB",()=>{this.registry.set("inputMode","kb"),this._togglePanel()}),this.input.keyboard.on("keydown-X",()=>{this.registry.set("inputMode","kb"),this._transfer()}),this.input.keyboard.on("keydown-E",()=>{this.registry.set("inputMode","kb"),this._doClose()}),this.input.keyboard.on("keydown-ESC",()=>{this.registry.set("inputMode","kb"),this._doClose()}),this._gpCooldown=0,this.input.gamepad.on("down",(t,e)=>{this.registry.set("inputMode","gp"),e.index===0&&this._transfer(),e.index===1&&this._doClose(),e.index===3&&this._doClose(),e.index===4&&this._switchPanel("player"),e.index===5&&this._switchPanel("chest")})}update(t,e){this._gpCooldown-=e;const s=this.registry.get("inputMode")==="gp";if(this._hint.setText(s?"A: transférer   B: fermer   LB/RB: panneau":"X: transférer   E: fermer   TAB: panneau"),s&&this.input.gamepad.total>0&&this._gpCooldown<=0){const i=this.input.gamepad.getPad(0);if(i){let o=0;(i.up||i.leftStick.y<-.4)&&(o=-1),(i.down||i.leftStick.y>.4)&&(o=1),o&&(this.registry.set("inputMode","gp"),this._moveSel(o),this._gpCooldown=180)}}}_togglePanel(){this._switchPanel(this._activePanel==="player"?"chest":"player")}_switchPanel(t){this._activePanel=t,this._updateFocus()}_moveSel(t){if(this._activePanel==="player"){const e=this._playerItems();this._playerSel=Phaser.Math.Clamp(this._playerSel+t,0,Math.max(0,e.length-1)),this._updateScrollPlayer(e.length)}else this._chestSel=Phaser.Math.Clamp(this._chestSel+t,0,Math.max(0,this._chestItems.length-1)),this._updateScrollChest(this._chestItems.length);this._updateFocus(),this._redraw()}_updateScrollPlayer(t){this._playerSel<this._playerScroll&&(this._playerScroll=this._playerSel),this._playerSel>=this._playerScroll+B&&(this._playerScroll=this._playerSel-B+1),this._playerScroll=Phaser.Math.Clamp(this._playerScroll,0,Math.max(0,t-B))}_updateScrollChest(t){this._chestSel<this._chestScroll&&(this._chestScroll=this._chestSel),this._chestSel>=this._chestScroll+B&&(this._chestScroll=this._chestSel-B+1),this._chestScroll=Phaser.Math.Clamp(this._chestScroll,0,Math.max(0,t-B))}_transfer(){if(this._activePanel==="player"){const t=this._playerItems();if(t.length===0)return;const e=t[this._playerSel];if(!e)return;this.inventory.removeItem(e),this._chestItems.push(e.type),this._playerSel=Math.min(this._playerSel,Math.max(0,this._playerItems().length-1))}else{if(this._chestItems.length===0)return;const e=se(this._chestItems)[this._chestSel];if(!e||!this.inventory.hasRoom(e))return;const s=this._chestItems.indexOf(e);this._chestItems.splice(s,1),this.inventory.addItem(e,!0),this._chestSel=Math.min(this._chestSel,Math.max(0,this._chestItems.length-1))}this._saveChest(),this._redraw(),this._updateFocus()}_playerItems(){return this.inventory.items}_redraw(){for(const r of["player","chest"]){for(const l of this._rowObjs[r])l.destroy();this._rowObjs[r]=[]}const t=this._playerItems();this._countPlayer.setText(`${t.length} objet(s)`),this._countChest.setText(`${this._chestItems.length} objet(s)`);const e=(r,l,d,_,p,y,u,m)=>{const x=r==="player"?2241365:1717026,b=this.add.rectangle(l+v/2,y,v-20,X-3,u?x:1710643,u?.9:.6).setStrokeStyle(1,3359846,.4).setInteractive();b.on("pointerdown",()=>{const w=r==="player"?"_playerSel":"_chestSel";this._activePanel===r&&this[w]===m?this._transfer():(this._activePanel=r,this[w]=m,this._updateFocus(),this._redraw())});const g=this.add.image(l+pi,y,_).setDisplaySize(te,te).setOrigin(.5,.5),S=this.add.text(l+fi,y,p,{fontFamily:"monospace",fontSize:"10px",color:r==="player"?"#ccccdd":"#ccddcc"}).setOrigin(0,.5);this._rowObjs[r].push(b,g,S)},s=j;t.slice(this._playerScroll,this._playerScroll+B).forEach((r,l)=>{const d=Q+l*X,_=l+this._playerScroll,p=et[r.type]??{},y=_===this._playerSel&&this._activePanel==="player";e("player",s,r.type,p.texture??"barrel",p.description??r.type,d,y,_)}),this._playerScroll>0&&this._rowObjs.player.push(this.add.text(s+v-14,Q,"▲",{fontFamily:"monospace",fontSize:"10px",color:"#555577"}).setOrigin(1,.5)),this._playerScroll+B<t.length&&this._rowObjs.player.push(this.add.text(s+v-14,Q+(B-1)*X,"▼",{fontFamily:"monospace",fontSize:"10px",color:"#555577"}).setOrigin(1,.5));const n=j+v+dt;se(this._chestItems).slice(this._chestScroll,this._chestScroll+B).forEach((r,l)=>{const d=Q+l*X,_=l+this._chestScroll,p=et[r]??{},y=_===this._chestSel&&this._activePanel==="chest";e("chest",n,r,p.texture??"barrel",p.description??r,d,y,_)}),this._chestScroll>0&&this._rowObjs.chest.push(this.add.text(n+v-14,Q,"▲",{fontFamily:"monospace",fontSize:"10px",color:"#555577"}).setOrigin(1,.5)),this._chestScroll+B<this._chestItems.length&&this._rowObjs.chest.push(this.add.text(n+v-14,Q+(B-1)*X,"▼",{fontFamily:"monospace",fontSize:"10px",color:"#555577"}).setOrigin(1,.5))}_updateFocus(){const t=this._playerItems();if(this._activePanel==="player"&&t.length>0){const i=this._playerSel-this._playerScroll,n=j+v/2;this._cursorPlayer.setPosition(n,Q+i*X).setVisible(!0)}else this._cursorPlayer.setVisible(!1);if(this._activePanel==="chest"&&this._chestItems.length>0){const i=this._chestSel-this._chestScroll,n=j+v+dt+v/2;this._cursorChest.setPosition(n,Q+i*X).setVisible(!0)}else this._cursorChest.setVisible(!1);const e="#00ffcc",s="#ffaa00";this._titlePlayer.setColor(this._activePanel==="player"?e:s),this._titleChest.setColor(this._activePanel==="chest"?e:s)}_saveChest(){if(this.registry.set("chestItems",this._chestItems.slice()),this._net&&this._net.connected){const t=this.registry.get("charId")??"";this._net.sendChestSave(t,this._chestItems)}}_doClose(){this._saveChest(),this.player.searching=!1,this.scene.stop()}}const At=70,ui=34,lt=100,ct=f-100,It=36,Lt=10,yi=c-110,mi=f-100,gi=[{key:"punch",label:"P",dx:0,dy:-It-Lt,color:15615044},{key:"kick",label:"K",dx:It+Lt,dy:0,color:15632384},{key:"jab",label:"J",dx:-46,dy:0,color:13421568},{key:"jump",label:"↑",dx:0,dy:It+Lt,color:4508740}],Y={key:"interact",label:"E",x:c-200,y:f-42,r:26,color:5605631},K={key:"inventory",label:"INV",x:c-42,y:36,r:24,color:8947848},J=.35,xi=.8;class bi extends Phaser.Scene{constructor(){super({key:"MobileControlsScene"})}init(t){this._player=t.player,this._onInteract=t.onInteract??(()=>{}),this._onInventory=t.onInventory??(()=>{}),this._onPause=t.onPause??(()=>{})}create(){this.input.addPointer(1),this._joyActive=!1,this._joyPointerId=-1,this._joyOrigin={x:lt,y:ct},this._joyVec={x:0,y:0},this._joyRing=this.add.circle(lt,ct,At,16777215,.12).setDepth(2e3).setScrollFactor(0),this.add.circle(lt,ct,At,0,0).setStrokeStyle(2,16777215,J).setDepth(2001).setScrollFactor(0),this._joyKnob=this.add.circle(lt,ct,ui,16777215,J).setDepth(2002).setScrollFactor(0),this._btnObjs={};for(const i of gi){const n=yi+i.dx,o=mi+i.dy,a=this.add.circle(n,o,It,i.color,J).setDepth(2002).setScrollFactor(0).setInteractive(),r=this.add.text(n,o,i.label,{fontFamily:"monospace",fontSize:"18px",color:"#ffffff",stroke:"#000",strokeThickness:3}).setOrigin(.5).setDepth(2003).setScrollFactor(0);this._btnObjs[i.key]={circle:a,label:r,def:i},this._setupButton(a,i.key,i.color)}const t=this.add.circle(Y.x,Y.y,Y.r,Y.color,J).setDepth(2002).setScrollFactor(0).setInteractive();this.add.text(Y.x,Y.y,Y.label,{fontFamily:"monospace",fontSize:"16px",color:"#ffffff",stroke:"#000",strokeThickness:3}).setOrigin(.5).setDepth(2003).setScrollFactor(0),this._btnObjs.interact={circle:t,def:Y},this._setupButton(t,"interact",Y.color);const e=this.add.circle(K.x,K.y,K.r,K.color,J).setDepth(2002).setScrollFactor(0).setInteractive();this.add.text(K.x,K.y,K.label,{fontFamily:"monospace",fontSize:"11px",color:"#ffffff",stroke:"#000",strokeThickness:3}).setOrigin(.5).setDepth(2003).setScrollFactor(0),this._btnObjs.inventory={circle:e,def:K},this._setupButton(e,"inventory",K.color);const s=this.add.circle(42,36,20,5592422,J).setDepth(2002).setScrollFactor(0).setInteractive();this.add.text(42,36,"⏸",{fontFamily:"monospace",fontSize:"14px",color:"#ffffff",stroke:"#000",strokeThickness:3}).setOrigin(.5).setDepth(2003).setScrollFactor(0),this._btnObjs.pause={circle:s},this._setupButton(s,"pause",5592422),this.input.on("pointerdown",i=>{i.x<c/2&&this._joyStart(i)}),this.input.on("pointermove",i=>this._joyMove(i)),this.input.on("pointerup",i=>this._joyEnd(i)),this._player&&(this._player.mobileJoy={x:0,y:0})}_setupButton(t,e,s){t.on("pointerdown",()=>{t.setFillStyle(s,xi),this._triggerButton(e)}),t.on("pointerup",()=>t.setFillStyle(s,J)),t.on("pointerout",()=>t.setFillStyle(s,J))}_triggerButton(t){if(this._player&&!(this._player.searching||this._player.inMenu))switch(t){case"punch":this._player._gpAttack.punch=!0;break;case"kick":this._player._gpAttack.kick=!0;break;case"jab":this._player._gpAttack.jab=!0;break;case"jump":this._player._gpAttack.jump=!0;break;case"interact":this._onInteract();break;case"inventory":this._onInventory();break;case"pause":this._onPause();break}}_joyStart(t){this._joyActive=!0,this._joyPointerId=t.id,this._joyOrigin.x=t.x,this._joyOrigin.y=t.y,this._joyRing.setPosition(t.x,t.y),this._joyKnob.setPosition(t.x,t.y),this._joyRing.setAlpha(.25),this._joyMove(t)}_joyMove(t){if(!this._joyActive||t.id!==this._joyPointerId)return;const e=t.x-this._joyOrigin.x,s=t.y-this._joyOrigin.y,i=Math.sqrt(e*e+s*s),n=Math.min(i,At),o=i>0?e/i:0,a=i>0?s/i:0;this._joyKnob.setPosition(this._joyOrigin.x+o*n,this._joyOrigin.y+a*n);const r=.15;this._joyVec.x=Math.abs(o)>r?o:0,this._joyVec.y=Math.abs(a)>r?a:0,this._player&&(this._player.mobileJoy.x=this._joyVec.x,this._player.mobileJoy.y=this._joyVec.y)}_joyEnd(t){t.id===this._joyPointerId&&(this._joyActive=!1,this._joyVec={x:0,y:0},this._joyRing.setPosition(lt,ct).setAlpha(.12),this._joyKnob.setPosition(lt,ct).setAlpha(J),this._player&&(this._player.mobileJoy.x=0,this._player.mobileJoy.y=0))}update(){this._player&&(this._player.mobileJoy=this._player.mobileJoy??{x:0,y:0})}}class Si extends Phaser.Scene{constructor(){super({key:"GameOverScene"})}init(t){this.wallet=t.wallet??0,this.reason=t.reason??"TIME UP"}create(){const{width:t,height:e}=this.scale,s=t/2,i=e/2;this.add.rectangle(s,i,t,e,0,.82),this.add.text(s,i-90,"GAME OVER",{fontFamily:"monospace",fontSize:"52px",color:"#ff2222",stroke:"#000000",strokeThickness:5}).setOrigin(.5),this.add.text(s,i-30,this.reason,{fontFamily:"monospace",fontSize:"20px",color:"#888888"}).setOrigin(.5),this.add.text(s,i+20,`ETH COLLECTED : ${this.wallet}`,{fontFamily:"monospace",fontSize:"24px",color:"#00ffcc"}).setOrigin(.5);const n=this.add.text(s,i+90,"TAP / ENTER / START  TO RETRY",{fontFamily:"monospace",fontSize:"16px",color:"#666666"}).setOrigin(.5);this.tweens.add({targets:n,alpha:0,duration:600,yoyo:!0,repeat:-1}),this.input.keyboard.once("keydown-ENTER",()=>this._restart()),this.input.gamepad.on("down",(o,a)=>{a.index===9&&this._restart()}),this.time.delayedCall(800,()=>{this.input.once("pointerdown",()=>this._restart())})}_restart(){this.scene.start("GameScene")}}class ki extends Phaser.Scene{constructor(){super({key:"WinScene"})}init(t){this.wallet=t.wallet??0,this.timeLeft=t.timeLeft??0}create(){const{width:t,height:e}=this.scale,s=t/2,i=e/2;this.add.rectangle(s,i,t,e,0,.82),this.add.text(s,i-110,"EXTRACTION",{fontFamily:"monospace",fontSize:"50px",color:"#00ff88",stroke:"#000000",strokeThickness:5}).setOrigin(.5),this.add.text(s,i-55,"SUCCESSFUL",{fontFamily:"monospace",fontSize:"50px",color:"#00ff88",stroke:"#000000",strokeThickness:5}).setOrigin(.5);const n=Math.floor(this.timeLeft)*10,o=this.wallet+n;this.add.text(s,i+10,`ETH COLLECTED : ${this.wallet}`,{fontFamily:"monospace",fontSize:"22px",color:"#00ffcc"}).setOrigin(.5),this.add.text(s,i+45,`TIME BONUS    : +${n}`,{fontFamily:"monospace",fontSize:"22px",color:"#ffff44"}).setOrigin(.5),this.add.text(s,i+80,`TOTAL SCORE   : ${o}`,{fontFamily:"monospace",fontSize:"26px",color:"#ffffff",stroke:"#000000",strokeThickness:3}).setOrigin(.5);const a=this.add.text(s,i+140,"TAP / SPACE / A  TO PLAY AGAIN",{fontFamily:"monospace",fontSize:"15px",color:"#666666"}).setOrigin(.5);this.tweens.add({targets:a,alpha:0,duration:600,yoyo:!0,repeat:-1});const r=()=>this.scene.start("GameScene");this.input.keyboard.once("keydown-SPACE",r),this.input.gamepad.total>0?this.input.gamepad.once("down",r):this.input.gamepad.on("connected",()=>{this.input.gamepad.once("down",r)}),this.time.delayedCall(800,()=>{this.input.once("pointerdown",r)})}}const wi={type:Phaser.AUTO,width:c,height:f,backgroundColor:"#0a0a14",physics:{default:"arcade",arcade:{gravity:{y:0},debug:!1}},input:{gamepad:!0},scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},scene:[Ve,Ue,Rs,Ns,ai,ri,hi,li,ci,_i,bi,Si,ki]},vi=new Phaser.Game(wi);window.__RAGEDERUE_GAME=vi;const ce=document.getElementById("focus-overlay");window.addEventListener("blur",()=>ce?.classList.add("visible"));window.addEventListener("focus",()=>ce?.classList.remove("visible"));
