(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();const c=960,d=540,v=330,w=470,Dt=96,Ot=63,M=220,pt=100,Rt=600,ft=100,Ft=12,Bt=1500,Ht=10,ut=15,Wt=8,zt=12,Nt=.1,Vt=.3,U=.5,_t=100,jt=.5,Gt=1,yt=100,Ut=.8,Yt=1,gt=500,Xt=80,$t=90,Kt=60,Zt=280,Jt=70,qt=35,Qt=220,te=900;function ee(o){o.create({key:"player_idle",frames:o.generateFrameNumbers("player_idle",{start:0,end:3}),frameRate:8,repeat:-1}),o.create({key:"player_walk",frames:o.generateFrameNumbers("player_walk",{start:0,end:9}),frameRate:12,repeat:-1}),o.create({key:"player_punch",frames:o.generateFrameNumbers("player_punch",{start:0,end:2}),frameRate:16,repeat:0}),o.create({key:"player_kick",frames:o.generateFrameNumbers("player_kick",{start:0,end:4}),frameRate:14,repeat:0}),o.create({key:"player_jab",frames:o.generateFrameNumbers("player_jab",{start:0,end:2}),frameRate:18,repeat:0}),o.create({key:"player_jump",frames:o.generateFrameNumbers("player_jump",{start:0,end:3}),frameRate:10,repeat:0}),o.create({key:"player_jump_kick",frames:o.generateFrameNumbers("player_jump_kick",{start:0,end:2}),frameRate:14,repeat:0}),o.create({key:"player_dive_kick",frames:o.generateFrameNumbers("player_dive_kick",{start:0,end:4}),frameRate:16,repeat:0}),o.create({key:"player_hurt",frames:o.generateFrameNumbers("player_hurt",{start:0,end:1}),frameRate:10,repeat:0}),o.create({key:"enemy_idle",frames:o.generateFrameNumbers("enemy_idle",{start:0,end:3}),frameRate:8,repeat:-1}),o.create({key:"enemy_walk",frames:o.generateFrameNumbers("enemy_walk",{start:0,end:3}),frameRate:10,repeat:-1}),o.create({key:"enemy_punch",frames:o.generateFrameNumbers("enemy_punch",{start:0,end:2}),frameRate:14,repeat:0}),o.create({key:"enemy_hurt",frames:o.generateFrameNumbers("enemy_hurt",{start:0,end:3}),frameRate:12,repeat:0}),o.create({key:"enemy_dead",frames:o.generateFrameNumbers("enemy_dead",{start:0,end:0}),frameRate:1,repeat:-1})}const se="/ragederue/assets/bar_backgrounds-BUuY7FaX.png",ie="/ragederue/assets/house-DaZvIU3g.png",ae="/ragederue/assets/street2_background-D7uxktga.png",ne="/ragederue/assets/street_background-_eV3Q83m.png",re=Object.assign({"/assets/Stage Layers/backgrounds/bar_backgrounds.png":se,"/assets/Stage Layers/backgrounds/house.png":ie,"/assets/Stage Layers/backgrounds/street2_background.png":ae,"/assets/Stage Layers/backgrounds/street_background.png":ne}),Et=Object.entries(re).map(([o,t])=>({key:o.split("/").pop().replace(/\.[^.]+$/,""),url:t})),oe=Et.map(o=>o.key),A="assets/Spritesheets/Brawler Girl/",H="assets/Spritesheets/Enemy Punk/",Q="assets/Stage Layers/",L="assets/Stage Layers/props/",Y="assets/Sprites/";class he extends Phaser.Scene{constructor(){super({key:"PreloadScene"})}preload(){const s=(this.scale.width-400)/2,i=this.scale.height/2,a=this.add.graphics();a.fillStyle(2236962),a.fillRect(s-2,i-2,404,24);const n=this.add.graphics();this.load.on("progress",l=>{n.clear(),n.fillStyle(16737792),n.fillRect(s,i,400*l,20)}),this.add.text(this.scale.width/2,i-30,"Loading...",{fontFamily:"monospace",fontSize:"18px",color:"#ff6600"}).setOrigin(.5),this.load.image("back",Q+"back.png"),this.load.image("fore",Q+"fore.png"),this.load.image("tileset",Q+"tileset.png");for(const{key:l,url:f}of Et)this.load.image(l,f);this.load.image("barrel",L+"barrel.png"),this.load.image("car",L+"car.png"),this.load.image("hydrant",L+"hydrant.png"),this.load.image("banner-hor1",L+"banner-hor/banner-hor1.png"),this.load.image("banner-hor2",L+"banner-hor/banner-hor2.png"),this.load.image("eth-prop-1",L+"Ethereum/ethereum-1.png"),this.load.image("eth-prop-2",L+"Ethereum/ethereum-2.png"),this.load.image("sushi-prop-1",L+"Sushi/sushi-1.png"),this.load.image("sushi-prop-2",L+"Sushi/sushi-2.png");const r=Dt,h=Ot;this.load.spritesheet("player_idle",A+"idle.png",{frameWidth:r,frameHeight:h}),this.load.spritesheet("player_walk",A+"walk.png",{frameWidth:r,frameHeight:h}),this.load.spritesheet("player_punch",A+"punch.png",{frameWidth:r,frameHeight:h}),this.load.spritesheet("player_kick",A+"kick.png",{frameWidth:r,frameHeight:h}),this.load.spritesheet("player_jab",A+"jab.png",{frameWidth:r,frameHeight:h}),this.load.spritesheet("player_jump",A+"jump.png",{frameWidth:r,frameHeight:h}),this.load.spritesheet("player_jump_kick",A+"jump_kick.png",{frameWidth:r,frameHeight:h}),this.load.spritesheet("player_dive_kick",A+"dive_kick.png",{frameWidth:r,frameHeight:h}),this.load.spritesheet("player_hurt",A+"hurt.png",{frameWidth:r,frameHeight:h}),this.load.image("eth",Y+"eth.png"),this.load.image("sushi",Y+"sushi.png"),this.load.image("pizza",Y+"Cutted_Pizza.png"),this.load.image("ice_cream",Y+"Ice_Cream.png"),this.load.spritesheet("enemy_idle",H+"idle.png",{frameWidth:r,frameHeight:h}),this.load.spritesheet("enemy_walk",H+"walk.png",{frameWidth:r,frameHeight:h}),this.load.spritesheet("enemy_punch",H+"punch.png",{frameWidth:r,frameHeight:h}),this.load.spritesheet("enemy_hurt",H+"hurt.png",{frameWidth:r,frameHeight:h}),this.load.spritesheet("enemy_dead",H+"dead.png",{frameWidth:r,frameHeight:h}),this.load.audio("music_street","assets/music/street.mp3"),this.load.audio("music_naval","assets/music/naval.mp3"),this.load.audio("sfx_hit","assets/sounds/hit.wav"),this.load.audio("sfx_death_player","assets/sounds/death_player.wav"),this.load.audio("sfx_death_enemy","assets/sounds/death_ennemy.wav"),this.load.audio("sfx_menu","assets/sounds/menu_sound.wav")}create(){ee(this.anims),this.scene.start("TitleScene")}}class le extends Phaser.Scene{constructor(){super({key:"TitleScene"})}create(){if(this.cameras.main.setBackgroundColor("#0a0a14"),this.registry.get("padIndex")===void 0){const a=parseInt(localStorage.getItem("RAGEDERUE_padIndex")??"0",10);this.registry.set("padIndex",a)}this.add.text(c/2,d*.28,"RAGEDERUE ONLINE",{fontFamily:"monospace",fontSize:"52px",color:"#ff6600",stroke:"#000000",strokeThickness:6}).setOrigin(.5);const t=this.add.text(c/2,d*.5,"ENTER / START : PLAY",{fontFamily:"monospace",fontSize:"18px",color:"#ffffff"}).setOrigin(.5);this.tweens.add({targets:t,alpha:0,duration:500,yoyo:!0,repeat:-1}),this.add.text(c/2,d*.62,"ESC / SELECT : SETTINGS",{fontFamily:"monospace",fontSize:"14px",color:"#888888"}).setOrigin(.5),this.add.text(c/2,d*.71,"L : LEVEL EDITOR",{fontFamily:"monospace",fontSize:"14px",color:"#4488ff"}).setOrigin(.5);const e=this.add.text(c/2,d*.84,["WASD / ZQSD / Arrows ── Move","X ── Punch    C ── Kick    V ── Jab","SPACE ── Jump"].join(`
`),{fontFamily:"monospace",fontSize:"12px",color:"#666666",align:"center",lineSpacing:6}).setOrigin(.5);this._detectLayout().then(a=>{if(!this.scene.isActive())return;this.registry.set("kbLayout",a);const n=a==="azerty"?"ZQSD / Flèches ── Déplacement":"WASD / Arrows ── Move";e.setText([n,"X ── Punch    C ── Kick    V ── Jab","SPACE ── Jump"].join(`
`))}),this.sound.stopByKey("music_naval"),this.sound.stopByKey("music_street");const s=parseFloat(localStorage.getItem("RAGEDERUE_music_vol")??"0.5");this.bgMusic=this.sound.add("music_naval",{loop:!0,volume:s}),this.bgMusic.play();const i=parseFloat(localStorage.getItem("RAGEDERUE_sfx_vol")??"0.5");this.registry.set("sfxVol",i),this._started=!1,this.input.keyboard.on("keydown-ENTER",()=>this._go()),this.input.gamepad.on("down",(a,n)=>{n.index===9&&this._go(),n.index===8&&this._openSettings()}),this.input.keyboard.on("keydown-ESC",()=>this._openSettings()),this.input.keyboard.on("keydown-L",()=>this._openEditor())}_go(){this._started||(this._started=!0,this.bgMusic&&(this.bgMusic.stop(),this.bgMusic.destroy(),this.bgMusic=null),this.scene.start("GameScene"))}_openSettings(){if(!this._started){if(this.scene.isActive("PauseScene")){this.scene.stop("PauseScene");return}this.sound.play("sfx_menu",{volume:this.registry.get("sfxVol")??.5}),this.scene.launch("PauseScene",{fromScene:"TitleScene"})}}_openEditor(){this._started||(this._started=!0,this.bgMusic&&(this.bgMusic.stop(),this.bgMusic.destroy(),this.bgMusic=null),this.scene.start("LevelEditorScene"))}async _detectLayout(){try{if(navigator.keyboard?.getLayoutMap)return(await navigator.keyboard.getLayoutMap()).get("KeyQ")==="a"?"azerty":"qwerty"}catch{}const t=(navigator.language??"").toLowerCase();return t.startsWith("fr")||t.startsWith("be")?"azerty":"qwerty"}}const ce={id:"level_01",name:"Street 01",worldW:10170,parallax:{bg:.065,mid:.5},background:"street_background",laneTop:100,props:[{type:"car",x:632,y:422,scale:1.1388888888888888},{type:"car",x:2200,y:345,scale:1.1388888888888888},{type:"barrel",x:800,y:420,scale:1},{type:"barrel",x:1800,y:410,scale:.9},{type:"hydrant",x:1100,y:335,scale:.65},{type:"hydrant",x:2600,y:340,scale:.65},{type:"car",x:305,y:340,scale:1.1388888888888888,blocksPlayer:!0},{type:"car",x:493,y:358,scale:1.1388888888888888},{type:"banner-hor1",x:394,y:208,scale:1.7808219178082192},{type:"fore",x:229,y:230,scale:1.2}],containers:[{x:371,y:410,texture:"barrel"},{x:780,y:450,texture:"barrel"},{x:1200,y:390,texture:"barrel"},{x:1700,y:455,texture:"barrel"},{x:2350,y:395,texture:"barrel"},{x:3100,y:445,texture:"barrel"}],transitZones:[{id:"zone_1771807424563",type:"warp",x:3974,y:88,width:118,height:202,targetLevel:"level_03",label:"Planque"},{id:"zone_1771847060713",type:"warp",x:4343,y:124,width:162,height:167,targetLevel:null,label:"WARP"},{id:"zone_1771855378689",type:"warp",x:916,y:124,width:159,height:168,targetLevel:null,label:"WARP"},{id:"zone_1771855511217",type:"warp",x:6867,y:125,width:160,height:165,targetLevel:null,label:"WARP"},{id:"zone_1771855527362",type:"warp",x:8520,y:95,width:116,height:194,targetLevel:null,label:"WARP"},{id:"zone_1771855537129",type:"warp",x:8892,y:121,width:159,height:169,targetLevel:null,label:"WARP"},{id:"zone_1771855550857",type:"warp",x:9102,y:110,width:116,height:179,targetLevel:null,label:"WARP"}]},de={id:"level_02",name:"Leve",worldW:3005,parallax:{bg:.06,mid:.25},background:"bar_backgrounds",props:[{type:"car",x:282,y:362,scale:.65},{type:"fore",x:2295,y:462,scale:.9895833333333334}],containers:[],transitZones:[{id:"zone_extract",type:"extract",x:3640,y:300,width:120,height:200,targetLevel:null,label:"EXTRACT"}]},pe={id:"level_03",name:"Level 3",worldW:2160,parallax:{bg:.06,mid:.25},background:"house",props:[],containers:[],transitZones:[{id:"zone_extract",type:"extract",x:2805,y:300,width:120,height:200,targetLevel:null,label:"EXTRACT"}]},B=[ce,de,pe];Object.fromEntries(B.map(o=>[o.id,o]));const D=120,E=160,k=36,P=36,fe=400,mt=[{id:"select",label:"↖ SELECT",color:"#ffffff"},{id:"sep_props",label:"─ PROPS ─",color:"#555555",sep:!0},{id:"prop:car",label:"  car",color:"#cccccc",scale:.65},{id:"prop:barrel",label:"  barrel",color:"#cccccc",scale:.9},{id:"prop:hydrant",label:"  hydrant",color:"#cccccc",scale:.65},{id:"prop:banner-hor1",label:"  banner1",color:"#cccccc",scale:.6},{id:"prop:banner-hor2",label:"  banner2",color:"#cccccc",scale:.6},{id:"prop:fore",label:"  fore",color:"#ffaa44",scale:1.2},{id:"sep_loot",label:"─ LOOT ─",color:"#555555",sep:!0},{id:"container",label:"  container",color:"#88ff88"},{id:"sep_zones",label:"─ ZONES ─",color:"#555555",sep:!0},{id:"transit",label:"  transit",color:"#00ccff"}],ue=5,xt="http://localhost:9001";class _e extends Phaser.Scene{constructor(){super({key:"LevelEditorScene"})}create(){const t=this.registry.get("editorLevels");let e=null;try{const s=localStorage.getItem("RAGEDERUE_editor_levels");s&&(e=JSON.parse(s))}catch{}this._levels=JSON.parse(JSON.stringify(t||e||B)),this._currentIdx=0,this._camScrollX=0,this._activeTool="select",this._selected=null,this._worldObjects=[],this._bgGraphics=[],this._capturingInput=!1,this._inputBuffer="",this._inputTarget=null,this._exportOverlay=null,this._selRect=null,this._availableBackgrounds=[null,...oe],this._dragActive=!1,this._dragOrigin=null,this._resizeMode=null,this._zoom=1,this._worldLayer=this.add.layer(),this._uiLayer=this.add.layer(),this.cameras.main.setBackgroundColor("#0a0a14"),this.cameras.main.setScroll(0,0),this._buildUI(),this._loadLevel(),this._uiCam=this.cameras.add(0,0,c,d,!1,"ui"),this._uiCam.setZoom(1).setScroll(0,0),this.cameras.main.ignore(this._uiLayer),this._uiCam.ignore(this._worldLayer),this._fetchLevelsFromServer(),this._keys=this.input.keyboard.addKeys({left:Phaser.Input.Keyboard.KeyCodes.LEFT,right:Phaser.Input.Keyboard.KeyCodes.RIGHT,a:Phaser.Input.Keyboard.KeyCodes.A,d:Phaser.Input.Keyboard.KeyCodes.D,q:Phaser.Input.Keyboard.KeyCodes.Q}),this.input.keyboard.on("keydown",s=>this._onKeyDown(s)),this.input.on("pointerdown",s=>this._onPointerDown(s)),this.input.on("pointermove",s=>this._onPointerMove(s)),this.input.on("pointerup",()=>{this._dragActive=!1,this._dragOrigin=null,this._resizeMode=null}),this.input.on("wheel",(s,i,a,n)=>this._onWheel(s,n))}update(t,e){if(this._capturingInput)return;const s=e/1e3,i=this._levels[this._currentIdx]?.worldW??3840,a=Math.max(0,i-c/this._zoom),n=fe/this._zoom;(this._keys.left.isDown||this._keys.a.isDown||this._keys.q.isDown)&&(this._camScrollX=Math.max(0,this._camScrollX-n*s),this.cameras.main.setScroll(this._camScrollX,this._camScrollY())),(this._keys.right.isDown||this._keys.d.isDown)&&(this._camScrollX=Math.min(a,this._camScrollX+n*s),this.cameras.main.setScroll(this._camScrollX,this._camScrollY()))}_buildUI(){const t=e=>(this._uiLayer.add(e),e);t(this.add.rectangle(D/2,d/2,D,d,855322).setDepth(600)),t(this.add.rectangle(c/2,k/2,c,k,1118498).setDepth(600)),t(this.add.rectangle(c/2,d-P/2,c,P,1118498).setDepth(600)),t(this.add.rectangle(c-E/2,d/2,E,d,526356).setDepth(600)),t(this.add.rectangle(D,d/2,1,d,3359829).setDepth(601)),t(this.add.rectangle(c-E,d/2,1,d,3359829).setDepth(601)),t(this.add.rectangle(c/2,k,c,1,3359829).setDepth(601)),t(this.add.rectangle(c/2,d-P,c,1,3359829).setDepth(601)),this._buildToolbar(),this._buildPalette(),this._buildPropsPanel(),this._buildListPanel(),t(this.add.text(D+4,d-P-14,"A/D : scroll   molette / +- : zoom   0 : reset zoom   DEL : supprimer",{fontFamily:"monospace",fontSize:"9px",color:"#333355"}).setDepth(601))}_buildToolbar(){const t=k/2;this._uiBtn(10,t,"[ MENU ]","#888888",()=>this.scene.start("TitleScene"),0,.5),this._uiBtn(150,t,"◄","#ff6600",()=>this._prevLevel(),.5,.5),this._levelNameText=this.add.text(310,t,"",{fontFamily:"monospace",fontSize:"12px",color:"#ffffff"}).setOrigin(.5).setDepth(700).setInteractive({useHandCursor:!0}),this._uiLayer.add(this._levelNameText),this._levelNameText.on("pointerdown",()=>{this._capturingInput||this._startRename()}),this._levelNameText.on("pointerover",()=>{this._capturingInput||this._levelNameText.setColor("#ffcc00")}),this._levelNameText.on("pointerout",()=>{this._capturingInput||this._levelNameText.setColor("#ffffff")}),this._uiBtn(470,t,"►","#ff6600",()=>this._nextLevel(),.5,.5),this._uiBtn(510,t,"[ +NEW ]","#ffcc00",()=>this._newLevel(),0,.5),this._uiBtn(580,t,"[ SAVE ]","#ffcc00",()=>this._saveToServer(),0,.5),this._uiBtn(648,t,"[ TEST ]","#00ff88",()=>this._testLevel(),0,.5),this._uiBtn(716,t,"[ EXPORT ]","#4488ff",()=>this._showExport(),0,.5),this._zoomLabel=this.add.text(c-E-8,t,"100%",{fontFamily:"monospace",fontSize:"10px",color:"#556677"}).setOrigin(1,.5).setDepth(700),this._uiLayer.add(this._zoomLabel),this._updateToolbarName()}_buildPalette(){this._paletteButtons=[];let t=k+10;for(const e of mt){if(e.sep){const i=this.add.text(4,t,e.label,{fontFamily:"monospace",fontSize:"10px",color:e.color}).setDepth(700);this._uiLayer.add(i),t+=18;continue}const s=this.add.text(4,t,e.label,{fontFamily:"monospace",fontSize:"11px",color:e.color}).setDepth(700).setInteractive({useHandCursor:!0});this._uiLayer.add(s),s.on("pointerdown",()=>this._selectTool(e.id)),s.on("pointerover",()=>{this._activeTool!==e.id&&s.setColor("#ffffff")}),s.on("pointerout",()=>{this._activeTool!==e.id&&s.setColor(e.color)}),this._paletteButtons.push({tool:e,btn:s}),t+=22}this._updatePaletteHighlight()}_buildPropsPanel(){const t=d-P/2,e=D+8;this._propInfoText=this.add.text(e,t,"Aucun objet sélectionné",{fontFamily:"monospace",fontSize:"11px",color:"#555555"}).setOrigin(0,.5).setDepth(700),this._uiLayer.add(this._propInfoText),this._fieldX=this._makeEditField(e,t,"x"),this._fieldY=this._makeEditField(e+90,t,"y"),this._fieldScale=this._makeEditField(e+180,t,"scale"),this._btnDel=this._uiBtn(c-E-80,t,"[ DEL ]","#ff4444",()=>this._deleteSelected(),0,.5),this._btnDel.setVisible(!1),this._btnBlock=this._uiBtn(e+270,t,"[□ block]","#555555",()=>this._toggleBlocksPlayer(),0,.5),this._btnBlock.setVisible(!1),this._btnBlockEnemy=this._uiBtn(e+340,t,"[□ enemy]","#555555",()=>this._toggleBlocksEnemy(),0,.5),this._btnBlockEnemy.setVisible(!1),this._lblTarget=this.add.text(e+440,t,"",{fontFamily:"monospace",fontSize:"10px",color:"#aaaaaa"}).setOrigin(0,.5).setDepth(700).setVisible(!1),this._uiLayer.add(this._lblTarget),this._btnTgtL=this._uiBtn(e+540,t,"◄","#ff6600",()=>this._cycleTarget(-1),.5,.5),this._btnTgtR=this._uiBtn(e+560,t,"►","#ff6600",()=>this._cycleTarget(1),.5,.5),this._btnTgtL.setVisible(!1),this._btnTgtR.setVisible(!1),this._fieldBg=this._makeLevelField(e,t,"parallax.bg","px.bg"),this._fieldMid=this._makeLevelField(e+90,t,"parallax.mid","px.mid"),this._fieldWW=this._makeLevelField(e+180,t,"worldW","worldW"),this._fieldLaneTop=this._makeLevelField(e+480,t,"laneTop","lane↑"),this._fieldLaneBot=this._makeLevelField(e+570,t,"laneBottom","lane↓"),this._fieldSpawnX=this._makeLevelField(e+660,t,"spawnX","spawnX"),this._fieldWidth=this._makeEditField(e+180,t,"width"),this._fieldHeight=this._makeEditField(e+260,t,"height"),this._fieldLabel=this._makeEditField(e+340,t,"label"),this._btnBgL=this._uiBtn(e+265,t,"◄","#4488ff",()=>this._cycleBackground(-1),.5,.5),this._lblBgName=this.add.text(e+360,t,"(aucun)",{fontFamily:"monospace",fontSize:"10px",color:"#aaaacc"}).setOrigin(.5,.5).setDepth(700).setVisible(!1),this._uiLayer.add(this._lblBgName),this._btnBgR=this._uiBtn(e+455,t,"►","#4488ff",()=>this._cycleBackground(1),.5,.5),this._btnBgL.setVisible(!1),this._btnBgR.setVisible(!1),this._updatePropsPanel()}_buildListPanel(){const t=c-E,e=this.add.text(t+E/2,k+8,"OBJETS",{fontFamily:"monospace",fontSize:"10px",color:"#4488ff"}).setOrigin(.5,0).setDepth(700);this._uiLayer.add(e),this._listY0=k+24,this._listItems=[],this._listContainer=this.add.container(0,0).setDepth(700),this._uiLayer.add(this._listContainer)}_makeEditField(t,e,s){const i=this.add.text(t,e-7,s+":",{fontFamily:"monospace",fontSize:"9px",color:"#555555"}).setOrigin(0,.5).setDepth(700).setVisible(!1);this._uiLayer.add(i);const a=this.add.text(t,e+6,"---",{fontFamily:"monospace",fontSize:"11px",color:"#cccccc"}).setOrigin(0,.5).setDepth(700).setVisible(!1).setInteractive({useHandCursor:!0});return this._uiLayer.add(a),a.on("pointerdown",()=>{this._selected&&this._startNumInput(this._selected.obj,s,a)}),a.on("pointerover",()=>a.setColor("#ffffff")),a.on("pointerout",()=>{this._inputTarget?.textObj!==a&&a.setColor("#cccccc")}),{lbl:i,val:a}}_makeLevelField(t,e,s,i){const a=this.add.text(t,e-7,i+":",{fontFamily:"monospace",fontSize:"9px",color:"#445566"}).setOrigin(0,.5).setDepth(700).setVisible(!1);this._uiLayer.add(a);const n=this.add.text(t,e+6,"---",{fontFamily:"monospace",fontSize:"11px",color:"#aaaacc"}).setOrigin(0,.5).setDepth(700).setVisible(!1).setInteractive({useHandCursor:!0});return this._uiLayer.add(n),n.on("pointerdown",()=>this._startLevelPropInput(s,n)),n.on("pointerover",()=>n.setColor("#ffffff")),n.on("pointerout",()=>{this._inputTarget?.textObj!==n&&n.setColor("#aaaacc")}),{lbl:a,val:n}}_uiBtn(t,e,s,i,a,n=0,r=.5){const h=this.add.text(t,e,s,{fontFamily:"monospace",fontSize:"11px",color:i}).setOrigin(n,r).setDepth(700).setInteractive({useHandCursor:!0});return h.on("pointerdown",a),h.on("pointerover",()=>h.setColor("#ffffff")),h.on("pointerout",()=>h.setColor(i)),this._uiLayer.add(h),h}_loadLevel(){for(const e of this._worldObjects)this._destroyWO(e);this._worldObjects=[];for(const e of this._bgGraphics)e.destroy();this._bgGraphics=[],this._deselect(),this._camScrollX=0,this.cameras.main.setScroll(0,this._camScrollY());const t=this._levels[this._currentIdx];this._buildWorldBackground(t);for(const e of t.props)this._spawnPropSprite(e);for(const e of t.containers)this._spawnContainerSprite(e);for(const e of t.transitZones)this._spawnTransitSprite(e);this._updateToolbarName(),this._updatePropsPanel(),this._updatePaletteHighlight(),this._updateListPanel()}_rebuildBackground(){for(const s of this._bgGraphics)s.destroy();this._bgGraphics=[];const t=this._levels[this._currentIdx];this._buildWorldBackground(t);const e=Math.max(0,(t.worldW??3840)-c/this._zoom);this._camScrollX=Math.min(this._camScrollX,e),this.cameras.main.setScroll(this._camScrollX,this._camScrollY())}_buildWorldBackground(t){if(t.background&&this.textures.exists(t.background)){const y=this.textures.get(t.background).source[0],g=d/y.height,m=Math.round(y.width*g);t.worldW=m;const C=this.add.image(0,0,t.background).setOrigin(0,0).setScale(g).setDepth(0);this._bgGraphics.push(C)}else{const p=this.add.graphics().setDepth(1);p.fillStyle(1710638),p.fillRect(0,0,t.worldW??3840,d),p.fillStyle(2763322),p.fillRect(0,290,t.worldW??3840,d-290);const y=t.laneTop??v,g=t.laneBottom??w;p.fillStyle(3355461),p.fillRect(0,y,t.worldW??3840,g-y),p.fillStyle(8947865,.25),p.fillRect(0,y-2,t.worldW??3840,3),this._bgGraphics.push(p)}const e=t.worldW??3840,s=t.laneTop??v,i=t.laneBottom??w,a=this.add.graphics().setDepth(2);a.lineStyle(1,4478310,.4),a.lineBetween(0,s,e,s),a.lineBetween(0,i,e,i),this._bgGraphics.push(a);const n=this.add.graphics().setDepth(2);n.lineStyle(1,2241348,.4);for(let p=480;p<e;p+=480){n.lineBetween(p,0,p,d);const y=this.add.text(p+3,k+2,String(p),{fontFamily:"monospace",fontSize:"9px",color:"#334455"}).setDepth(3);this._bgGraphics.push(y)}this._bgGraphics.push(n);const r=this.add.graphics().setDepth(4);r.lineStyle(2,16729156,.7),r.lineBetween(e,0,e,d),this._bgGraphics.push(r);const h=this.add.text(e-4,k+4,`end  W:${e}`,{fontFamily:"monospace",fontSize:"10px",color:"#ff4444"}).setOrigin(1,0).setDepth(5);this._bgGraphics.push(h);const l=t.spawnX??150,f=this.add.graphics().setDepth(6);f.lineStyle(2,65416,.8),f.lineBetween(l,s-30,l,i+10);const u=this.add.text(l,i+12,"▲ spawn",{fontFamily:"monospace",fontSize:"9px",color:"#00ff88"}).setOrigin(.5,0).setDepth(6);this._bgGraphics.push(f,u);for(const p of this._bgGraphics)this._worldLayer.add(p)}_spawnPropSprite(t){if(!this.textures.exists(t.type))return console.warn(`[Editor] Texture manquante : ${t.type}`),null;const e=this.add.image(t.x,t.y,t.type).setOrigin(.5,1).setScale(t.scale??1).setDepth(t.y+10);this._worldLayer.add(e);const s={data:t,sprite:e,type:"prop"};return this._worldObjects.push(s),s}_spawnContainerSprite(t){const e=this.add.image(t.x,t.y,"barrel").setOrigin(.5,1).setScale(1).setDepth(t.y+10).setTint(8978312);this._worldLayer.add(e);const s={data:t,sprite:e,type:"container"};return this._worldObjects.push(s),s}_spawnTransitSprite(t){const e=this._levels[this._currentIdx],s=e.laneTop??v,i=e.laneBottom??w,a=t.width??120,n=t.y??s-30,r=t.height??i-s+60;t.y==null&&(t.y=n),t.height==null&&(t.height=r);const h=this.add.graphics().setDepth(s-5);this._worldLayer.add(h),this._redrawTransitGfx(h,t,n,a,r);const l=this.add.text(t.x+a/2,n-14,this._transitLabel(t),{fontFamily:"monospace",fontSize:"10px",color:this._transitColor(t,!0)}).setOrigin(.5,1).setDepth(s-4);this._worldLayer.add(l);const f={data:t,sprite:null,graphics:h,labelText:l,type:"transit",_zoneY:n,_zoneH:r};return this._worldObjects.push(f),f}_redrawTransitGfx(t,e,s,i,a){const n=this._transitColor(e);t.clear(),t.fillStyle(n,.18),t.fillRect(e.x,s,i,a),t.lineStyle(2,n,.9),t.strokeRect(e.x,s,i,a)}_transitColor(t,e=!1){return t.type==="warp"?e?"#00ccff":52479:e?"#00ff88":65416}_transitLabel(t){return t.type==="warp"?`► ${t.targetLevel??"WARP"}`:`▼ ${t.label??"EXTRACT"}`}_destroyWO(t){t.sprite?.destroy(),t.graphics?.destroy(),t.labelText?.destroy()}_hitTestWorld(t,e){for(let s=this._worldObjects.length-1;s>=0;s--){const i=this._worldObjects[s];if(this._woContains(i,t,e))return i}return null}_woContains(t,e,s){if(t.type==="prop"||t.type==="container"){const i=t.sprite;if(!i||!i.active)return!1;const a=i.displayWidth*.5,n=i.displayHeight;return e>=i.x-a&&e<=i.x+a&&s>=i.y-n&&s<=i.y}if(t.type==="transit"){const i=t.data.width??120;return e>=t.data.x&&e<=t.data.x+i&&s>=t._zoneY&&s<=t._zoneY+t._zoneH}return!1}_selectObject(t){this._selected={obj:t},this._drawSelectionRect(t),this._updatePropsPanel(),this._updateListPanel()}_deselect(){this._selected=null,this._selRect&&(this._selRect.destroy(),this._selRect=null),this._updatePropsPanel(),this._updateListPanel()}_drawSelectionRect(t){if(this._selRect&&(this._selRect.destroy(),this._selRect=null),!t)return;let e,s,i,a;if(t.type==="transit")e=t.data.x,s=t._zoneY,i=t.data.width??120,a=t._zoneH;else if(t.type==="fore"){const n=this._levels[this._currentIdx],r=n.laneTop??v,h=n.laneBottom??w;e=t.data.x-20,s=r-62,i=40,a=h-r+72}else{const n=t.sprite,r=n.displayWidth*.5,h=n.displayHeight;e=n.x-r,s=n.y-h,i=n.displayWidth,a=h}this._selRect=this.add.graphics().setDepth(9e3),this._worldLayer.add(this._selRect),this._selRect.lineStyle(2,16776960,.9),this._selRect.strokeRect(e-2,s-2,i+4,a+4),t.type==="transit"?(this._selRect.fillStyle(16737792,1),this._selRect.fillRect(e+i-2,s+a/2-5,10,10),this._selRect.fillRect(e+i/2-5,s+a-2,10,10)):t.type==="prop"&&(this._selRect.fillStyle(65416,1),this._selRect.fillRect(e+i-2,s+a-2,10,10))}_getResizeHandle(t,e,s){if(t.type==="transit"){const i=t.data.x,a=t._zoneY,n=t.data.width??120,r=t._zoneH;if(Math.abs(e-(i+n))<=10&&Math.abs(s-(a+r/2))<=10)return"width";if(Math.abs(e-(i+n/2))<=10&&Math.abs(s-(a+r))<=10)return"height"}else if(t.type==="prop"&&t.sprite){const i=t.sprite,a=i.displayWidth*.5;if(Math.abs(e-(i.x+a))<=10&&Math.abs(s-i.y)<=10)return"scale"}return null}_onPointerDown(t){if(this._capturingInput||t.x<D||t.x>c-E||t.y<k||t.y>d-P)return;const{x:s,y:i}=this._screenToWorld(t.x,t.y);if(this._selected?.obj){const n=this._getResizeHandle(this._selected.obj,s,i);if(n){this._resizeMode=n,this._dragOrigin={px:t.x,py:t.y},this._dragActive=!1;return}}const a=this._hitTestWorld(s,i);if(a){this._selectObject(a),this._dragOrigin={px:t.x,py:t.y},this._dragActive=!1;return}this._deselect(),this._activeTool!=="select"&&this._placeItem(s,i)}_onPointerMove(t){if(!t.isDown||this._capturingInput||!this._selected||t.x<D||t.x>c-E||t.y<k||t.y>d-P)return;if(!this._dragActive&&this._dragOrigin){const i=t.x-this._dragOrigin.px,a=t.y-this._dragOrigin.py;Math.sqrt(i*i+a*a)>ue&&(this._dragActive=!0)}if(!this._dragActive)return;const{x:e,y:s}=this._screenToWorld(t.x,t.y);if(this._resizeMode){const i=this._selected.obj;if(this._resizeMode==="width")i.data.width=Math.max(20,Math.round(e-i.data.x)),this._refreshTransitWO(i),this._drawSelectionRect(i),this._updatePropsPanel();else if(this._resizeMode==="height")i.data.height=Math.max(20,Math.round(s-i._zoneY)),i._zoneH=i.data.height,this._refreshTransitWO(i),this._drawSelectionRect(i),this._updatePropsPanel();else if(this._resizeMode==="scale"){const a=i.sprite.width/2,n=Phaser.Math.Clamp((e-i.sprite.x)/a,.1,4),r=i.data.type,h=this._levels[this._currentIdx];for(const l of h.props)l.type===r&&(l.scale=n);for(const l of this._worldObjects)l.type==="prop"&&l.data.type===r&&l.sprite&&l.sprite.setScale(n);this._drawSelectionRect(i),this._updatePropsPanel()}return}this._moveObject(this._selected.obj,Math.round(e),Math.round(s))}_screenToWorld(t,e){const s=this.cameras.main.getWorldPoint(t,e);return{x:Math.round(s.x),y:Math.round(s.y)}}_moveObject(t,e,s){if(t.data.x=e,t.type==="prop"||t.type==="container")t.data.y=s,t.sprite.setPosition(e,s).setDepth(s+10);else if(t.type==="transit"){t.data.y=s,t._zoneY=s;const i=t.data.width??120;this._redrawTransitGfx(t.graphics,t.data,t._zoneY,i,t._zoneH),t.labelText.setPosition(e+i/2,t._zoneY-14)}this._drawSelectionRect(t),this._updatePropsPanel(),this._updateListPanel()}_camScrollY(){return Math.max(0,d/2*(1-1/this._zoom))}_onWheel(t,e){if(this._capturingInput)return;const i=t.x<D||t.x>c-E||t.y<k||t.y>d-P?c/2:t.x;this._applyZoom(e>0?1/1.12:1.12,i)}_applyZoom(t,e=c/2){const s=this._levels[this._currentIdx]?.worldW??3840,i=this._camScrollX+e/this._zoom;this._zoom=Phaser.Math.Clamp(this._zoom*t,.25,2),this.cameras.main.setZoom(this._zoom);const a=Math.max(0,s-c/this._zoom);this._camScrollX=Phaser.Math.Clamp(i-e/this._zoom,0,a),this.cameras.main.setScroll(this._camScrollX,this._camScrollY()),this._updateZoomLabel()}_updateZoomLabel(){this._zoomLabel&&this._zoomLabel.setText(`${Math.round(this._zoom*100)}%`)}_placeItem(t,e){const s=this._levels[this._currentIdx];if(this._activeTool.startsWith("prop:")){const i=this._activeTool.slice(5),a=mt.find(h=>h.id===this._activeTool),n={type:i,x:t,y:e,scale:a?.scale??1};s.props.push(n);const r=this._spawnPropSprite(n);r&&(this._selectObject(r),this._dragOrigin=null);return}if(this._activeTool==="container"){const i={x:t,y:e,texture:"barrel"};s.containers.push(i);const a=this._spawnContainerSprite(i);a&&(this._selectObject(a),this._dragOrigin=null);return}if(this._activeTool==="transit"){const i={id:`zone_${Date.now()}`,type:"warp",x:t,width:120,targetLevel:null,label:"WARP"};s.transitZones.push(i);const a=this._spawnTransitSprite(i);a&&(this._selectObject(a),this._dragOrigin=null);return}}_selectTool(t){this._activeTool=t,t!=="select"&&this._deselect(),this._updatePaletteHighlight()}_updatePaletteHighlight(){for(const{tool:t,btn:e}of this._paletteButtons)e.setColor(t.id===this._activeTool?"#ff6600":t.color??"#cccccc")}_updateListPanel(){for(const a of this._listItems)a.textObj.destroy();this._listItems=[];const t=c-E+4;let e=this._listY0;const s=this._selected?.obj,i=d-P-14;for(const a of this._worldObjects){if(e>i)break;const n=a===s,r=this._woShortLabel(a),h=n?"#ffff00":a.type==="container"?"#88ff88":a.type==="transit"?"#00ccff":"#aaaaaa",l=this.add.text(t,e,r,{fontFamily:"monospace",fontSize:"9px",color:h}).setDepth(700).setInteractive({useHandCursor:!0});this._uiLayer.add(l),l.on("pointerdown",()=>{this._selectObject(a);const f=a.data.x,u=this._levels[this._currentIdx]?.worldW??3840,p=c/this._zoom;this._camScrollX=Phaser.Math.Clamp(f-p/2,0,Math.max(0,u-p)),this.cameras.main.setScroll(this._camScrollX,this._camScrollY())}),l.on("pointerover",()=>l.setColor("#ffffff")),l.on("pointerout",()=>l.setColor(n?"#ffff00":h)),this._listItems.push({textObj:l,wo:a}),e+=13}if(this._worldObjects.length===0){const a=this.add.text(t,this._listY0,"(vide)",{fontFamily:"monospace",fontSize:"9px",color:"#444444"}).setDepth(700);this._uiLayer.add(a),this._listItems.push({textObj:a,wo:null})}}_woShortLabel(t){const e=t.data.x,s=t.data.y;if(t.type==="transit")return`[T] ${t.data.type} x${e}`;if(t.type==="container")return`[C] x${e} y${s}`;const i=(t.data.blocksPlayer?"■":"")+(t.data.blocksEnemy?"E":"");return`[P] ${t.data.type} x${e} ${i}`.trimEnd()}_updatePropsPanel(){const t=this._selected?.obj,e=d-P/2,s=D+8;this._propInfoText.setVisible(!1),this._btnDel.setVisible(!!t);for(const i of[this._fieldX,this._fieldY,this._fieldScale,this._fieldBg,this._fieldMid,this._fieldWW,this._fieldLaneTop,this._fieldLaneBot,this._fieldSpawnX,this._fieldWidth,this._fieldHeight,this._fieldLabel])i.lbl.setVisible(!1),i.val.setVisible(!1);if(this._lblTarget.setVisible(!1),this._btnTgtL.setVisible(!1),this._btnTgtR.setVisible(!1),this._btnBgL.setVisible(!1),this._lblBgName.setVisible(!1),this._btnBgR.setVisible(!1),this._btnBlock.setVisible(!1),this._btnBlockEnemy.setVisible(!1),!t){const i=this._levels[this._currentIdx],a=i.background??null;this._lblBgName.setText(a??"(aucun)").setVisible(!0),this._btnBgL.setVisible(!0),this._btnBgR.setVisible(!0),i.background||(this._showField(this._fieldBg,s,e,"px.bg",i.parallax?.bg??.06),this._fieldBg.val.setColor("#aaaacc"),this._showField(this._fieldMid,s+90,e,"px.mid",i.parallax?.mid??.25),this._fieldMid.val.setColor("#aaaacc"),this._showField(this._fieldWW,s+180,e,"worldW",i.worldW??3840),this._fieldWW.val.setColor("#aaaacc")),this._showField(this._fieldLaneTop,s+480,e,"lane↑",i.laneTop??v),this._fieldLaneTop.val.setColor("#aaaacc"),this._showField(this._fieldLaneBot,s+570,e,"lane↓",i.laneBottom??w),this._fieldLaneBot.val.setColor("#aaaacc"),this._showField(this._fieldSpawnX,s+660,e,"spawnX",i.spawnX??150),this._fieldSpawnX.val.setColor("#aaaacc");return}if(this._showField(this._fieldX,s,e,"x",t.data.x),this._showField(this._fieldY,s+90,e,"y",t.data.y),t.type==="transit")this._showField(this._fieldWidth,s+180,e,"width",t.data.width??120),this._showField(this._fieldHeight,s+260,e,"height",t.data.height??0),this._showField(this._fieldLabel,s+340,e,"label",t.data.label??""),this._lblTarget.setText(`→ ${t.data.targetLevel??"(none)"}`).setPosition(s+440,e).setVisible(!0),this._btnTgtL.setPosition(s+540,e).setVisible(!0),this._btnTgtR.setPosition(s+560,e).setVisible(!0);else if(this._showField(this._fieldScale,s+180,e,"scale",Number((t.data.scale??1).toFixed(2))),t.type==="prop"){const i=!!t.data.blocksPlayer;this._btnBlock.setText(i?"[■ BLOCK]":"[□ block]").setColor(i?"#ff6600":"#555555").setPosition(s+270,e).setVisible(!0);const a=!!t.data.blocksEnemy;this._btnBlockEnemy.setText(a?"[■ ENEMY]":"[□ enemy]").setColor(a?"#ff6600":"#555555").setPosition(s+340,e).setVisible(!0)}}_showField(t,e,s,i,a){t.lbl.setPosition(e,s-7).setText(i+":").setVisible(!0),t.val.setPosition(e,s+6).setText(String(a)).setVisible(!0).setColor("#cccccc")}_startNumInput(t,e,s){this._capturingInput||(this._capturingInput=!0,this._inputBuffer=String(t.data[e]??""),this._inputTarget={obj:t,field:e,textObj:s},s.setColor("#ffff00").setText(this._inputBuffer+"_"))}_startLevelPropInput(t,e){if(this._capturingInput)return;const s=this._levels[this._currentIdx];let i;t==="parallax.bg"&&(i=s.parallax?.bg??.06),t==="parallax.mid"&&(i=s.parallax?.mid??.25),t==="worldW"&&(i=s.worldW??3840),t==="laneTop"&&(i=s.laneTop??v),t==="laneBottom"&&(i=s.laneBottom??w),t==="spawnX"&&(i=s.spawnX??150),this._capturingInput=!0,this._inputBuffer=String(i),this._inputTarget={obj:null,field:"__levelProp",levelPath:t,textObj:e},e.setColor("#ffff00").setText(this._inputBuffer+"_")}_startRename(){const t=this._levels[this._currentIdx];this._capturingInput=!0,this._inputBuffer=t.name??"",this._inputTarget={obj:null,field:"name",textObj:this._levelNameText},this._levelNameText.setColor("#ffff00").setText(this._inputBuffer+"_")}_commitInput(){if(!this._capturingInput)return;const{obj:t,field:e,textObj:s}=this._inputTarget,i=this._levels[this._currentIdx];if(e==="name")this._inputBuffer.trim()&&(i.name=this._inputBuffer.trim()),this._updateToolbarName(),s.setColor("#ffffff");else if(e==="__levelProp"){const a=parseFloat(this._inputBuffer),n=this._inputTarget.levelPath;isNaN(a)||(n==="parallax.bg"?(i.parallax||(i.parallax={}),i.parallax.bg=a):n==="parallax.mid"?(i.parallax||(i.parallax={}),i.parallax.mid=a):n==="worldW"?(i.worldW=Math.round(Math.max(200,a)),this._rebuildBackground()):n==="laneTop"?(i.laneTop=Math.round(a),this._loadLevel()):n==="laneBottom"?(i.laneBottom=Math.round(a),this._loadLevel()):n==="spawnX"&&(i.spawnX=Math.round(Math.max(0,a)),this._rebuildBackground())),s.setColor("#aaaacc")}else if(t){if(e==="label"){const a=this._inputBuffer.trim();a&&(t.data.label=a),t.type==="transit"&&this._refreshTransitWO(t)}else{const a=parseFloat(this._inputBuffer);isNaN(a)||(e==="scale"?(t.data.scale=a,t.sprite&&t.sprite.setScale(a)):e==="width"?(t.data.width=Math.max(20,Math.round(a)),t.type==="transit"&&(this._refreshTransitWO(t),this._drawSelectionRect(t))):e==="height"?(t.data.height=Math.max(20,Math.round(a)),t._zoneH=t.data.height,t.type==="transit"&&(this._refreshTransitWO(t),this._drawSelectionRect(t))):(t.data[e]=Math.round(a),(e==="x"||e==="y")&&this._moveObject(t,t.data.x,t.data.y)))}s.setColor("#cccccc")}this._capturingInput=!1,this._inputTarget=null,this._updatePropsPanel(),this._updateListPanel()}_cancelInput(){if(!this._capturingInput)return;const{field:t,textObj:e}=this._inputTarget;t==="__levelProp"?e.setColor("#aaaacc"):t==="name"?(e.setColor("#ffffff"),this._updateToolbarName()):e.setColor("#cccccc"),this._capturingInput=!1,this._inputTarget=null,this._updatePropsPanel()}_onKeyDown(t){if(this._capturingInput){if(t.key==="Enter"){this._commitInput();return}if(t.key==="Escape"){this._cancelInput();return}if(t.key==="Backspace"){this._inputBuffer=this._inputBuffer.slice(0,-1),this._inputTarget.textObj.setText(this._inputBuffer+"_");return}(this._inputTarget.field==="label"?/^[\w ]$/.test(t.key)&&this._inputBuffer.length<20:/^[\d.\-]$/.test(t.key)&&this._inputBuffer.length<10)&&(this._inputBuffer+=t.key,this._inputTarget.textObj.setText(this._inputBuffer+"_"));return}if(t.key==="Escape"){this._selected?this._deselect():this.scene.start("TitleScene");return}if(t.key==="Delete"&&this._selected){this._deleteSelected();return}if(t.key==="+"||t.key==="="){this._applyZoom(1.15);return}if(t.key==="-"){this._applyZoom(1/1.15);return}if(t.key==="0"){this._applyZoom(1/this._zoom);return}}_deleteSelected(){if(!this._selected)return;const t=this._selected.obj,e=this._levels[this._currentIdx];t.type==="prop"&&(e.props=e.props.filter(s=>s!==t.data)),t.type==="container"&&(e.containers=e.containers.filter(s=>s!==t.data)),t.type==="transit"&&(e.transitZones=e.transitZones.filter(s=>s!==t.data)),this._destroyWO(t),this._worldObjects=this._worldObjects.filter(s=>s!==t),this._deselect(),this._updateListPanel()}_cycleBackground(t){const e=this._levels[this._currentIdx],s=this._availableBackgrounds,i=s.indexOf(e.background??null),a=Phaser.Math.Wrap(i+t,0,s.length);e.background=s[a],this._rebuildBackground(),this._updatePropsPanel(),this._updateToolbarName()}_cycleTarget(t){const e=this._selected?.obj;if(!e||e.type!=="transit")return;const s=[null,...this._levels.map(n=>n.id)],i=s.indexOf(e.data.targetLevel),a=Phaser.Math.Wrap(i+t,0,s.length);e.data.targetLevel=s[a],this._refreshTransitWO(e),this._updatePropsPanel(),this._updateListPanel()}_toggleBlocksPlayer(){const t=this._selected?.obj;!t||t.type!=="prop"||(t.data.blocksPlayer=!t.data.blocksPlayer,this._updatePropsPanel(),this._updateListPanel())}_toggleBlocksEnemy(){const t=this._selected?.obj;!t||t.type!=="prop"||(t.data.blocksEnemy=!t.data.blocksEnemy,this._updatePropsPanel(),this._updateListPanel())}_refreshTransitWO(t){const e=t.data.width??120;this._redrawTransitGfx(t.graphics,t.data,t._zoneY,e,t._zoneH),t.labelText.setText(this._transitLabel(t.data)).setColor(this._transitColor(t.data,!0)).setPosition(t.data.x+e/2,t._zoneY-14)}_updateToolbarName(){const t=this._levels[this._currentIdx];this._levelNameText.setText(`${this._currentIdx+1}/${this._levels.length}  ${t.name}`)}_prevLevel(){this._currentIdx>0&&(this._currentIdx--,this._loadLevel())}_nextLevel(){this._currentIdx<this._levels.length-1&&(this._currentIdx++,this._loadLevel())}_newLevel(){const t=this._levels.length+1,e=JSON.parse(JSON.stringify(this._levels[this._currentIdx]));e.id=`level_${String(t).padStart(2,"0")}`,e.name=`Level ${t}`,e.props=[],e.containers=[],e.transitZones=[{id:"zone_warp_01",type:"warp",x:Math.max(200,(e.worldW??3840)-200),width:120,targetLevel:null,label:"WARP"}],this._levels.push(e),this._currentIdx=this._levels.length-1,this._loadLevel()}async _testLevel(){await this._saveToServer(!0);const t=this._levels[this._currentIdx];this.registry.set("editorLevels",this._levels),this.scene.start("GameScene",{levelId:t.id,fromEditor:!0})}_showExport(){if(this._exportOverlay)return;const t=this._generateExportCode(),e=this.add.rectangle(c/2,d/2,c,d,0,.94).setDepth(9990).setInteractive(),s=this.add.text(c/2,12,"── EXPORT : js/config/levels.js ──",{fontFamily:"monospace",fontSize:"13px",color:"#4488ff"}).setOrigin(.5,0).setDepth(9991),i=this.add.text(c/2,30,"Copier ce code → coller dans js/config/levels.js  puis recharger",{fontFamily:"monospace",fontSize:"9px",color:"#888888"}).setOrigin(.5,0).setDepth(9991),a=this.add.text(6,48,t,{fontFamily:"monospace",fontSize:"8px",color:"#aaffaa"}).setDepth(9991),n=this.add.text(c-8,8,"[ FERMER ]",{fontFamily:"monospace",fontSize:"12px",color:"#ff6600"}).setOrigin(1,0).setDepth(9992).setInteractive({useHandCursor:!0});this._uiLayer.add([e,s,i,a,n]);const r=()=>{[e,s,i,a,n].forEach(h=>h.destroy()),this._exportOverlay=null};n.on("pointerdown",r),n.on("pointerover",()=>n.setColor("#ffffff")),n.on("pointerout",()=>n.setColor("#ff6600")),this._exportOverlay={bg:e,codeText:a,btnClose:n}}_generateExportCode(){const t=[];t.push("export const LEVELS = [");for(const e of this._levels){t.push("  {"),t.push(`    id: '${e.id}',`),t.push(`    name: '${e.name}',`),t.push(`    worldW: ${e.worldW??3840},`),t.push(`    parallax: { bg: ${e.parallax?.bg??.06}, mid: ${e.parallax?.mid??.25} },`),e.background&&t.push(`    background: '${e.background}',`),e.laneTop!=null&&t.push(`    laneTop: ${e.laneTop},`),e.laneBottom!=null&&t.push(`    laneBottom: ${e.laneBottom},`),e.spawnX!=null&&t.push(`    spawnX: ${e.spawnX},`),t.push("    props: [");for(const s of e.props??[]){const i=(s.blocksPlayer?", blocksPlayer: true":"")+(s.blocksEnemy?", blocksEnemy: true":"");t.push(`      { type: '${s.type}', x: ${s.x}, y: ${s.y}, scale: ${s.scale??1}${i} },`)}t.push("    ],"),t.push("    containers: [");for(const s of e.containers??[])t.push(`      { x: ${s.x}, y: ${s.y}, texture: '${s.texture??"barrel"}' },`);t.push("    ],"),t.push("    transitZones: [");for(const s of e.transitZones??[]){const i=s.targetLevel?`'${s.targetLevel}'`:"null",a=s.y!=null?`, y: ${s.y}`:"",n=s.height!=null?`, height: ${s.height}`:"";t.push(`      { id: '${s.id}', type: '${s.type}', x: ${s.x}${a}, width: ${s.width??120}${n}, targetLevel: ${i}, label: '${s.label??""}' },`)}t.push("    ],"),t.push("  },")}return t.push("];"),t.push(""),t.push("export const LEVEL_MAP = Object.fromEntries(LEVELS.map(l => [l.id, l]));"),t.join(`
`)}async _fetchLevelsFromServer(){if(!this.registry.get("editorLevels"))try{const t=await fetch(`${xt}/levels`);if(!t.ok)throw new Error(`HTTP ${t.status}`);const e=await t.json(),s=Array.isArray(e)?e.filter(i=>i!=null&&i.id):[];if(s.length===0)return;try{localStorage.getItem("RAGEDERUE_editor_levels")||(this._levels=s,this._currentIdx=0,this._loadLevel())}catch{this._levels=s,this._currentIdx=0,this._loadLevel()}console.log(`[Editor] ${s.length} niveau(x) chargé(s) depuis le serveur.`)}catch(t){console.info("[Editor] Serveur éditeur non disponible — niveaux locaux utilisés.",t.message)}}async _saveToServer(t=!1){const e=this._levels.filter(s=>s!=null&&s.id);try{const s=JSON.stringify(e);localStorage.setItem("RAGEDERUE_editor_levels",s),this.registry.set("editorLevels",e)}catch{}try{const s=await fetch(`${xt}/levels`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok)throw new Error(`HTTP ${s.status}`);t||this._showSaveFeedback(!0)}catch(s){console.error("[Editor] Erreur sauvegarde :",s.message),t||this._showSaveFeedback(!1)}}_showSaveFeedback(t){const e=t?"✓  Sauvegardé":"✗  Serveur non disponible — utiliser [ EXPORT ]",s=t?"#00ff88":"#ff6600",i=this.add.text(c/2,k+28,e,{fontFamily:"monospace",fontSize:"12px",color:s,backgroundColor:"#000000cc",padding:{x:8,y:4}}).setOrigin(.5,0).setDepth(9999);this._uiLayer.add(i),this.tweens.add({targets:i,alpha:0,duration:900,delay:1e3,onComplete:()=>i.destroy()})}}const tt=3;function V(o){if(o.setScale(tt),o.setDepth(o.y),o.shadow){const t=o.shadow;t.setPosition(o.x,o.y+o.displayHeight*.45),t.setScale(tt,tt*.3),t.setAlpha(.35),t.setDepth(o.y-.5)}}function ot(o,t){const e=o.add.ellipse(t.x,t.y,56,14,0,.35);return t.shadow=e,e}const ye={player_punch:{offsetX:48,offsetY:-22,w:52,h:30,dmg:15,kb:130},player_kick:{offsetX:55,offsetY:-16,w:62,h:28,dmg:20,kb:160},player_jab:{offsetX:42,offsetY:-22,w:46,h:28,dmg:10,kb:95},player_jump_kick:{offsetX:50,offsetY:-10,w:60,h:34,dmg:25,kb:200}},ge={player_punch:[2],player_kick:[2,3],player_jab:[2],player_jump_kick:[2]};class me extends Phaser.Physics.Arcade.Sprite{constructor(t,e,s,i=null){super(t,e,s,"player_idle"),t.add.existing(this),t.physics.add.existing(this),this.body.setSize(28,40),this.body.setOffset(34,20),this.body.setCollideWorldBounds(!0),this.hp=pt,this.maxHp=pt,this.combat=i,this.stamina=ft,this.maxStamina=ft,this._staminaRegenTimer=0,this.hunger=_t,this.maxHunger=_t,this._hungerDmgAccum=0,this.thirst=yt,this.maxThirst=yt,this._thirstDmgAccum=0,this.state="idle",this.isInvincible=!1,this.facing=1,this._isAirborne=!1,this._groundY=s,this.searching=!1,this.inInventory=!1,this.inMenu=!1,this.attackKeys={punch:t.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.X),kick:t.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.C),jab:t.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.V),jump:t.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE)},this._gpAttack={punch:!1,kick:!1,jab:!1,jump:!1},t.input.gamepad.on("down",(a,n)=>{if(!document.hasFocus())return;const r=this.scene.registry.get("padIndex")??0;r<0||a.index===r&&(this.searching||this.inInventory||this.inMenu||(n.index===2&&(this._gpAttack.punch=!0),n.index===1&&(this._gpAttack.kick=!0),n.index===3&&(this._gpAttack.jab=!0),n.index===0&&(this._gpAttack.jump=!0)))}),ot(t,this),this.play("player_idle"),this.on("animationupdate",(a,n)=>{if(!this.combat)return;const r=ye[a.key],h=ge[a.key];if(r&&h&&h.includes(n.index)){const l=Phaser.Math.Clamp(this.stamina/this.maxStamina,Vt,1),f=Math.max(1,Math.round(r.dmg*l));this.combat.activateHitbox(this,r.offsetX,r.offsetY,r.w,r.h,f,r.kb)}}),this.on("animationcomplete",a=>{this.combat&&this.combat.deactivateHitboxes(this),this.anims.timeScale=1,["player_punch","player_kick","player_jab"].includes(a.key)&&(this.state="idle",this.play("player_idle",!0)),a.key==="player_jump_kick"&&this.state,a.key==="player_hurt"&&this.state==="hurt"&&this.play("player_hurt",!0)})}update(t,e){if(this.searching||this.inInventory||this.inMenu){this.setVelocity(0,0),this.state!=="idle"&&this.state!=="hurt"&&(this.state="idle",this.play("player_idle",!0)),this._wasFrozen=!0;return}this._wasFrozen&&(this._wasFrozen=!1,this._gpAttack.punch=this._gpAttack.kick=this._gpAttack.jab=this._gpAttack.jump=!1),this.state==="hurt"?(this.body.setVelocityX(this.body.velocity.x*.78),this.body.setVelocityY(0)):["punch","kick","jab"].includes(this.state)?this.setVelocity(0,0):this.state==="jump"||this.state==="jump_kick"?this.body.setVelocityY(0):this._handleMovement(t,e),this._handleAttackInput(),this._updateSurvival(),V(this)}takeHit(t,e,s){if(this.isInvincible||this.state==="dead")return;if(this.hp=Math.max(0,this.hp-t),this.isInvincible=!0,this.combat&&this.combat.deactivateHitboxes(this),this.hp<=0){this.state="dead",this.setVelocity(0,0),this.play("player_hurt",!0),this.scene.sound.play("sfx_death_player",{volume:this.scene.registry.get("sfxVol")??.5});return}this.state="hurt";const i=this.x>=s?1:-1;this.setVelocity(i*e,0),this.play("player_hurt",!0),this.scene.sound.play("sfx_hit",{volume:this.scene.registry.get("sfxVol")??.5}),this.setAlpha(1);const a=this.scene.tweens.add({targets:this,alpha:{from:0,to:1},duration:60,repeat:-1,yoyo:!0});this.scene.time.delayedCall(Rt,()=>{a.stop(),this.setAlpha(1),this.isInvincible=!1,this.state="idle",this.play("player_idle",!0)})}_handleAttackInput(){if(this.state==="hurt"){this._gpAttack.punch=this._gpAttack.kick=this._gpAttack.jab=this._gpAttack.jump=!1;return}if(this.state==="kick"){this._gpAttack.punch=this._gpAttack.kick=this._gpAttack.jab=this._gpAttack.jump=!1;return}const t=Phaser.Input.Keyboard.JustDown(this.attackKeys.punch)||this._gpAttack.punch,e=Phaser.Input.Keyboard.JustDown(this.attackKeys.kick)||this._gpAttack.kick,s=Phaser.Input.Keyboard.JustDown(this.attackKeys.jab)||this._gpAttack.jab,i=Phaser.Input.Keyboard.JustDown(this.attackKeys.jump)||this._gpAttack.jump;if(this._gpAttack.punch=!1,this._gpAttack.kick=!1,this._gpAttack.jab=!1,this._gpAttack.jump=!1,this._isAirborne){(e||t)&&this.state==="jump"&&(this._drainStamina(ut),this._jumpKick());return}i&&this.state!=="punch"&&this.state!=="kick"&&this.state!=="jab"?this.stamina>=this.maxStamina*Nt&&(this._drainStamina(zt),this._startJump()):t?(this._drainStamina(Ht),this.anims.timeScale=Math.max(U,this.stamina/this.maxStamina),this.state="punch",this.play("player_punch",!0)):e?(this._drainStamina(ut),this.anims.timeScale=Math.max(U,this.stamina/this.maxStamina),this.state="kick",this.play("player_kick",!0)):s&&(this._drainStamina(Wt),this.anims.timeScale=Math.max(U,this.stamina/this.maxStamina),this.state="jab",this.play("player_jab",!0))}_startJump(){this.state="jump",this._isAirborne=!0,this._groundY=this.y,this.play("player_jump",!0),this.body.setVelocityY(0),this.scene.tweens.add({targets:this,y:this._groundY-Xt,duration:gt*.45,ease:"Sine.easeOut",onComplete:()=>{this.scene.tweens.add({targets:this,y:this._groundY,duration:gt*.55,ease:"Sine.easeIn",onComplete:()=>this._land()})}})}_jumpKick(){this.state="jump_kick",this.anims.timeScale=Math.max(U,this.stamina/this.maxStamina),this.play("player_jump_kick",!0)}_land(){this._isAirborne=!1,this.y=this._groundY,(this.state==="jump"||this.state==="jump_kick")&&(this.state="idle",this.play("player_idle",!0))}_updateSurvival(){if(this.state==="dead")return;const t=this.scene.game.loop.delta,e=t/1e3;this._staminaRegenTimer>0?this._staminaRegenTimer=Math.max(0,this._staminaRegenTimer-t):this.stamina=Math.min(this.maxStamina,this.stamina+Ft*e),this.hunger=Math.max(0,this.hunger-jt*e),this.hunger<=0?(this._hungerDmgAccum+=t,this._hungerDmgAccum>=1e3&&(this._hungerDmgAccum-=1e3,this.hp=Math.max(0,this.hp-Gt))):this._hungerDmgAccum=0,this.thirst=Math.max(0,this.thirst-Ut*e),this.thirst<=0?(this._thirstDmgAccum+=t,this._thirstDmgAccum>=1e3&&(this._thirstDmgAccum-=1e3,this.hp=Math.max(0,this.hp-Yt))):this._thirstDmgAccum=0}_drainStamina(t){this.stamina=Math.max(0,this.stamina-t),this._staminaRegenTimer=Bt}_handleMovement(t,e){const s=t.left.isDown||e.left.isDown,i=t.right.isDown||e.right.isDown,a=t.up.isDown||e.up.isDown,n=t.down.isDown||e.down.isDown;let r=0,h=0;const l=this.scene.registry.get("padIndex")??0,f=this.scene.input.gamepad;if(l>=0&&f&&f.total>0&&document.hasFocus()){const m=f.getPad(l);m&&(Math.abs(m.leftStick.x)>.15&&(r=m.leftStick.x),Math.abs(m.leftStick.y)>.15&&(h=m.leftStick.y),m.left.isDown&&(r=-1),m.right.isDown&&(r=1),m.up.isDown&&(h=-1),m.down.isDown&&(h=1))}let u=r*M,p=h*M*.6;if(s&&(u-=M),i&&(u+=M),a&&(p-=M*.6),n&&(p+=M*.6),(s||i)&&(a||n)&&r===0&&h===0&&(u*=.707,p*=.707),r!==0&&h!==0){const m=Math.sqrt(u*u+p*p);m>M&&(u=u/m*M,p=p/m*M*.6)}this.stamina<=0&&(u*=.6,p*=.6),this.setVelocity(u,p),this.y=Phaser.Math.Clamp(this.y,this.scene.laneTop??v,this.scene.laneBottom??w),u<0?(this.setFlipX(!0),this.facing=-1):u>0&&(this.setFlipX(!1),this.facing=1);const g=Math.abs(u)>1||Math.abs(p)>1;g&&this.state!=="walk"?(this.state="walk",this.play("player_walk",!0)):!g&&this.state!=="idle"&&(this.state="idle",this.play("player_idle",!0))}}class xe extends Phaser.Physics.Arcade.Sprite{constructor(t,e,s,i,a={}){super(t,e,s,"enemy_idle"),t.add.existing(this),t.physics.add.existing(this),this.body.setSize(28,40),this.body.setOffset(34,20),this.combat=i,this.hp=a.hp??Kt,this.maxHp=this.hp,this.speed=a.speed??$t,this.attackDamage=a.attackDamage??10,this.attackKnockback=a.attackKnockback??110,this.state="patrol",this.isInvincible=!1,this.attackCooldown=0,this.accumulatedDmg=0,this.facing=1,this.netId=0,this.patrolLeft=e-160,this.patrolRight=e+160,this.patrolDir=1,ot(t,this),this.play("enemy_idle"),this.on("animationupdate",(n,r)=>{n.key==="enemy_punch"&&r.index===2&&this.combat.activateHitbox(this,50,-22,58,32,this.attackDamage,this.attackKnockback)}),this.on("animationcomplete",n=>this._onAnimComplete(n))}_onAnimComplete(t){this.active&&(this.combat.deactivateHitboxes(this),t.key==="enemy_punch"&&this.state==="attack"&&(this.state="chase"),t.key==="enemy_hurt"&&this.state==="knockdown"&&(this.setVelocity(0,0),this.anims.pause(),this.scene.time.delayedCall(te,()=>{this.state==="knockdown"&&(this.isInvincible=!1,this.state="chase",this.play("enemy_idle",!0))})))}update(t){if(this.state==="dead")return;this.attackCooldown-=this.scene.game.loop.delta;const e=t.x-this.x,s=t.y-this.y,i=Math.sqrt(e*e+s*s);switch(this.state){case"patrol":{this._doPatrol(),i<Zt&&(this.state="chase");break}case"chase":{i<Jt&&this.attackCooldown<=0?this._startAttack():this._chasePlayer(e,s,i,t);break}case"attack":{this.setVelocity(0,0);break}case"hitstun":{this.setVelocityX(this.body.velocity.x*.75),this.setVelocityY(0);break}case"knockdown":{this.setVelocityX(this.body.velocity.x*.85),this.setVelocityY(0);break}}V(this)}takeHit(t,e,s){if(this.isInvincible||this.state==="dead")return;if(this.hp-=t,this.hp<=0){this._die();return}this.combat.deactivateHitboxes(this);const i=this.x>=s?1:-1;this.accumulatedDmg+=t,this.accumulatedDmg>=qt?this._knockdown(i,e):this._hitstun(i)}_hitstun(t){this.state="hitstun",this.isInvincible=!0,this.setVelocity(t*50,0),this.scene.sound.play("sfx_hit",{volume:this.scene.registry.get("sfxVol")??.5}),this.setTint(16729156),this.scene.time.delayedCall(Qt,()=>{this.active&&this.state==="hitstun"&&(this.clearTint(),this.isInvincible=!1,this.state="chase",this.play("enemy_idle",!0))})}_knockdown(t,e){this.state="knockdown",this.isInvincible=!0,this.accumulatedDmg=0,this.clearTint(),this.play("enemy_hurt",!0),this.scene.sound.play("sfx_hit",{volume:this.scene.registry.get("sfxVol")??.5}),this.setVelocity(t*e*2.2,0);const s=this.y,i=40,a=400;this.scene.tweens.add({targets:this,y:s-i,duration:a*.4,ease:"Sine.easeOut",onComplete:()=>{this.active&&this.scene.tweens.add({targets:this,y:s,duration:a*.6,ease:"Sine.easeIn",onComplete:()=>{this.active&&this.setVelocity(0,0)}})}}),this.scene.tweens.add({targets:this,angle:t*360,duration:a,ease:"Linear",onComplete:()=>{this.active&&this.setAngle(0)}})}_doPatrol(){const t=this.patrolDir>0?this.patrolRight:this.patrolLeft;if(Math.abs(this.x-t)<6){this.patrolDir*=-1,this.setVelocity(0,0),this.play("enemy_idle",!0);return}this.facing=this.patrolDir>0?1:-1,this.setVelocity(this.patrolDir*this.speed*.5,0),this.setFlipX(this.facing>0),this.play("enemy_walk",!0)}_chasePlayer(t,e,s,i){if(s<2){this.setVelocity(0,0);return}const a=t/s,n=e/s;this.facing=t>0?1:-1,this.setVelocity(a*this.speed,n*this.speed*.6),this.y=Phaser.Math.Clamp(this.y,this.scene.laneTop??v,this.scene.laneBottom??w),this.setFlipX(this.facing>0),this.play("enemy_walk",!0)}_startAttack(){this.state="attack",this.attackCooldown=2200,this.setVelocity(0,0),this.play("enemy_punch",!0)}_die(t=!1){this.state="dead",this.isInvincible=!0,this.combat.deactivateHitboxes(this),this.setVelocity(0,0),this.scene.tweens.killTweensOf(this),this.setAngle(0),t||this.scene.sound.play("sfx_death_enemy",{volume:this.scene.registry.get("sfxVol")??.5}),(!this.lootItems||this.lootItems.length===0)&&(this.lootItems=[]),this.searched=!1,this.searchable=!0,this.opened=!1,t?(this.play("enemy_hurt",!0),this.anims.setProgress(1),this.anims.pause(),this.setAlpha(.65)):(this.play("enemy_hurt",!0),this.once("animationcomplete-enemy_hurt",()=>{this.active&&(this.anims.pause(),this.setAlpha(.65))})),V(this)}markSearched(){this.searched=!0,this.setAlpha(.35)}destroy(){this.shadow&&(this.shadow.destroy(),this.shadow=null),this.scene&&this.scene.tweens.killTweensOf(this),this.combat?.deactivateHitboxes(this),super.destroy()}}class be extends xe{constructor(t,e,s,i,a={}){super(t,e,s,i,a),this.isRemote=!0,this._targetX=e,this._targetY=s}update(t){if(this.state==="dead")return;const e=Math.min(1,10*(this.scene.game.loop.delta/1e3));this.x+=(this._targetX-this.x)*e,this.y+=(this._targetY-this.y)*e,this.y=Phaser.Math.Clamp(this.y,this.scene.laneTop??v,this.scene.laneBottom??w),V(this)}takeHit(t,e,s){this.state!=="dead"&&(this.scene.sound.play("sfx_hit",{volume:this.scene.registry.get("sfxVol")??.5}),this.setTint(16729156),this.scene.time.delayedCall(150,()=>{this.active&&this.clearTint()}))}_onAnimComplete(t){this.active&&this.combat.deactivateHitboxes(this)}applyNetState(t){if(this._targetX=t.x,this._targetY=t.y,this.state==="dead"){this.hp=t.hp;return}if(t.facing!==this.facing&&(this.facing=t.facing,this.setFlipX(this.facing>0)),t.state!==this.state){if(t.state==="dead"){this._die(!!this._justCreated);return}switch(this.state=t.state,t.state){case"patrol":this.play("enemy_idle",!0);break;case"chase":this.play("enemy_walk",!0);break;case"attack":this.play("enemy_punch",!0);break;case"knockdown":this.play("enemy_hurt",!0);break;case"hitstun":this.setTint(16729156),this.scene.time.delayedCall(200,()=>{this.active&&this.clearTint()});break;default:this.play("enemy_idle",!0)}}this.hp=t.hp}}class Se{constructor(t){this.scene=t,this.activeHitboxes=[],this.onHit=null}activateHitbox(t,e,s,i,a,n,r){const h=t.facing??1,l=new Phaser.Geom.Rectangle(t.x+e*h-i/2,t.y+s-a/2,i,a);this.activeHitboxes.push({rect:l,owner:t,damage:n,knockback:r,used:!1})}deactivateHitboxes(t){this.activeHitboxes=this.activeHitboxes.filter(e=>e.owner!==t)}update(t){for(const e of this.activeHitboxes)if(!e.used)for(const s of t){if(s===e.owner||!s.active||s.isInvincible||s.state==="dead")continue;const i=s.displayWidth*.5,a=s.displayHeight*.8,n=new Phaser.Geom.Rectangle(s.x-i/2,s.y-a,i,a);if(Phaser.Geom.Intersects.RectangleToRectangle(e.rect,n)){s.takeHit(e.damage,e.knockback,e.owner.x),this.onHit&&this.onHit(e.owner,s,e.damage,e.knockback),e.used=!0;break}}this.activeHitboxes=this.activeHitboxes.filter(e=>!e.used)}}const q={ethereum:{texture:"eth",invW:1,invH:1,useTime:0,healAmount:0,value:100,displayW:32,displayH:32,glowColor:65484,description:"Ethereum token — extract it!"},sushi:{texture:"sushi",invW:2,invH:1,useTime:1500,healAmount:20,hungerRestore:35,value:0,displayW:40,displayH:29,glowColor:16746666,description:"Sushi — +20 HP, +35 faim"},pizza:{texture:"pizza",invW:2,invH:2,useTime:2e3,healAmount:35,hungerRestore:50,value:0,displayW:40,displayH:21,glowColor:16737826,description:"Pizza — +35 HP, +50 faim"},ice_cream:{texture:"ice_cream",invW:1,invH:2,useTime:1200,healAmount:15,hungerRestore:20,thirstRestore:15,value:0,displayW:28,displayH:42,glowColor:11197951,description:"Ice Cream — +15 HP, +20 faim, +15 soif"},water_bottle:{texture:"ice_cream",invW:1,invH:1,useTime:800,healAmount:0,thirstRestore:50,value:0,displayW:28,displayH:42,glowColor:4500223,description:"Bouteille d'eau — +50 soif"}},ke=[{type:"ethereum",weight:15},{type:"sushi",weight:25},{type:"pizza",weight:15},{type:"ice_cream",weight:25},{type:"water_bottle",weight:20}],bt={min:1,max:3},ve=800,we=600,Te=6400;function Ie(o,t){const e=o.reduce((i,a)=>i+a.weight,0),s=[];for(let i=0;i<t;i++){let a=Math.random()*e;for(const n of o)if(a-=n.weight,a<=0){s.push(n.type);break}}return s}class Ee{constructor(t,e,s,i,a={}){if(this.scene=t,this.x=e,this.y=s,this.netId=a.netId??-1,this.image=t.add.image(e,s,i).setOrigin(.5,1),this.image.setDepth(s),this.searchable=!0,this.searched=!1,this.opened=!1,a.skipLoot)this.lootItems=[];else{const n=Phaser.Math.Between(bt.min,bt.max);this.lootItems=Ie(ke,n)}}markSearched(){this.searched=!0,this.image.setAlpha(.4)}destroy(){this.image.destroy()}}const Pe=64;class Ce{constructor(t){this.scene=t,this.containers=[],this.nearestTarget=null}spawnContainers(t){t.forEach((e,s)=>{this.containers.push(new Ee(this.scene,e.x,e.y,e.texture,{netId:s,skipLoot:!0}))})}update(t,e){let s=null,i=Pe;for(const a of this.containers){if(a.searched)continue;const n=Phaser.Math.Distance.Between(t.x,t.y,a.x,a.y);n<i&&(i=n,s=a)}for(const a of e){if(a.state!=="dead"||!a.searchable||a.searched)continue;const n=Phaser.Math.Distance.Between(t.x,t.y,a.x,a.y);n<i&&(i=n,s=a)}return this.nearestTarget=s,s?{target:s,dist:i}:null}destroyAll(){this.containers.forEach(t=>t.destroy()),this.containers=[]}resetContainers(){this.containers.forEach(t=>{t.searched=!1,t.lootItems=[]}),this.nearestTarget=null}}const St=6,kt=4;class Me{constructor(t,e=0,s=0,i=!0){this.type=t,this.def=q[t],this.gridX=e,this.gridY=s,this.identified=i}}class Ae{constructor(){this.cols=St,this.rows=kt,this.grid=Array.from({length:kt},()=>Array(St).fill(null)),this.items=[]}addItem(t,e=!0){const s=q[t];if(!s)return null;const i=this._findSlot(s.invW,s.invH);if(!i)return null;const a=new Me(t,i.x,i.y,e);return this._placeItem(a),this.items.push(a),a}removeItem(t){const e=this.items.indexOf(t);e!==-1&&(this.items.splice(e,1),this._clearCells(t))}useItem(t,e){return!t.def.useTime&&!t.def.healAmount&&!t.def.value?!1:(t.def.healAmount>0&&(e.hp=Math.min(e.maxHp,e.hp+t.def.healAmount)),t.def.hungerRestore>0&&(e.hunger=Math.min(e.maxHunger,e.hunger+t.def.hungerRestore)),t.def.thirstRestore>0&&(e.thirst=Math.min(e.maxThirst,e.thirst+t.def.thirstRestore)),t.def.value>0&&(e.wallet=(e.wallet??0)+t.def.value),this.removeItem(t),!0)}hasRoom(t){const e=q[t];return e?this._findSlot(e.invW,e.invH)!==null:!1}get totalValue(){return this.items.reduce((t,e)=>t+(e.def.value??0),0)}_findSlot(t,e){for(let s=0;s<=this.rows-e;s++)for(let i=0;i<=this.cols-t;i++)if(this._canPlace(i,s,t,e))return{x:i,y:s};return null}_canPlace(t,e,s,i){for(let a=e;a<e+i;a++)for(let n=t;n<t+s;n++)if(this.grid[a][n]!==null)return!1;return!0}_placeItem(t){const{invW:e,invH:s}=t.def;for(let i=t.gridY;i<t.gridY+s;i++)for(let a=t.gridX;a<t.gridX+e;a++)this.grid[i][a]=t}_clearCells(t){for(let e=0;e<this.rows;e++)for(let s=0;s<this.cols;s++)this.grid[e][s]===t&&(this.grid[e][s]=null)}}const Le=1,De=2,Oe=7,Re=8,Fe=128,Be=129,He=130,We=131,ze=133,Ne=134,Ve=135,je=136,Ge=["ethereum","sushi","pizza","ice_cream"],Pt=["idle","walk","punch","kick","jab","jump","jump_kick","hurt","dead"],Ct={};Pt.forEach((o,t)=>{Ct[o]=t});const Ue=["patrol","chase","attack","hitstun","knockdown","dead"];function Ye(o,t){const e=new TextEncoder().encode(o),s=new TextEncoder().encode(t),i=new ArrayBuffer(2+e.length+1+s.length),a=new DataView(i),n=new Uint8Array(i);let r=0;return a.setUint8(r++,Le),a.setUint8(r++,e.length),n.set(e,r),r+=e.length,a.setUint8(r++,s.length),n.set(s,r),i}function Xe(o,t,e,s,i,a,n){const r=new ArrayBuffer(15),h=new DataView(r);h.setUint8(0,De),h.setFloat32(1,o,!0),h.setFloat32(5,t,!0),h.setInt16(9,Math.round(e),!0),h.setInt16(11,Math.round(s),!0),h.setUint8(13,Ct[i]??0);const l=a>0?0:128;return h.setUint8(14,l|Math.min(n,127)&127),r}function $e(o){return{playerId:new DataView(o instanceof ArrayBuffer?o:o.buffer).getUint16(1,!0)}}function Ke(o){const t=new DataView(o instanceof ArrayBuffer?o:o.buffer,o.byteOffset??0),e=t.getUint8(1),s=[];let i=2;for(let a=0;a<e;a++){const n=t.getUint16(i,!0);i+=2;const r=t.getFloat32(i,!0);i+=4;const h=t.getFloat32(i,!0);i+=4;const l=t.getInt16(i,!0);i+=2;const f=t.getInt16(i,!0);i+=2;const u=t.getUint8(i);i+=1;const p=t.getUint8(i);i+=1;const y=p&128?-1:1,g=p&127;s.push({id:n,x:r,y:h,velX:l,velY:f,state:Pt[u]||"idle",facing:y,hp:g})}return{players:s}}function Ze(o){const t=new DataView(o instanceof ArrayBuffer?o:o.buffer,o.byteOffset??0),e=new Uint8Array(o instanceof ArrayBuffer?o:o.buffer),s=t.getUint16(1,!0),i=t.getUint8(3),a=new TextDecoder().decode(e.slice(4,4+i));return{id:s,name:a}}function Je(o){return{id:new DataView(o instanceof ArrayBuffer?o:o.buffer,o.byteOffset??0).getUint16(1,!0)}}function qe(o){return new Uint8Array(o instanceof ArrayBuffer?o:o.buffer,o.byteOffset??0)[0]}function Qe(o,t,e){const s=new ArrayBuffer(5),i=new DataView(s);return i.setUint8(0,Re),i.setUint8(1,o),i.setUint16(2,t,!0),i.setUint8(4,e),s}function ts(o,t,e,s){const i=new ArrayBuffer(9),a=new DataView(i);return a.setUint8(0,Oe),a.setUint16(1,o,!0),a.setUint8(3,Math.min(t,255)),a.setUint8(4,Math.min(e,255)),a.setFloat32(5,s,!0),i}function es(o){const t=new DataView(o instanceof ArrayBuffer?o:o.buffer,o.byteOffset??0),e=t.getUint8(1),s=t.getUint16(2,!0),i=t.getUint8(4),a=[];for(let n=0;n<i;n++){const r=t.getUint8(5+n);a.push(Ge[r]||"ethereum")}return{targetKind:e,targetId:s,items:a}}function vt(o){return{remainingTime:new DataView(o instanceof ArrayBuffer?o:o.buffer,o.byteOffset??0).getFloat32(1,!0)}}function ss(o){const t=new DataView(o instanceof ArrayBuffer?o:o.buffer,o.byteOffset??0),e=t.getUint8(1),s=[];let i=2;for(let a=0;a<e;a++){const n=t.getUint16(i,!0);i+=2;const r=t.getFloat32(i,!0);i+=4;const h=t.getFloat32(i,!0);i+=4;const l=t.getUint8(i);i+=1;const f=t.getUint8(i);i+=1;const u=t.getUint8(i)?1:-1;i+=1,s.push({netId:n,x:r,y:h,hp:l,state:Ue[f]||"patrol",facing:u})}return{enemies:s}}class is{constructor(){this.ws=null,this.connected=!1,this.playerId=-1,this.onWelcome=null,this.onSnapshot=null,this.onPlayerJoin=null,this.onPlayerLeave=null,this.onEnemySnapshot=null,this.onLootData=null,this.onWorldReset=null,this.onTimerSync=null,this.onDisconnect=null,this._sendInterval=50,this._lastSendTime=0}autoConnect(t="Player"){const e=new URLSearchParams(window.location.search),s=e.get("server")||"localhost",i=e.get("port")||"9000",a=e.get("name")||t,n=e.get("room")||"street_01",l=`${e.get("ssl")==="true"||window.location.protocol==="https:"?"wss":"ws"}://${s}:${i}`;return this.connect(l,a,n),!0}connect(t,e,s){console.log(`[Net] Connecting to ${t}...`),this.ws=new WebSocket(t),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{console.log("[Net] Connected"),this.connected=!0,this.ws.send(Ye(e,s))},this.ws.onmessage=i=>{this._handleMessage(i.data)},this.ws.onclose=()=>{console.log("[Net] Disconnected"),this.connected=!1,this.onDisconnect&&this.onDisconnect()},this.ws.onerror=i=>{console.warn("[Net] WebSocket error",i)}}sendState(t,e,s,i,a,n,r){if(!this.connected)return;const h=performance.now();h-this._lastSendTime<this._sendInterval||(this._lastSendTime=h,this.ws.send(Xe(t,e,s,i,a,n,r)))}sendHitEnemy(t,e,s,i){this.connected&&this.ws.send(ts(t,e,s,i))}sendTakeItem(t,e,s){this.connected&&this.ws.send(Qe(t,e,s))}disconnect(){this.ws&&(this.ws.close(),this.ws=null),this.connected=!1}_handleMessage(t){const e=qe(t);switch(e){case Fe:{const{playerId:s}=$e(t);this.playerId=s,console.log(`[Net] Welcome! id=${s}`),this.onWelcome&&this.onWelcome(s);break}case Be:{const{players:s}=Ke(t);this.onSnapshot&&this.onSnapshot(s);break}case He:{const{id:s,name:i}=Ze(t);console.log(`[Net] Player joined: ${i} (id=${s})`),this.onPlayerJoin&&this.onPlayerJoin(s,i);break}case We:{const{id:s}=Je(t);console.log(`[Net] Player left: id=${s}`),this.onPlayerLeave&&this.onPlayerLeave(s);break}case ze:{const{enemies:s}=ss(t);this.onEnemySnapshot&&this.onEnemySnapshot(s);break}case Ne:{const{targetKind:s,targetId:i,items:a}=es(t);this.onLootData&&this.onLootData(s,i,a);break}case Ve:{const{remainingTime:s}=vt(t);console.log(`[Net] World reset! Timer: ${s}s`),this.onWorldReset&&this.onWorldReset(s);break}case je:{const{remainingTime:s}=vt(t);this.onTimerSync&&this.onTimerSync(s);break}default:console.warn(`[Net] Unknown message type: 0x${e.toString(16)}`)}}}const wt=290,Tt=290;class as{constructor(t){this.scene=t,this.bgLayer=null,this.midLayer=null,this.bgSpeed=.06,this.midSpeed=.25,this.blockingGroup=null}build(t){const e=this.scene,{parallax:s,props:i,transitZones:a,background:n}=t;let{worldW:r}=t;const h=t.laneTop??v,l=t.laneBottom??w;if(this.bgSpeed=s?.bg??.06,this.midSpeed=s?.mid??.25,n&&e.textures.exists(n)){const u=e.textures.get(n).source[0],p=d/u.height;r=Math.round(u.width*p),e.add.image(0,0,n).setOrigin(0,0).setScale(p).setDepth(0),this.bgLayer=null,this.midLayer=null}else{this.bgLayer=e.add.tileSprite(0,0,c,wt,"back").setOrigin(0,0).setScrollFactor(0).setDepth(0),this.midLayer=e.add.tileSprite(0,wt-60,c,200,"tileset").setOrigin(0,0).setScrollFactor(0).setDepth(5);const f=e.add.graphics();f.fillStyle(2763322),f.fillRect(0,Tt,c,d-Tt),f.fillStyle(3355461),f.fillRect(0,h,c,l-h),f.fillStyle(8947865,.4),f.fillRect(0,h-2,c,3),f.setScrollFactor(0).setDepth(8)}if(e.physics.world.setBounds(0,0,r,d),e.cameras.main.setBounds(0,0,r,d),this.blockingGroup=e.physics.add.staticGroup(),i.forEach(f=>this._placeProp(f)),t.forePositions?.length)for(const f of t.forePositions)this._placeProp({type:"fore",x:f,y:h-20,scale:1.2});a.forEach(f=>this._buildTransitZone(f,h,l))}updateParallax(t){this.bgLayer&&(this.bgLayer.tilePositionX=t*this.bgSpeed),this.midLayer&&(this.midLayer.tilePositionX=t*this.midSpeed)}_placeProp(t){if(t.blocksPlayer){const s=this.blockingGroup.create(t.x,t.y,t.type);return s.setOrigin(.5,1).setScale(t.scale??1).setDepth(t.y),s.refreshBody(),s}const e=this.scene.add.image(t.x,t.y,t.type).setOrigin(.5,1);return t.scale!=null&&e.setScale(t.scale),e.setDepth(t.y),e}_buildTransitZone(t,e=v,s=w){const i=this.scene,a=t.y??e-30,n=t.height??s-e+60,r=t.width??120,h=t.type==="warp"?52479:65416,l=t.type==="warp"?"#003344":"#003322",f=t.type==="warp"?"#00ccff":"#00ff88",u=i.add.graphics();u.fillStyle(h,.12),u.fillRect(t.x,a,r,n),u.lineStyle(2,h,.9),u.strokeRect(t.x,a,r,n),u.setDepth(e-5);const p=t.type==="warp"?`► ${t.label??t.targetLevel??"WARP"} ►`:`▼  ${t.label??"EXTRACT"}  ▼`,y=i.add.text(t.x+r/2,a-40,p,{fontFamily:"monospace",fontSize:"16px",color:f,stroke:l,strokeThickness:3}).setOrigin(.5).setDepth(e-4);i.tweens.add({targets:[u,y],alpha:.25,duration:850,yoyo:!0,repeat:-1})}}class ns{constructor(t){this.scene=t,this.cursors=null,this.wasd=null}setup(t){const e=this.scene,{onInteract:s,onInventory:i,onSettings:a}=t;this.cursors=e.input.keyboard.createCursorKeys();const n=e.input.keyboard,r=n.addKey(Phaser.Input.Keyboard.KeyCodes.W),h=n.addKey(Phaser.Input.Keyboard.KeyCodes.A),l=n.addKey(Phaser.Input.Keyboard.KeyCodes.S),f=n.addKey(Phaser.Input.Keyboard.KeyCodes.D),u=n.addKey(Phaser.Input.Keyboard.KeyCodes.Z),p=n.addKey(Phaser.Input.Keyboard.KeyCodes.Q),y=(g,m)=>({get isDown(){return g.isDown||m.isDown}});if(this.wasd={up:y(r,u),down:y(l,l),left:y(h,p),right:y(f,f)},e.input.keyboard.on("keydown-E",()=>{e.registry.set("inputMode","kb"),s()}),e.input.keyboard.on("keydown-TAB",g=>{g.preventDefault(),e.registry.set("inputMode","kb"),i()}),e.input.keyboard.on("keydown-ESC",()=>{e.registry.set("inputMode","kb"),a()}),e.input.keyboard.on("keydown",()=>{e.registry.set("inputMode","kb")}),e.input.gamepad.on("down",(g,m)=>{if(!document.hasFocus())return;const C=e.registry.get("padIndex")??0;C<0||g.index===C&&(e.registry.set("inputMode","gp"),!(e.player.searching||e.player.inMenu)&&(m.index===9&&a(),m.index===3&&s(),m.index===8&&i()))}),e.registry.get("padIndex")===void 0){const g=parseInt(localStorage.getItem("RAGEDERUE_padIndex")??"0",10);e.registry.set("padIndex",g)}}}class rs extends Phaser.Physics.Arcade.Sprite{constructor(t,e,s,i,a){super(t,i,a,"player_idle"),t.add.existing(this),t.physics.add.existing(this),this.body.setSize(28,40),this.body.setOffset(34,20),this.netId=e,this.netName=s,this.state="idle",this.facing=1,this.hp=100,this.setScale(2),this._targetX=i,this._targetY=a,this._lerpSpeed=10,this._nameTag=t.add.text(i,a-50,s,{fontFamily:"monospace",fontSize:"10px",color:"#88ccff",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(9999),ot(t,this),this.play("player_idle")}applySnapshot(t){this._targetX=t.x,this._targetY=t.y,this.hp=t.hp;const e=t.facing;if(e!==this.facing&&(this.facing=e,this.setFlipX(this.facing<0)),t.state!==this.state){this.state=t.state;const s=`player_${this.state}`;this.scene.anims.exists(s)&&this.play(s,!0)}}update(t,e){const s=e/1e3,i=Math.min(1,this._lerpSpeed*s);this.x+=(this._targetX-this.x)*i,this.y+=(this._targetY-this.y)*i,this.y=Phaser.Math.Clamp(this.y,this.scene.laneTop??v,this.scene.laneBottom??w),this._nameTag.setPosition(this.x,this.y-50),V(this)}destroy(){this._nameTag&&this._nameTag.destroy(),super.destroy()}}class os{constructor(t){this.scene=t}setup(){const t=this.scene,e=t.net;e.onWelcome=s=>{console.log(`[Game] Connected as player #${s}`)},e.onSnapshot=s=>{const i=new Set;for(const a of s){if(a.id===e.playerId)continue;i.add(a.id);let n=t.remotePlayers.get(a.id);n||(n=new rs(t,a.id,`Player ${a.id}`,a.x,a.y),t.remotePlayers.set(a.id,n)),n.applySnapshot(a)}for(const[a,n]of t.remotePlayers)i.has(a)||(n.destroy(),t.remotePlayers.delete(a))},e.onEnemySnapshot=s=>{t._syncEnemiesFromServer(s)},e.onLootData=(s,i,a)=>{if(s===0){const n=t.lootSystem.containers.find(r=>r.netId===i);n&&(n.lootItems=a)}else{const n=t.enemies.find(r=>r.netId===i);n?(n.lootItems=a,n.searchable=!0,n.searched=!1):t._pendingCorpseLoot.set(i,a)}},e.onTimerSync=s=>{t.runTimer=s},e.onWorldReset=s=>{console.log("[Game] World reset received — new timer:",s),t._handleWorldReset(s)},e.onPlayerLeave=s=>{const i=t.remotePlayers.get(s);i&&(i.destroy(),t.remotePlayers.delete(s))},e.onDisconnect=()=>{console.log("[Game] Disconnected from server"),t._endGame("over","DISCONNECTED")}}}const et=5e3,J=280,st=12,it=(c-J)/2,X=d-56;class hs extends Phaser.Scene{constructor(){super({key:"GameScene"})}create(t){this._gameEnded=!1,this.runTimer=Te,this._pendingCorpseLoot=new Map,this.registry.set("inputMode","kb");const e=t&&t.levelId||B[0].id;this._fromEditor=!!(t&&t.fromEditor);const s=this._fromEditor&&this.registry.get("editorLevels")||B;this._levelConfig=s.find(n=>n.id===e)||B[0],this.laneTop=this._levelConfig.laneTop??v,this.laneBottom=this._levelConfig.laneBottom??w,this.net=new is,this.remotePlayers=new Map,this.net.autoConnect("Player"),this.world=new as(this),this.world.build(this._levelConfig),this.netHandlers=new os(this),this.netHandlers.setup(),this.combat=new Se(this),this.combat.onHit=(n,r,h,l)=>{n===this.player&&r.netId!=null&&this.net.sendHitEnemy(r.netId,h,l,n.x)};const i=this._levelConfig.spawnX??150;this.player=new me(this,i,this.laneBottom-10,this.combat),this.player.wallet=0,this.cameras.main.startFollow(this.player,!0,.1,.1),this.physics.add.collider(this.player,this.world.blockingGroup),this.enemies=[],this.enemiesGroup=this.physics.add.group(),this.inventory=new Ae,this.lootSystem=new Ce(this),this.lootSystem.spawnContainers(this._levelConfig.containers),this.inputCtrl=new ns(this),this.inputCtrl.setup({onInteract:()=>this._interact(),onInventory:()=>this._openInventory(),onSettings:()=>this._toggleSettings()}),this.scene.launch("HUDScene",{player:this.player,inventory:this.inventory}),this._searchPrompt=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"11px",color:"#ffcc00",stroke:"#000000",strokeThickness:3}).setOrigin(.5).setDepth(9999).setVisible(!1),this.tweens.add({targets:this._searchPrompt,alpha:.4,duration:600,yoyo:!0,repeat:-1}),this._transitZone=null,this._transitTimer=0,this._transitActive=!1,this._transitPrompt=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"12px",color:"#00ff88",stroke:"#000000",strokeThickness:4}).setOrigin(.5).setDepth(9998).setVisible(!1),this.tweens.add({targets:this._transitPrompt,alpha:.3,duration:700,yoyo:!0,repeat:-1}),this._transitBarBg=this.add.graphics().setScrollFactor(0).setDepth(9998).setVisible(!1),this._transitBarFill=this.add.graphics().setScrollFactor(0).setDepth(9999).setVisible(!1),this._transitBarLabel=this.add.text(c/2,X-18,"",{fontFamily:"monospace",fontSize:"13px",color:"#00ff88",stroke:"#000000",strokeThickness:4}).setOrigin(.5).setScrollFactor(0).setDepth(9999).setVisible(!1),this.sound.stopByKey("music_street"),this.sound.stopByKey("music_naval");const a=parseFloat(localStorage.getItem("RAGEDERUE_music_vol")??"0.5");this.bgMusic=this.sound.add("music_street",{loop:!0,volume:a}),this.bgMusic.play(),this.registry.set("sfxVol",parseFloat(localStorage.getItem("RAGEDERUE_sfx_vol")??"0.5")),this._searchCooldown=0,this.scene.get("SearchScene").events.on("shutdown",()=>{this._searchCooldown=500})}update(t,e){if(this._gameEnded)return;if(this._searchCooldown>0&&(this._searchCooldown-=e),this.enemies=this.enemies.filter(a=>a.active),this.player.update(this.inputCtrl.cursors,this.inputCtrl.wasd),this.enemies.forEach(a=>a.update(this.player)),this.combat.update([this.player,...this.enemies]),this.player.hp<=0)return this._endGame("over","DEAD");this.registry.set("runTimer",this.runTimer);const s=this.lootSystem.update(this.player,this.enemies);if(s){const a=this.registry.get("inputMode")==="gp";this._searchPrompt.setText(a?"[Y] Search":"[E] Search").setVisible(!0),this._searchPrompt.setPosition(s.target.x,(s.target.y??s.target.image?.y??this.player.y)-60)}else this._searchPrompt.setVisible(!1);let i=null;for(const a of this._levelConfig.transitZones){const n=a.x+(a.width??120),r=a.y??this.laneTop-30,h=r+(a.height??this.laneBottom-this.laneTop+60);if(this.player.x>=a.x&&this.player.x<=n&&this.player.y>=r&&this.player.y<=h){i=a;break}}if(this._transitZone=i,this._transitActive&&!i&&this._cancelTransit(),this._transitActive&&i){this._transitTimer+=e;const a=Math.min(1,this._transitTimer/et);if(this._updateTransitBar(a,i),this._transitTimer>=et){if(i.type==="extract")return this.player.wallet=this.inventory.totalValue,this._endGame("win","");if(i.type==="warp"&&i.targetLevel)return this._warpToLevel(i.targetLevel)}}if(i&&!this._transitActive){const n=this.registry.get("inputMode")==="gp"?"[Y]":"[E]",r=i.type==="extract"?"Extraire":i.label??"Entrer",h=i.width??120,l=i.y??this.laneTop-30;this._transitPrompt.setText(`${n} ${r}`).setPosition(i.x+h/2,l-18).setVisible(!0)}else this._transitPrompt.setVisible(!1);this.net.sendState(this.player.x,this.player.y,this.player.body.velocity.x,this.player.body.velocity.y,this.player.state,this.player.facing,this.player.hp);for(const[,a]of this.remotePlayers)a.update(t,e);this.world.updateParallax(this.cameras.main.scrollX)}_startTransit(){this._transitActive=!0,this._transitTimer=0,this._transitPrompt.setVisible(!1),this._updateTransitBar(0,this._transitZone)}_cancelTransit(){this._transitActive=!1,this._transitTimer=0,this._transitBarBg.setVisible(!1),this._transitBarFill.setVisible(!1),this._transitBarLabel.setVisible(!1)}_updateTransitBar(t,e){const s=((et-this._transitTimer)/1e3).toFixed(1),i=e.type==="extract"?"EXTRACTION":e.label?.toUpperCase()??"WARP";this._transitBarBg.clear().setVisible(!0),this._transitBarBg.fillStyle(0,.75),this._transitBarBg.fillRect(it-2,X-2,J+4,st+4),this._transitBarBg.lineStyle(1,65416,.6),this._transitBarBg.strokeRect(it-2,X-2,J+4,st+4),this._transitBarFill.clear().setVisible(!0),this._transitBarFill.fillStyle(65416,.9),this._transitBarFill.fillRect(it,X,Math.round(J*t),st),this._transitBarLabel.setText(`${i}  ${s}s`).setVisible(!0)}_syncEnemiesFromServer(t){const e=new Set;for(const s of t){e.add(s.netId);let i=this.enemies.find(a=>a.netId===s.netId);i||(i=new be(this,s.x,s.y,this.combat,{}),i.netId=s.netId,i._justCreated=!0,this.enemies.push(i),this.enemiesGroup.add(i),this._pendingCorpseLoot.has(s.netId)&&(i.lootItems=this._pendingCorpseLoot.get(s.netId),i.searchable=!0,i.searched=!1,this._pendingCorpseLoot.delete(s.netId))),i.applyNetState(s),i._justCreated=!1}this.enemies=this.enemies.filter(s=>e.has(s.netId)?!0:(s.destroy(),!1))}_handleWorldReset(t){this.scene.isActive("SearchScene")&&(this.player.searching=!1,this.scene.stop("SearchScene"));for(const e of this.enemies)e.destroy();this.enemies=[],this.enemiesGroup.clear(!0,!0),this._pendingCorpseLoot.clear(),this.lootSystem.resetContainers(),this.runTimer=t,this.player.hp=this.player.maxHp,console.log("[Game] World reset complete")}_warpToLevel(t){if(!this._gameEnded){this._gameEnded=!0,this.net.disconnect();for(const[,e]of this.remotePlayers)e.destroy();this.remotePlayers.clear(),["HUDScene","SearchScene","InventoryScene","PauseScene"].forEach(e=>this.scene.stop(e)),this.player.searching=!1,this.player.inMenu=!1,this.bgMusic&&(this.bgMusic.stop(),this.bgMusic.destroy(),this.bgMusic=null),this._fromEditor?this.scene.start("LevelEditorScene"):this.scene.start("GameScene",{levelId:t})}}_endGame(t,e){if(!this._gameEnded){this._gameEnded=!0,this.net.disconnect();for(const[,s]of this.remotePlayers)s.destroy();this.remotePlayers.clear(),["HUDScene","SearchScene","InventoryScene","PauseScene"].forEach(s=>this.scene.stop(s)),this.player.searching=!1,this.player.inMenu=!1,this.bgMusic&&(this.bgMusic.stop(),this.bgMusic.destroy(),this.bgMusic=null),this._fromEditor?this.scene.start("LevelEditorScene"):t==="win"?this.scene.start("WinScene",{wallet:this.player.wallet??0,timeLeft:this.runTimer}):this.scene.start("GameOverScene",{wallet:this.player.wallet??0,reason:e})}}_toggleSettings(){if(!this._gameEnded){if(this.scene.isActive("InventoryScene")&&(this.player.inInventory=!1,this.scene.stop("InventoryScene")),this.scene.isActive("SearchScene")&&(this.player.searching=!1,this.scene.stop("SearchScene")),this.scene.isActive("PauseScene")){this.player.inMenu=!1,this.scene.stop("PauseScene");return}this.sound.play("sfx_menu",{volume:this.registry.get("sfxVol")??.5}),this.player.inMenu=!0,this.player.setVelocity(0,0),this.scene.launch("PauseScene",{fromScene:"GameScene",fromEditor:this._fromEditor})}}_interact(){if(this._gameEnded||this.player.searching||this._searchCooldown>0)return;if(this._transitZone&&!this._transitActive){this._startTransit();return}const t=this.lootSystem.nearestTarget;t&&(this.sound.play("sfx_menu",{volume:this.registry.get("sfxVol")??.5}),this.player.searching=!0,this.player.setVelocity(0,0),this.scene.launch("SearchScene",{target:t,inventory:this.inventory,player:this.player,net:this.net}))}_openInventory(){this._gameEnded||this.player.searching||this.player.inInventory||(this.sound.play("sfx_menu",{volume:this.registry.get("sfxVol")??.5}),this.player.inInventory=!0,this.player.setVelocity(0,0),this.scene.launch("InventoryScene",{inventory:this.inventory,player:this.player}))}}const _=14,b=160,T=14;class ls extends Phaser.Scene{constructor(){super({key:"HUDScene"})}init(t){this.player=t.player,this.inventory=t.inventory}create(){this.add.text(_,_,"P1",{fontFamily:"monospace",fontSize:"13px",color:"#ff8800"}).setScrollFactor(0).setDepth(500),this.add.rectangle(_+22,_+4,b,T,3342336).setOrigin(0,.5).setScrollFactor(0).setDepth(500),this._hpFill=this.add.rectangle(_+22,_+4,b,T,16729088).setOrigin(0,.5).setScrollFactor(0).setDepth(501),this._hpText=this.add.text(_+22+b+8,_+4,"",{fontFamily:"monospace",fontSize:"11px",color:"#ffaa55"}).setOrigin(0,.5).setScrollFactor(0).setDepth(501),this._timerText=this.add.text(c/2,_+4,"2:00",{fontFamily:"monospace",fontSize:"22px",color:"#ffffff",stroke:"#000000",strokeThickness:3}).setOrigin(.5,.5).setScrollFactor(0).setDepth(501),this._ethIcon=this.add.text(c-_,_+4,"",{fontFamily:"monospace",fontSize:"14px",color:"#00ffcc",stroke:"#003322",strokeThickness:2}).setOrigin(1,.5).setScrollFactor(0).setDepth(501),this._invText=this.add.text(c-_,_+22,"",{fontFamily:"monospace",fontSize:"10px",color:"#8888aa"}).setOrigin(1,.5).setScrollFactor(0).setDepth(501),this.add.rectangle(_+22,_+22,b,T,3351040).setOrigin(0,.5).setScrollFactor(0).setDepth(500),this._stFill=this.add.rectangle(_+22,_+22,b,T,16772608).setOrigin(0,.5).setScrollFactor(0).setDepth(501),this._stText=this.add.text(_+22+b+8,_+22,"",{fontFamily:"monospace",fontSize:"11px",color:"#ffee88"}).setOrigin(0,.5).setScrollFactor(0).setDepth(501),this.add.rectangle(_+22,_+40,b,T,3346688).setOrigin(0,.5).setScrollFactor(0).setDepth(500),this._hgFill=this.add.rectangle(_+22,_+40,b,T,16746547).setOrigin(0,.5).setScrollFactor(0).setDepth(501),this._hgText=this.add.text(_+22+b+8,_+40,"",{fontFamily:"monospace",fontSize:"11px",color:"#ffbb88"}).setOrigin(0,.5).setScrollFactor(0).setDepth(501),this.add.rectangle(_+22,_+58,b,T,4403).setOrigin(0,.5).setScrollFactor(0).setDepth(500),this._thFill=this.add.rectangle(_+22,_+58,b,T,52479).setOrigin(0,.5).setScrollFactor(0).setDepth(501),this._thText=this.add.text(_+22+b+8,_+58,"",{fontFamily:"monospace",fontSize:"11px",color:"#88eeff"}).setOrigin(0,.5).setScrollFactor(0).setDepth(501),this._updateHP()}update(){if(!this.player)return;this._updateHP(),this._updateStamina(),this._updateHunger(),this._updateThirst();const t=this.scene.get("GameScene");if(!t||t._gameEnded)return;const e=Math.max(0,t.runTimer),s=Math.floor(e/60),i=Math.floor(e%60).toString().padStart(2,"0");this._timerText.setText(`${s}:${i}`),this._timerText.setColor(e<30?Math.floor(e*4)%2===0?"#ff2222":"#ffaa00":"#ffffff");const a=this.inventory?this.inventory.totalValue:this.player.wallet??0;if(this._ethIcon.setText(`◆ ${a} ETH`),this.inventory){const n=this.inventory.items.length,r=this.registry.get("inputMode")==="gp";this._invText.setText(`Bag: ${n} items  [${r?"Select":"TAB"}]`)}}_updateHP(){const t=Phaser.Math.Clamp(this.player.hp/this.player.maxHp,0,1),e=Math.max(0,Math.round(b*t));this._hpFill.setSize(e,T);const s=Math.round(Phaser.Math.Linear(0,255,1-t)),i=Math.round(Phaser.Math.Linear(255,0,1-t));this._hpFill.setFillStyle(Phaser.Display.Color.GetColor(s,i,34)),this._hpText.setText(`${this.player.hp}/${this.player.maxHp}`)}_updateStamina(){const t=Phaser.Math.Clamp(this.player.stamina/this.player.maxStamina,0,1);this._stFill.setSize(Math.max(0,Math.round(b*t)),T);const e=Math.round(Phaser.Math.Linear(255,255,1-t)),s=Math.round(Phaser.Math.Linear(238,68,1-t));this._stFill.setFillStyle(Phaser.Display.Color.GetColor(e,s,0)),this._stText.setText(`${Math.round(this.player.stamina)}/${this.player.maxStamina}`)}_updateHunger(){const t=Phaser.Math.Clamp(this.player.hunger/this.player.maxHunger,0,1);this._hgFill.setSize(Math.max(0,Math.round(b*t)),T);const e=Math.round(Phaser.Math.Linear(255,255,1-t)),s=Math.round(Phaser.Math.Linear(136,17,1-t));this._hgFill.setFillStyle(Phaser.Display.Color.GetColor(e,s,0)),this._hgText.setText(`${Math.round(this.player.hunger)}/${this.player.maxHunger}`)}_updateThirst(){const t=Phaser.Math.Clamp(this.player.thirst/this.player.maxThirst,0,1);this._thFill.setSize(Math.max(0,Math.round(b*t)),T);const e=0,s=Math.round(Phaser.Math.Linear(68,204,t)),i=Math.round(Phaser.Math.Linear(136,255,t));this._thFill.setFillStyle(Phaser.Display.Color.GetColor(e,s,i)),this._thText.setText(`${Math.round(this.player.thirst)}/${this.player.maxThirst}`)}}const I=200,It=6,$=0,W=1,at=["CONTROLS","SOUND"];class cs extends Phaser.Scene{constructor(){super({key:"PauseScene"})}create(t){this._fromScene=t&&t.fromScene||"GameScene",this._fromEditor=!!(t&&t.fromEditor),this.add.rectangle(c/2,d/2,c,d,0,.7).setOrigin(.5),this.add.text(c/2,d*.08,"SETTINGS",{fontFamily:"monospace",fontSize:"40px",color:"#ff6600",stroke:"#000000",strokeThickness:4}).setOrigin(.5),this._activeTab=$,this._tabLabels=[],this._tabGroups=[[],[]];const e=d*.17,s=180,i=c/2-s/2;for(let n=0;n<at.length;n++){const r=i+n*s,h=this.add.text(r,e,at[n],{fontFamily:"monospace",fontSize:"16px",color:"#888888"}).setOrigin(.5).setInteractive({useHandCursor:!0});h.on("pointerdown",()=>this._switchTab(n)),this._tabLabels.push(h)}if(this._tabLine=this.add.rectangle(0,e+14,100,2,16737792).setOrigin(.5,0),this._buildControlsTab(),this._buildSoundTab(),this._switchTab($),this._fromEditor){const n=this.add.text(c/2,d*.82,"[ RETOUR ÉDITEUR ]",{fontFamily:"monospace",fontSize:"18px",color:"#4488ff",stroke:"#000000",strokeThickness:3}).setOrigin(.5).setInteractive({useHandCursor:!0});n.on("pointerdown",()=>this._exitToEditor()),n.on("pointerover",()=>n.setColor("#88bbff")),n.on("pointerout",()=>n.setColor("#4488ff")),this.add.text(c/2,d*.88,"Touche  R  — quitter le test",{fontFamily:"monospace",fontSize:"11px",color:"#446688"}).setOrigin(.5)}const a=this.add.text(c/2,d*.94,"ESC / Start: close   Q / L1: switch tab",{fontFamily:"monospace",fontSize:"11px",color:"#888888"}).setOrigin(.5);this.tweens.add({targets:a,alpha:.3,duration:600,yoyo:!0,repeat:-1}),this.input.keyboard.on("keydown-ESC",()=>this._resume()),this.input.keyboard.on("keydown-Q",()=>this._nextTab()),this._fromEditor&&this.input.keyboard.on("keydown-R",()=>this._exitToEditor()),this.input.gamepad.on("down",(n,r)=>{r.index===9&&this._resume(),r.index===4&&this._nextTab(),r.index===5&&this._nextTab()})}_buildControlsTab(){const t=this._tabGroups[$],e=c/2,s=d*.25,i=this.add.text(e,s,"CONTROLLER",{fontFamily:"monospace",fontSize:"14px",color:"#ff8800"}).setOrigin(.5);t.push(i);const a=this.registry.get("padIndex")??0;this._padOptions=["KEYBOARD","GAMEPAD 1","GAMEPAD 2","GAMEPAD 3","GAMEPAD 4"],this._padIdx=a<0?0:a+1;const n=this.add.text(e-120,s+26,"◄",{fontFamily:"monospace",fontSize:"20px",color:"#ff6600"}).setOrigin(.5).setInteractive({useHandCursor:!0});t.push(n);const r=this.add.text(e+120,s+26,"►",{fontFamily:"monospace",fontSize:"20px",color:"#ff6600"}).setOrigin(.5).setInteractive({useHandCursor:!0});t.push(r),this._padLabel=this.add.text(e,s+26,this._padOptions[this._padIdx],{fontFamily:"monospace",fontSize:"16px",color:"#ffffff"}).setOrigin(.5),t.push(this._padLabel),n.on("pointerdown",()=>this._changePad(-1)),r.on("pointerdown",()=>this._changePad(1)),this._ctrlGpCd=0;const h=s+64,l=["── KEYBOARD ──","","WASD / Arrows      Move","X                  Punch","C                  Kick","V                  Jab","SPACE              Jump","E                  Search","TAB                Inventory","ESC                Settings"],f=["── GAMEPAD ──","","Left Stick / D-Pad Move","Square  (X)        Punch","Circle  (B)        Kick","Triangle(Y)        Search","Cross   (A)        Jump","Select             Inventory","Start              Settings"],u=this.add.text(e,h,l.join(`
`),{fontFamily:"monospace",fontSize:"12px",color:"#cccccc",align:"left",lineSpacing:3}).setOrigin(.5,0);t.push(u);const p=this.add.text(e,h+u.height+14,f.join(`
`),{fontFamily:"monospace",fontSize:"12px",color:"#cccccc",align:"left",lineSpacing:3}).setOrigin(.5,0);t.push(p)}_changePad(t){this._padIdx=Phaser.Math.Clamp(this._padIdx+t,0,this._padOptions.length-1),this._padLabel.setText(this._padOptions[this._padIdx]);const e=this._padIdx===0?-1:this._padIdx-1;this.registry.set("padIndex",e),localStorage.setItem("RAGEDERUE_padIndex",e.toString())}_buildSoundTab(){this._sliders=[],this._activeSlider=0,this._buildSlider({y:d*.4,label:"MUSIC VOLUME",lsKey:"RAGEDERUE_music_vol",color:16737792,tab:W,apply:e=>{for(const s of["GameScene","TitleScene"]){const i=this.scene.get(s);i&&i.bgMusic&&i.bgMusic.setVolume(e)}}}),this._buildSlider({y:d*.56,label:"SFX VOLUME",lsKey:"RAGEDERUE_sfx_vol",color:52479,tab:W,apply:e=>{this.registry.set("sfxVol",e)}}),this._highlightSlider();const t=this.add.text(c/2,d*.68,"▲▼ select slider   ◄► adjust",{fontFamily:"monospace",fontSize:"11px",color:"#666666"}).setOrigin(.5);this._tabGroups[W].push(t)}_switchTab(t){this._activeTab=t,this._tabLabels.forEach((e,s)=>{const i=s===t;e.setColor(i?"#ff6600":"#555555"),e.setFontSize(i?"16px":"14px")}),this._tabLine.setPosition(this._tabLabels[t].x,this._tabLine.y),this._tabLine.setSize(this._tabLabels[t].width+16,2);for(let e=0;e<this._tabGroups.length;e++){const s=e===t;for(const i of this._tabGroups[e])i.setVisible(s)}if(this._sliders)for(const e of this._sliders){const s=t===W;e.knob.setVisible(s),e.lbl.setVisible(s),e.fill.setVisible(s),e.track.setVisible(s),e.pct.setVisible(s),e.hitZone.setVisible(s),s?e.hitZone.setInteractive():e.hitZone.disableInteractive(),s?e.knob.setInteractive({draggable:!0}):e.knob.disableInteractive()}}_nextTab(){this._switchTab((this._activeTab+1)%at.length)}_buildSlider({y:t,label:e,lsKey:s,color:i,tab:a,apply:n}){const r=c/2,h=parseFloat(localStorage.getItem(s)??"0.5"),l=this._tabGroups[a],f=this.add.text(r,t-22,e,{fontFamily:"monospace",fontSize:"14px",color:"#ff8800"}).setOrigin(.5);l.push(f);const u=r-I/2,p=this.add.rectangle(r,t,I,It,3355443).setOrigin(.5);l.push(p);const y=this.add.rectangle(u,t,I*h,It,i).setOrigin(0,.5);l.push(y);const g=this.add.circle(u+I*h,t,10,16777215).setInteractive({draggable:!0,useHandCursor:!0}),m=this.add.text(r+I/2+30,t,`${Math.round(h*100)}%`,{fontFamily:"monospace",fontSize:"14px",color:"#cccccc"}).setOrigin(.5);l.push(m);const C=R=>{y.width=I*R,g.x=u+I*R,m.setText(`${Math.round(R*100)}%`),localStorage.setItem(s,R.toFixed(2)),n(R)},ht=this.add.rectangle(r,t,I+20,30,0,0).setOrigin(.5).setInteractive({useHandCursor:!0});ht.on("pointerdown",R=>{const G=(Phaser.Math.Clamp(R.x,u,u+I)-u)/I;j.vol=G,C(G),this._activeSlider=this._sliders.indexOf(j),this._highlightSlider()});const j={vol:h,applyVol:C,trackX:u,lbl:f,knob:g,fill:y,track:p,pct:m,hitZone:ht};this._sliders.push(j),this.input.on("drag",(R,lt,G)=>{if(lt!==g)return;const ct=Phaser.Math.Clamp(G,u,u+I);g.x=ct;const dt=(ct-u)/I;j.vol=dt,C(dt)}),n(h)}_highlightSlider(){this._sliders&&this._sliders.forEach((t,e)=>{const s=e===this._activeSlider;t.lbl.setColor(s?"#ffcc00":"#ff8800"),t.knob.setFillStyle(s?16763904:16777215)})}update(t,e){const s=this.input.gamepad;if(!s||s.total===0)return;const i=s.getPad(0);if(!i)return;const a=.2;if(this._activeTab===$){this._ctrlGpCd=(this._ctrlGpCd||0)-e;let l=0;(i.left||i.leftStick.x<-a)&&(l=-1),(i.right||i.leftStick.x>a)&&(l=1),l!==0&&this._ctrlGpCd<=0&&(this._changePad(l),this._ctrlGpCd=250),l===0&&(this._ctrlGpCd=0);return}if(this._activeTab!==W||!this._sliders||this._sliders.length===0)return;const n=.8;this._gpVertCd=(this._gpVertCd||0)-e;let r=0;(i.up||i.leftStick.y<-a)&&(r=-1),(i.down||i.leftStick.y>a)&&(r=1),r!==0&&this._gpVertCd<=0&&(this._activeSlider=Phaser.Math.Clamp(this._activeSlider+r,0,this._sliders.length-1),this._highlightSlider(),this._gpVertCd=220),r===0&&(this._gpVertCd=0);let h=0;if(i.left&&(h=-1),i.right&&(h=1),Math.abs(i.leftStick.x)>a&&(h=i.leftStick.x),h!==0){const l=e/1e3,f=this._sliders[this._activeSlider],u=Phaser.Math.Clamp(f.vol+h*n*l,0,1);f.vol=u,f.applyVol(u)}}_resume(){if(this._fromScene==="GameScene"){const t=this.scene.get("GameScene");t&&t.player&&(t.player.inMenu=!1)}this.scene.stop()}_exitToEditor(){const t=this.scene.get("GameScene");t&&t.player&&(t.player.inMenu=!1,t._endGame("over","")),this.scene.stop()}}const S=48,x=2,Mt=6,At=4,Lt=Mt*(S+x)+x,z=At*(S+x)+x,K=Math.round((c-Lt)/2),F=Math.round((d-z)/2)-30;class ds extends Phaser.Scene{constructor(){super({key:"InventoryScene"})}init(t){this.inventory=t.inventory,this.player=t.player}create(){this._hpSnapshot=this.player.hp,this.add.rectangle(c/2,d/2,c,d,0,.65),this.add.text(c/2,F-30,"INVENTORY",{fontFamily:"monospace",fontSize:"22px",color:"#ff8800",stroke:"#000000",strokeThickness:3}).setOrigin(.5);const t=this.add.graphics();t.fillStyle(1710638,.9),t.fillRect(K-4,F-4,Lt+8,z+8);for(let e=0;e<At;e++)for(let s=0;s<Mt;s++){const i=K+x+s*(S+x),a=F+x+e*(S+x);t.fillStyle(3355477,.7),t.fillRect(i,a,S,S)}this._itemSprites=[],this._selectedIdx=0;for(const e of this.inventory.items){const s=K+x+e.gridX*(S+x),i=F+x+e.gridY*(S+x),a=e.def.invW*S+(e.def.invW-1)*x,n=e.def.invH*S+(e.def.invH-1)*x,r=this.add.rectangle(s+a/2,i+n/2,a,n,e.def.glowColor,.2).setStrokeStyle(1,e.def.glowColor,.5),h=e.identified?e.def.texture:null;let l;h?l=this.add.image(s+a/2,i+n/2,h).setDisplaySize(Math.min(a-8,e.def.displayW),Math.min(n-8,e.def.displayH)):l=this.add.text(s+a/2,i+n/2,"?",{fontFamily:"monospace",fontSize:"28px",color:"#888888"}).setOrigin(.5),this._itemSprites.push({item:e,bg:r,icon:l,cx:s,cy:i,w:a,h:n})}this._cursor=this.add.rectangle(0,0,S,S).setStrokeStyle(2,16777215,1).setFillStyle(16777215,.1),this.tweens.add({targets:this._cursor,alpha:.5,duration:400,yoyo:!0,repeat:-1}),this._updateCursor(),this._infoText=this.add.text(c/2,F+z+20,"",{fontFamily:"monospace",fontSize:"12px",color:"#cccccc",align:"center"}).setOrigin(.5,0),this._updateInfo(),this._useBarBg=this.add.rectangle(c/2,F+z+60,160,10,3355443).setOrigin(.5).setVisible(!1),this._useBarFill=this.add.rectangle(c/2-80,F+z+60,0,10,65416).setOrigin(0,.5).setVisible(!1),this._isUsing=!1,this._hintText=this.add.text(c/2,d-20,"",{fontFamily:"monospace",fontSize:"10px",color:"#666666"}).setOrigin(.5),this._refreshHint(),this.input.keyboard.on("keydown-TAB",()=>{this.registry.set("inputMode","kb"),this._close()}),this.input.keyboard.on("keydown-ESC",()=>{this.registry.set("inputMode","kb"),this._close()}),this.input.keyboard.on("keydown-LEFT",()=>{this.registry.set("inputMode","kb"),this._move(-1,0)}),this.input.keyboard.on("keydown-RIGHT",()=>{this.registry.set("inputMode","kb"),this._move(1,0)}),this.input.keyboard.on("keydown-UP",()=>{this.registry.set("inputMode","kb"),this._move(0,-1)}),this.input.keyboard.on("keydown-DOWN",()=>{this.registry.set("inputMode","kb"),this._move(0,1)}),this.input.keyboard.on("keydown-X",()=>{this.registry.set("inputMode","kb"),this._useSelected()}),this._gpCooldown=0,this.input.gamepad.on("down",(e,s)=>{this.registry.set("inputMode","gp"),s.index===8&&this._close(),s.index===1&&this._close(),s.index===0&&this._useSelected()})}update(t,e){if(this.player.hp<this._hpSnapshot||this.player.state==="hurt"||this.player.state==="dead"){this._forceClose();return}this._refreshHint(),this._gpCooldown-=e;const s=this.input.gamepad;if(s&&s.total>0&&this._gpCooldown<=0){const i=s.getPad(0);if(i){let n=0,r=0;(i.left||i.leftStick.x<-.4)&&(n=-1),(i.right||i.leftStick.x>.4)&&(n=1),(i.up||i.leftStick.y<-.4)&&(r=-1),(i.down||i.leftStick.y>.4)&&(r=1),(n||r)&&(this.registry.set("inputMode","gp"),this._move(n,r),this._gpCooldown=180)}}}_refreshHint(){const t=this.registry.get("inputMode")==="gp";this._hintText.setText(t?"D-Pad: navigate   A: use   B: close":"Arrows: navigate   X: use   TAB: close")}_move(t,e){if(this._isUsing||this._itemSprites.length===0)return;const s=this._itemSprites[this._selectedIdx]?.item;if(!s){this._selectedIdx=0,this._updateCursor(),this._updateInfo();return}let i=this._selectedIdx,a=1/0;const n=s.gridX+s.def.invW/2,r=s.gridY+s.def.invH/2;for(let h=0;h<this._itemSprites.length;h++){if(h===this._selectedIdx)continue;const l=this._itemSprites[h].item,f=l.gridX+l.def.invW/2,u=l.gridY+l.def.invH/2,p=f-n,y=u-r;if(t!==0&&Math.sign(p)!==Math.sign(t)||e!==0&&Math.sign(y)!==Math.sign(e)||t!==0&&e===0&&Math.abs(y)>1.5||e!==0&&t===0&&Math.abs(p)>1.5)continue;const g=Math.abs(p)+Math.abs(y);g<a&&(a=g,i=h)}this._selectedIdx=i,this._updateCursor(),this._updateInfo()}_updateCursor(){if(this._itemSprites.length===0){this._cursor.setVisible(!1);return}this._cursor.setVisible(!0);const t=this._itemSprites[this._selectedIdx];this._cursor.setPosition(t.cx+t.w/2,t.cy+t.h/2),this._cursor.setSize(t.w+4,t.h+4)}_updateInfo(){if(this._itemSprites.length===0){this._infoText.setText("Inventory empty");return}const t=this._itemSprites[this._selectedIdx]?.item;if(t)if(!t.identified)this._infoText.setText("??? — Unidentified item");else{const e=t.def.useTime>0?`  [Use: ${(t.def.useTime/1e3).toFixed(1)}s]`:"";this._infoText.setText(`${t.def.description}${e}`)}}_useSelected(){if(this._isUsing||this._itemSprites.length===0)return;const t=this._itemSprites[this._selectedIdx];if(!t)return;const e=t.item;e.identified&&(e.def.useTime<=0&&!e.def.healAmount&&!e.def.hungerRestore&&!e.def.thirstRestore||(this._isUsing=!0,this._useBarBg.setVisible(!0),this._useBarFill.setVisible(!0).setSize(0,10),this.tweens.add({targets:this._useBarFill,width:160,duration:e.def.useTime,ease:"Linear",onComplete:()=>{this.inventory.useItem(e,this.player),this._isUsing=!1,this._useBarBg.setVisible(!1),this._useBarFill.setVisible(!1),this._rebuild()}})))}_rebuild(){for(const t of this._itemSprites)t.bg.destroy(),t.icon.destroy();this._itemSprites=[],this._selectedIdx=0;for(const t of this.inventory.items){const e=K+x+t.gridX*(S+x),s=F+x+t.gridY*(S+x),i=t.def.invW*S+(t.def.invW-1)*x,a=t.def.invH*S+(t.def.invH-1)*x,n=this.add.rectangle(e+i/2,s+a/2,i,a,t.def.glowColor,.2).setStrokeStyle(1,t.def.glowColor,.5),r=t.identified?t.def.texture:null;let h;r?h=this.add.image(e+i/2,s+a/2,r).setDisplaySize(Math.min(i-8,t.def.displayW),Math.min(a-8,t.def.displayH)):h=this.add.text(e+i/2,s+a/2,"?",{fontFamily:"monospace",fontSize:"28px",color:"#888888"}).setOrigin(.5),this._itemSprites.push({item:t,bg:n,icon:h,cx:e,cy:s,w:i,h:a})}this._updateCursor(),this._updateInfo()}_close(){this._isUsing||(this.player.inInventory=!1,this.scene.stop())}_forceClose(){this.tweens.killAll(),this._isUsing=!1,this.player.inInventory=!1,this.scene.stop()}}const O=340,rt=260,N=Math.round((d-rt)/2)-20,Z=36,nt=N+70;class ps extends Phaser.Scene{constructor(){super({key:"SearchScene"})}init(t){this.target=t.target,this.inventory=t.inventory,this.player=t.player,this.net=t.net,this._targetKind=this.target.image?0:1,this._targetId=this.target.netId??0}create(){this.registry.get("inputMode"),this.add.rectangle(c/2,d/2,c,d,0,.6),this.add.rectangle(c/2,d/2-20,O+8,rt+8,1118498,.95).setStrokeStyle(2,5592490,.8),this._title=this.add.text(c/2,N+16,"Searching…",{fontFamily:"monospace",fontSize:"16px",color:"#ffaa00",stroke:"#000",strokeThickness:3}).setOrigin(.5),this._barBg=this.add.rectangle(c/2,N+45,O-40,12,3355443).setOrigin(.5),this._barFill=this.add.rectangle(c/2-(O-40)/2,N+45,0,12,3386111).setOrigin(0,.5),this._hint=this.add.text(c/2,N+rt-10,"",{fontFamily:"monospace",fontSize:"9px",color:"#555577"}).setOrigin(.5),this._refreshHint(),this._phase="opening",this._itemRows=[],this._selectedIdx=0,this._identifyIdx=0,this._revealedItems=[],this._cursor=null,this._hpSnapshot=this.player.hp,this.target.opened?(this._barBg.setVisible(!1),this._barFill.setVisible(!1),this._skipToReady()):this.tweens.add({targets:this._barFill,width:O-40,duration:ve,ease:"Linear",onComplete:()=>this._beginIdentify()}),this.input.keyboard.on("keydown-E",()=>{this.registry.set("inputMode","kb"),this._tryClose()}),this.input.keyboard.on("keydown-TAB",()=>{this.registry.set("inputMode","kb"),this._tryClose()}),this.input.keyboard.on("keydown-ESC",()=>{this.registry.set("inputMode","kb"),this._tryClose()}),this.input.keyboard.on("keydown-UP",()=>{this.registry.set("inputMode","kb"),this._moveSel(-1)}),this.input.keyboard.on("keydown-DOWN",()=>{this.registry.set("inputMode","kb"),this._moveSel(1)}),this.input.keyboard.on("keydown-X",()=>{this.registry.set("inputMode","kb"),this._takeSelected()}),this.input.keyboard.on("keydown-C",()=>{this.registry.set("inputMode","kb")}),this._gpCooldown=0,this.input.gamepad.on("down",(t,e)=>{this.registry.set("inputMode","gp"),e.index===0&&this._takeSelected(),e.index===1&&this._tryClose(),e.index===3&&this._tryClose(),e.index===8&&this._tryClose()})}update(t,e){if(this._refreshHint(),this.player.hp<this._hpSnapshot||this.player.state==="hurt"){this._forceClose();return}this._hpSnapshot=this.player.hp,this._gpCooldown-=e;const s=this.input.gamepad;if(s&&s.total>0&&this._gpCooldown<=0){const i=s.getPad(0);if(i){let n=0;(i.up||i.leftStick.y<-.4)&&(n=-1),(i.down||i.leftStick.y>.4)&&(n=1),n&&(this.registry.set("inputMode","gp"),this._moveSel(n),this._gpCooldown=180)}}}_refreshHint(){const t=this.registry.get("inputMode")==="gp";this._hint.setText(t?"A: take   B: close":"X: take   E / TAB: close")}_skipToReady(){if(this._title.setText("Items found"),this._phase="ready",this._revealedItems=this.target.lootItems.map(t=>({type:t,identified:!0,taken:!1})),this._revealedItems.length===0){this._title.setText("Empty");return}this._drawRows(),this._revealedItems.forEach((t,e)=>this._refreshRow(e))}_beginIdentify(){if(this._barBg.setVisible(!1),this._barFill.setVisible(!1),this._title.setText("Items found"),this._phase="identifying",this.target.opened=!0,this._revealedItems=this.target.lootItems.map(t=>({type:t,identified:!1,taken:!1})),this._revealedItems.length===0){this._title.setText("Empty"),this._phase="ready";return}this._drawRows(),this._identifyIdx=0,this._identifyNext()}_identifyNext(){if(this._identifyIdx>=this._revealedItems.length){this._phase="ready";return}const t=this._identifyIdx;this.time.delayedCall(we,()=>{this.scene.isActive()&&(this._revealedItems[t].identified=!0,this._refreshRow(t),this._identifyIdx++,this._identifyNext())})}_drawRows(){for(let t=0;t<this._revealedItems.length;t++){const e=nt+t*Z,s=this.add.rectangle(c/2,e,O-20,Z-4,2236996,.6).setStrokeStyle(1,4473958,.4),i=this.add.text(c/2-O/2+30,e,"?",{fontFamily:"monospace",fontSize:"18px",color:"#666"}).setOrigin(.5),a=this.add.text(c/2-O/2+60,e,"???",{fontFamily:"monospace",fontSize:"12px",color:"#888"}).setOrigin(0,.5),n=this.add.text(c/2+O/2-25,e,"",{fontFamily:"monospace",fontSize:"10px",color:"#555"}).setOrigin(1,.5);this._itemRows.push({bg:s,icon:i,label:a,status:n,ry:e})}this._cursor=this.add.rectangle(c/2,nt,O-16,Z-2).setStrokeStyle(2,16777215,.9).setFillStyle(16777215,.05),this.tweens.add({targets:this._cursor,alpha:.5,duration:400,yoyo:!0,repeat:-1}),this._selectedIdx=0,this._updateCursorPos()}_refreshRow(t){const e=this._itemRows[t],s=this._revealedItems[t];if(e){if(s.taken)e.icon.setText("✓").setColor("#00cc44"),e.label.setText("Taken").setColor("#44aa44"),e.status.setText(""),e.bg.setFillStyle(1127185,.4);else if(s.identified){const i=q[s.type];i.texture&&this.textures.exists(i.texture)?(e.icon.setVisible(!1),this.add.image(e.icon.x,e.ry,i.texture).setDisplaySize(24,24)):e.icon.setText(s.type.charAt(0).toUpperCase()).setColor("#"+i.glowColor.toString(16).padStart(6,"0")),e.label.setText(i.description).setColor("#cccccc")}}}_updateCursorPos(){!this._cursor||this._itemRows.length===0||this._cursor.setY(nt+this._selectedIdx*Z)}_moveSel(t){this._phase!=="opening"&&this._revealedItems.length!==0&&(this._selectedIdx=Phaser.Math.Clamp(this._selectedIdx+t,0,this._revealedItems.length-1),this._updateCursorPos())}_takeSelected(){if(this._phase==="opening")return;const t=this._revealedItems[this._selectedIdx];if(!(!t||t.taken)){if(!t.identified){const e=this._itemRows[this._selectedIdx];e.status.setText("???").setColor("#ffaa00"),this.time.delayedCall(600,()=>{e.status.active&&e.status.setText("")});return}if(!this.inventory.hasRoom(t.type)){const e=this._itemRows[this._selectedIdx];e.status.setText("FULL").setColor("#ff3333"),this.time.delayedCall(800,()=>{e.status.active&&e.status.setText("")});return}if(this.inventory.addItem(t.type,t.identified),t.taken=!0,this._refreshRow(this._selectedIdx),this.net){let e=0;for(let s=0;s<this._selectedIdx;s++)this._revealedItems[s].taken||e++;this.net.sendTakeItem(this._targetKind,this._targetId,e)}}}_tryClose(){if(this._phase==="opening")return;(this._revealedItems.length===0||this._revealedItems.every(e=>e.taken))&&this.target.markSearched(),this._doClose()}_forceClose(){this._doClose()}_doClose(){this.player.searching=!1,this.scene.stop()}}class fs extends Phaser.Scene{constructor(){super({key:"GameOverScene"})}init(t){this.wallet=t.wallet??0,this.reason=t.reason??"TIME UP"}create(){const{width:t,height:e}=this.scale,s=t/2,i=e/2;this.add.rectangle(s,i,t,e,0,.82),this.add.text(s,i-90,"GAME OVER",{fontFamily:"monospace",fontSize:"52px",color:"#ff2222",stroke:"#000000",strokeThickness:5}).setOrigin(.5),this.add.text(s,i-30,this.reason,{fontFamily:"monospace",fontSize:"20px",color:"#888888"}).setOrigin(.5),this.add.text(s,i+20,`ETH COLLECTED : ${this.wallet}`,{fontFamily:"monospace",fontSize:"24px",color:"#00ffcc"}).setOrigin(.5);const a=this.add.text(s,i+90,"PRESS ENTER  or  START  TO RETRY",{fontFamily:"monospace",fontSize:"16px",color:"#666666"}).setOrigin(.5);this.tweens.add({targets:a,alpha:0,duration:600,yoyo:!0,repeat:-1}),this.input.keyboard.once("keydown-ENTER",()=>this._restart()),this.input.gamepad.on("down",(n,r)=>{r.index===9&&this._restart()})}_restart(){this.scene.start("GameScene")}}class us extends Phaser.Scene{constructor(){super({key:"WinScene"})}init(t){this.wallet=t.wallet??0,this.timeLeft=t.timeLeft??0}create(){const{width:t,height:e}=this.scale,s=t/2,i=e/2;this.add.rectangle(s,i,t,e,0,.82),this.add.text(s,i-110,"EXTRACTION",{fontFamily:"monospace",fontSize:"50px",color:"#00ff88",stroke:"#000000",strokeThickness:5}).setOrigin(.5),this.add.text(s,i-55,"SUCCESSFUL",{fontFamily:"monospace",fontSize:"50px",color:"#00ff88",stroke:"#000000",strokeThickness:5}).setOrigin(.5);const a=Math.floor(this.timeLeft)*10,n=this.wallet+a;this.add.text(s,i+10,`ETH COLLECTED : ${this.wallet}`,{fontFamily:"monospace",fontSize:"22px",color:"#00ffcc"}).setOrigin(.5),this.add.text(s,i+45,`TIME BONUS    : +${a}`,{fontFamily:"monospace",fontSize:"22px",color:"#ffff44"}).setOrigin(.5),this.add.text(s,i+80,`TOTAL SCORE   : ${n}`,{fontFamily:"monospace",fontSize:"26px",color:"#ffffff",stroke:"#000000",strokeThickness:3}).setOrigin(.5);const r=this.add.text(s,i+140,"PRESS SPACE  or  A  TO PLAY AGAIN",{fontFamily:"monospace",fontSize:"15px",color:"#666666"}).setOrigin(.5);this.tweens.add({targets:r,alpha:0,duration:600,yoyo:!0,repeat:-1}),this.input.keyboard.once("keydown-SPACE",()=>this.scene.start("GameScene")),this.input.gamepad.total>0?this.input.gamepad.once("down",()=>this.scene.start("GameScene")):this.input.gamepad.on("connected",()=>{this.input.gamepad.once("down",()=>this.scene.start("GameScene"))})}}const _s={type:Phaser.AUTO,width:c,height:d,backgroundColor:"#0a0a14",physics:{default:"arcade",arcade:{gravity:{y:0},debug:!1}},input:{gamepad:!0},scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},scene:[he,le,_e,hs,ls,cs,ds,ps,fs,us]};new Phaser.Game(_s);
