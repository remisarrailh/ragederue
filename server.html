<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RAGEDERUE ‚Äî Server Monitor</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Courier New', monospace;
      background: #0a0a0f;
      color: #e0e0e0;
      min-height: 100vh;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #ff4444;
      font-size: 1.6em;
      margin-bottom: 8px;
      text-shadow: 0 0 10px rgba(255, 68, 68, 0.4);
    }
    .subtitle {
      text-align: center;
      color: #666;
      font-size: 0.8em;
      margin-bottom: 20px;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .controls label { color: #888; font-size: 0.85em; }
    .controls input {
      background: #1a1a2e;
      border: 1px solid #333;
      color: #e0e0e0;
      padding: 4px 8px;
      border-radius: 4px;
      width: 220px;
      font-family: inherit;
    }
    .controls button {
      background: #222;
      border: 1px solid #444;
      color: #ccc;
      padding: 6px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
    }
    .controls button:hover { background: #333; }
    .controls button.active { border-color: #4caf50; color: #4caf50; }
    #status {
      text-align: center;
      padding: 6px;
      margin-bottom: 16px;
      border-radius: 4px;
      font-size: 0.85em;
    }
    #status.ok { background: #0a2a0a; color: #4caf50; border: 1px solid #1b5e20; }
    #status.err { background: #2a0a0a; color: #f44336; border: 1px solid #b71c1c; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .card {
      background: #111122;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 16px;
    }
    .card h2 {
      font-size: 1em;
      color: #ff8844;
      margin-bottom: 12px;
      border-bottom: 1px solid #222;
      padding-bottom: 6px;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      font-size: 0.85em;
    }
    .stat-label { color: #888; }
    .stat-value { color: #fff; font-weight: bold; }
    .stat-value.green { color: #4caf50; }
    .stat-value.yellow { color: #ffeb3b; }
    .stat-value.red { color: #f44336; }
    .stat-value.blue { color: #42a5f5; }

    .bar-bg {
      background: #1a1a2e;
      border-radius: 4px;
      height: 18px;
      margin: 6px 0;
      overflow: hidden;
      position: relative;
    }
    .bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    .bar-text {
      position: absolute;
      top: 0; left: 8px;
      line-height: 18px;
      font-size: 0.75em;
      color: #fff;
      text-shadow: 0 0 2px #000;
    }

    .player-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8em;
      margin-top: 8px;
    }
    .player-table th {
      color: #888;
      text-align: left;
      padding: 4px 6px;
      border-bottom: 1px solid #333;
    }
    .player-table td {
      padding: 4px 6px;
      border-bottom: 1px solid #1a1a2e;
    }

    .graph-container {
      margin-top: 10px;
    }
    canvas {
      width: 100%;
      height: 80px;
      background: #0d0d1a;
      border-radius: 4px;
    }
    .graph-label {
      font-size: 0.7em;
      color: #666;
      margin-top: 2px;
    }
  </style>
</head>
<body>

  <h1>‚öî RAGEDERUE ‚Äî Server Monitor</h1>
  <p class="subtitle">Real-time game server monitoring dashboard</p>

  <div class="controls">
    <div>
      <label>Stats URL:</label><br>
      <input id="urlInput" value="http://localhost:9000/stats" />
    </div>
    <div style="display: flex; align-items: end; gap: 8px;">
      <button id="btnToggle" onclick="togglePolling()">‚ñ∂ Start</button>
      <button onclick="resetStats()">‚Ü∫ Reset Stats</button>
      <button onclick="fetchOnce()">‚ü≥ Fetch Once</button>
    </div>
  </div>

  <div id="status" class="err">Not connected ‚Äî click Start</div>

  <div class="grid">
    <!-- Server -->
    <div class="card">
      <h2>üñ• Server</h2>
      <div class="stat-row"><span class="stat-label">Uptime</span><span id="uptime" class="stat-value">-</span></div>
      <div class="stat-row"><span class="stat-label">WS connections</span><span id="connections" class="stat-value">-</span></div>
      <div class="stat-row"><span class="stat-label">Players in room</span><span id="playersInRoom" class="stat-value green">-</span></div>
      <div class="stat-row"><span class="stat-label">RAM (RSS)</span><span id="memRss" class="stat-value">-</span></div>
      <div class="stat-row"><span class="stat-label">Heap used / total</span><span id="memHeap" class="stat-value">-</span></div>
      <div class="stat-row"><span class="stat-label">CPU user</span><span id="cpuUser" class="stat-value">-</span></div>
      <div class="stat-row"><span class="stat-label">CPU system</span><span id="cpuSys" class="stat-value">-</span></div>
    </div>

    <!-- Tick Perf (global, first room) -->
    <div class="card">
      <h2>‚ö° Tick Performance</h2>
      <div class="stat-row"><span class="stat-label">Tick rate</span><span id="tickRate" class="stat-value">-</span></div>
      <div class="stat-row"><span class="stat-label">Avg tick time</span><span id="tickAvg" class="stat-value green">-</span></div>
      <div class="stat-row"><span class="stat-label">Max tick time</span><span id="tickMax" class="stat-value">-</span></div>
      <div class="stat-row"><span class="stat-label">Ticks counted</span><span id="tickCount" class="stat-value">-</span></div>
      <div class="graph-container">
        <canvas id="tickGraph"></canvas>
        <div class="graph-label">Avg tick ms (history)</div>
      </div>
    </div>

    <!-- Bandwidth (global, first room) -->
    <div class="card">
      <h2>üì° Network (Out / In)</h2>
      <div class="stat-row"><span class="stat-label">Bytes/sec sent</span><span id="bwSentSec" class="stat-value blue">-</span></div>
      <div class="stat-row"><span class="stat-label">Msgs/sec sent</span><span id="msgSentSec" class="stat-value">-</span></div>
      <div class="stat-row"><span class="stat-label">Total sent</span><span id="bwSentTotal" class="stat-value">-</span></div>
      <div class="stat-row"><span class="stat-label">Bytes/sec recv</span><span id="bwRecvSec" class="stat-value blue">-</span></div>
      <div class="stat-row"><span class="stat-label">Msgs/sec recv</span><span id="msgRecvSec" class="stat-value">-</span></div>
      <div class="stat-row"><span class="stat-label">Total recv</span><span id="bwRecvTotal" class="stat-value">-</span></div>
      <div class="graph-container">
        <canvas id="bwOutGraph"></canvas>
        <div class="graph-label">KB/s sent (history)</div>
      </div>
      <div class="graph-container">
        <canvas id="bwInGraph"></canvas>
        <div class="graph-label">KB/s recv (history)</div>
      </div>
    </div>
  </div>

  <!-- Per-room dynamic section -->
  <div id="roomsSection"></div>

  <!-- Players (all rooms) -->
  <div class="card" style="margin-bottom: 20px;">
    <h2>üë§ Players</h2>
    <div id="playersCount" style="font-size: 0.85em; color: #888; margin-bottom: 6px;">0 connected</div>
    <table class="player-table">
      <thead><tr><th>Room</th><th>ID</th><th>Name</th><th>X</th><th>Y</th><th>HP</th><th>State</th></tr></thead>
      <tbody id="playersBody"></tbody>
    </table>
  </div>

<script>
// ‚îÄ‚îÄ Graph history ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HISTORY_LEN = 60;
const tickHistory = new Array(HISTORY_LEN).fill(0);
const bwOutHistory = new Array(HISTORY_LEN).fill(0);
const bwInHistory  = new Array(HISTORY_LEN).fill(0);

let polling = false;
let pollTimer = null;

function togglePolling() {
  polling = !polling;
  const btn = document.getElementById('btnToggle');
  if (polling) {
    btn.textContent = '‚èπ Stop';
    btn.classList.add('active');
    poll();
  } else {
    btn.textContent = '‚ñ∂ Start';
    btn.classList.remove('active');
    clearTimeout(pollTimer);
  }
}

function poll() {
  if (!polling) return;
  fetchOnce().finally(() => {
    pollTimer = setTimeout(poll, 1000);
  });
}

function fetchOnce() {
  const url = document.getElementById('urlInput').value;
  const status = document.getElementById('status');

  return fetch(url)
    .then(r => r.json())
    .then(data => {
      status.className = 'ok';
      status.textContent = `‚úì Connected ‚Äî last update ${new Date().toLocaleTimeString()}`;
      render(data);
    })
    .catch(err => {
      status.className = 'err';
      status.textContent = `‚úó Error: ${err.message}`;
    });
}

function resetStats() {
  const url = document.getElementById('urlInput').value.replace('/stats', '/stats/reset');
  fetch(url).then(() => fetchOnce());
}

function formatBytes(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / 1024 / 1024).toFixed(2) + ' MB';
}

function formatUptime(sec) {
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = sec % 60;
  return `${h}h ${m}m ${s}s`;
}

function formatTimer(sec) {
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${m}:${String(s).padStart(2, '0')}`;
}

function render(data) {
  // ‚îÄ‚îÄ Server stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('uptime').textContent = formatUptime(data.uptime);
  document.getElementById('connections').textContent = data.connections;
  document.getElementById('playersInRoom').textContent = data.playersInRoom ?? 0;
  document.getElementById('memRss').textContent = data.memory.rss + ' MB';
  document.getElementById('memHeap').textContent = data.memory.heapUsed + ' / ' + data.memory.heapTotal + ' MB';
  document.getElementById('cpuUser').textContent = data.cpu.user + ' ms';
  document.getElementById('cpuSys').textContent = data.cpu.system + ' ms';

  const rooms = data.rooms || [];
  const firstRoom = rooms[0];

  // ‚îÄ‚îÄ Tick perf + bandwidth (from first room) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (firstRoom) {
    document.getElementById('tickRate').textContent = firstRoom.tick.rate + ' Hz';
    const avgEl = document.getElementById('tickAvg');
    avgEl.textContent = firstRoom.tick.avgMs + ' ms';
    avgEl.className = 'stat-value ' + (firstRoom.tick.avgMs < 5 ? 'green' : firstRoom.tick.avgMs < 20 ? 'yellow' : 'red');
    const maxEl = document.getElementById('tickMax');
    maxEl.textContent = firstRoom.tick.maxMs + ' ms';
    maxEl.className = 'stat-value ' + (firstRoom.tick.maxMs < 10 ? 'green' : firstRoom.tick.maxMs < 40 ? 'yellow' : 'red');
    document.getElementById('tickCount').textContent = firstRoom.tick.count.toLocaleString();

    // Sum bandwidth across all rooms
    let bwSentSec = 0, bwRecvSec = 0, bwSentTotal = 0, bwRecvTotal = 0, msgSentSec = 0, msgRecvSec = 0;
    for (const r of rooms) {
      bwSentSec   += r.bandwidth.bytesSentPerSec;
      bwRecvSec   += r.bandwidth.bytesRecvPerSec;
      bwSentTotal += r.bandwidth.bytesSentTotal;
      bwRecvTotal += r.bandwidth.bytesRecvTotal;
      msgSentSec  += r.bandwidth.msgsSentPerSec;
      msgRecvSec  += r.bandwidth.msgsRecvPerSec;
    }
    document.getElementById('bwSentSec').textContent = formatBytes(bwSentSec) + '/s';
    document.getElementById('msgSentSec').textContent = msgSentSec + ' msg/s';
    document.getElementById('bwSentTotal').textContent = formatBytes(bwSentTotal);
    document.getElementById('bwRecvSec').textContent = formatBytes(bwRecvSec) + '/s';
    document.getElementById('msgRecvSec').textContent = msgRecvSec + ' msg/s';
    document.getElementById('bwRecvTotal').textContent = formatBytes(bwRecvTotal);

    tickHistory.push(firstRoom.tick.avgMs); tickHistory.shift();
    bwOutHistory.push(bwSentSec / 1024); bwOutHistory.shift();
    bwInHistory.push(bwRecvSec / 1024);  bwInHistory.shift();

    drawGraph('tickGraph',  tickHistory,  '#4caf50', 50);
    drawGraph('bwOutGraph', bwOutHistory, '#42a5f5');
    drawGraph('bwInGraph',  bwInHistory,  '#ff9800');
  }

  // ‚îÄ‚îÄ Per-room cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const section = document.getElementById('roomsSection');
  section.innerHTML = '';

  for (const room of rooms) {
    const timerPct = (room.worldTimer / room.worldTimerMax) * 100;
    const timerColor = timerPct < 15 ? '#f44336' : timerPct < 30 ? '#ff9800' : '#42a5f5';
    const enemPct = room.maxEnemies > 0 ? (room.enemiesAlive / room.maxEnemies) * 100 : 0;
    const aliveColor = room.enemiesAlive === 0 ? '#4caf50' :
                       room.enemiesAlive >= room.maxEnemies ? '#f44336' : '#ffeb3b';

    const card = document.createElement('div');
    card.className = 'card';
    card.style.marginBottom = '16px';
    card.innerHTML = `
      <h2>üåç ${room.room}
        <span style="font-size:0.7em;font-weight:normal;color:#888;margin-left:8px;">
          ${room.players} joueur${room.players !== 1 ? 's' : ''}
        </span>
      </h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:0 24px;">

        <div>
          <div class="stat-row"><span class="stat-label">Timer</span>
            <span class="stat-value" style="color:${timerColor}">${formatTimer(room.worldTimer)} / ${formatTimer(room.worldTimerMax)}</span>
          </div>
          <div class="bar-bg" style="margin-bottom:8px;">
            <div class="bar-fill" style="width:${timerPct}%;background:${timerColor};"></div>
            <span class="bar-text">${formatTimer(room.worldTimer)}</span>
          </div>
          <div class="stat-row"><span class="stat-label">Loot en monde</span>
            <span class="stat-value yellow">${room.lootItems}</span>
          </div>
        </div>

        <div>
          <div class="stat-row"><span class="stat-label">Ennemis vivants</span>
            <span class="stat-value" style="color:${aliveColor}">${room.enemiesAlive} / ${room.maxEnemies}</span>
          </div>
          <div class="bar-bg" style="margin-bottom:8px;">
            <div class="bar-fill" style="width:${enemPct}%;background:linear-gradient(90deg,#4caf50,#f44336);"></div>
            <span class="bar-text">${room.enemiesAlive} vivants ¬∑ ${room.enemiesDead} morts</span>
          </div>
          <div class="stat-row"><span class="stat-label">Total entit√©s</span>
            <span class="stat-value">${room.enemiesTotal}</span>
          </div>
        </div>

      </div>`;
    section.appendChild(card);
  }

  // ‚îÄ‚îÄ Players table (all rooms) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const totalPlayers = rooms.reduce((s, r) => s + r.players, 0);
  document.getElementById('playersCount').textContent = totalPlayers + ' connect√©' + (totalPlayers !== 1 ? 's' : '');
  const tbody = document.getElementById('playersBody');
  tbody.innerHTML = '';
  for (const room of rooms) {
    for (const p of room.playerList) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="color:#888">${esc(room.room)}</td><td>${p.id}</td><td>${esc(p.name)}</td><td>${p.x}</td><td>${p.y}</td><td>${p.hp}</td><td>${p.state}</td>`;
      tbody.appendChild(tr);
    }
  }
  if (totalPlayers === 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="7" style="color:#444;text-align:center;padding:8px">Aucun joueur connect√©</td>`;
    tbody.appendChild(tr);
  }
}

function esc(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function drawGraph(canvasId, data, color, fixedMax) {
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;

  canvas.width = canvas.offsetWidth * dpr;
  canvas.height = canvas.offsetHeight * dpr;
  ctx.scale(dpr, dpr);

  const w = canvas.offsetWidth;
  const h = canvas.offsetHeight;

  ctx.clearRect(0, 0, w, h);

  const max = fixedMax || Math.max(1, ...data);
  const step = w / (data.length - 1);

  // Fill
  ctx.beginPath();
  ctx.moveTo(0, h);
  for (let i = 0; i < data.length; i++) {
    const x = i * step;
    const y = h - (data[i] / max) * (h - 4);
    ctx.lineTo(x, y);
  }
  ctx.lineTo(w, h);
  ctx.closePath();
  ctx.fillStyle = color + '18';
  ctx.fill();

  // Line
  ctx.beginPath();
  for (let i = 0; i < data.length; i++) {
    const x = i * step;
    const y = h - (data[i] / max) * (h - 4);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.strokeStyle = color;
  ctx.lineWidth = 1.5;
  ctx.stroke();

  // Current value
  const last = data[data.length - 1];
  ctx.fillStyle = '#fff';
  ctx.font = '11px Courier New';
  ctx.fillText(last.toFixed(1), 4, 12);
}
</script>

</body>
</html>
